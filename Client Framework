repeat
	wait()
until game.Players.LocalPlayer.Character

local HapticService = game:GetService("HapticService")
local UIS = game:GetService("UserInputService")

local plr 			= game.Players.LocalPlayer
local char 			= plr.Character or plr.CharacterAdded:Wait()

local mouse 		= plr:GetMouse()
local cam 			= workspace.CurrentCamera

local User 			= game:GetService("UserInputService")
local CAS 			= game:GetService("ContextActionService")
local Run 			= game:GetService("RunService")
local TS 			= game:GetService('TweenService')
local Debris 		= game:GetService("Debris")


local RS 			= game.ReplicatedStorage
local Game_Workspace = workspace:WaitForChild("Game_WorkSpace")
local Engine 		= RS:WaitForChild("Engine")
local Evt 			= Engine:WaitForChild("Events")
local Mods 			= Engine:WaitForChild("Modules")
local HUDs 			= Engine:WaitForChild("HUD")
local ArmModel 		= Engine:WaitForChild("ArmModel")
local GunModels 	= Engine:WaitForChild("GunModels")
local AttModels 	= Engine:WaitForChild("AttModels")
local AttModules  	= Engine:WaitForChild("AttModules")

local gameRules		= require(Engine:WaitForChild("GameRules"):WaitForChild("Config"))
local SpringMod 	= require(Mods:WaitForChild("Spring"))
local HitMod 		= require(Mods:WaitForChild("Hitmarker"))
local Thread 		= require(Mods:WaitForChild("Thread"))
local Ultil			= require(Mods:WaitForChild("Utilities"))

local Game_Client 	= char:WaitForChild("Client")

local PlayerState = {
	shooting = false,
	reloading = false,
	meleeing = false,
	aimming = false,
	running = false,
	runKeyDown = false,
	holdBreath = false,
	AnimDebounce = false,
	CancelReload = false,
	JumpDelay = false,
	canDrop = false,
	canPump = false,
	canShoot = true,
	CookGrenade = false,
	ToolEquip = false,
	GRDebounce = false,
	CheckingMag = false,
	SafeMode = false,
	inPumpAnim = false,
	GrenadeThrowing = false,
	mouse1down = false,
	MissilesReloading = false,
	falling = false,
	Crouched = false,
	Sliding = false,
	Diving = false,
	Proned = false,
	Steady = false,
	CanLean = true,
	ChangeStance = true,
	NVGActive = false,
	LaserActive = false,
	IRmode = false,
	TorchActive = false,
	IsUnderLauncher = false,
	Spawned = false,
	Sentado = false,
	Swimming = false,
	stimActive = false,
	droneSpawned = false,
	IsReviving = false,
	HoldingBleedout = false,
	StanceButtonHeld = false,
	StanceButtonTime = 0,

	BipodDeployed = false,
	BipodSurfaceContact = false,
	BipodPosition = nil,
	BipodNormal = nil,
	
	PlayerData = nil,
	ClassData = nil,
	
	NVGLight = nil
}

local BipodMods = {
	SpreadReduction = 0.3,
	RecoilReduction = 0.4,
	MaxDistance = 3,
}

local Ammo
local UnderBarrelAmmo = 1
local StoredUnderBarrelAmmo = 4
local StoredAmmo

local WeaponInHand, GreModel, WeaponTool, WeaponData, GreAnimData, AnimData, PreviousTool, RepValues, ArchetypeData
local ViewModel, AnimPart, LArm, RArm, LArmWeld, RArmWeld, GunWeld, GreWeld
local SightData, BarrelData, UnderBarrelData, OtherData, AmmoData, MagData, MuzzleData, StockData, HammerData, BoltData
local generateBullet = 1
local BSpread
local RecoilPower
local LastSpreadUpdate = time()
local SKP_01 = Evt.AcessId:InvokeServer(plr.UserId)

local CrosshairPos = {
	up = UDim2.new(),
	down = UDim2.new(),
	left = UDim2.new(),
	right = UDim2.new()
}

local charspeed = 0
local GunStance = 0
local AimPartMode = 1

local AttTable = {
	AmmoAtt = nil,
	BarrelAtt = nil,
	MagAtt = nil,
	MuzzleAtt = nil,
	StockAtt = nil,
	OtherAtt = nil,
	SightAtt = nil,
	UnderBarrelAtt = nil,
}

local CurAimpart = nil
local Sens = 50
local xRun = 0
local zRun = 0
local activeDroneType = nil
local ReviveTarget = nil
local KnockedUI = nil
local Pointer = nil

local ModTable = {

	camRecoilMod 	= {
		RecoilTilt 	= 1,
		RecoilUp 	= 1,
		RecoilLeft 	= 1,
		RecoilRight = 1
	}

	,gunRecoilMod	= {
		RecoilUp 	= 1,
		RecoilTilt 	= 1,
		RecoilLeft 	= 1,
		RecoilRight = 1
	}

	,ZoomValue 		   = 70
	,Zoom2Value 	   = 70
	,AimRM 			   = 1
	,SpreadRM 		   = 1
	,DamageMod 		   = 1
	,minDamageMod 	   = 1
	,FallOfRangeMod	   = 1
	,FallOfDamageMod   = 1


	,MinRecoilPower 			= 1
	,MaxRecoilPower 			= 1
	,RecoilPowerStepAmount 		= 1

	,MinSpread 					= 1
	,MaxSpread 					= 1					
	,AimInaccuracyStepAmount 	= 1
	,AimInaccuracyDecrease 		= 1
	,WalkMult 					= 1
	,adsTime 					= 1		
	,MuzzleVelocity 			= 1

	,Mobility 			        = 1
	,Handling 			        = 1
	,AimSpeed 			        = 1

	,ReloadSpeed 			        = 1
	,BoltSpeed 			        = 1
	,MagSize 			        = nil
}  

local SightMarkPos = {
	Sight1X = 0.5,
	Sight1Y = 0.5,
	Sight2X = 0.5,
	Sight2Y = 0.5
}

game.StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Backpack, false)

local maincf 		= CFrame.new() --weapon offset of camera
local guncf  		= CFrame.new() --weapon offset of camera
local grecf  		= CFrame.new() --weapon offset of camera
local lapcf  		= CFrame.new() --weapon offset of camera

local larmcf 		= CFrame.new() --left arm offset of weapon
local rarmcf 		= CFrame.new() --right arm offset of weapon

local gunbobcf		= CFrame.new()
local recoilcf 		= CFrame.new()
local aimcf 		= CFrame.new()
local AimTween 		= TweenInfo.new(
	0.4,
	Enum.EasingStyle.Linear,
	Enum.EasingDirection.InOut,
	0,
	false,
	0
)

local BipodTable = {
	IsBipod = false,
	BipodActive = false,
	BipodLocked = false,
	LastSurfaceCheck = 0,
	SurfaceCheckInterval = 0.1
}

local Ignore_Model = {cam,char,Game_Workspace.Client,Game_Workspace.Server}

local ModStorageFolder 	= plr.PlayerGui:FindFirstChild('ModStorage') or Instance.new('Folder')
ModStorageFolder.Parent = plr.PlayerGui
ModStorageFolder.Name 	= 'ModStorage'

function RAND(Min, Max, Accuracy)
	local Inverse = 1 / (Accuracy or 1)
	return (math.random(Min * Inverse, Max * Inverse) / Inverse)
end

SE_GUI = HUDs:WaitForChild("StatusUI"):Clone()
SE_GUI.Parent = plr.PlayerGui 
HMGUI = HUDs.Hitmarker:Clone()
HMGUI.Parent = plr.PlayerGui
ScopeGui = HUDs:WaitForChild("Scope"):Clone()
ScopeGui.Parent = plr.PlayerGui 
BorderGui = HUDs:WaitForChild("Border"):Clone()
BorderGui.Parent = plr.PlayerGui 

local BloodScreen 		= TS:Create(SE_GUI.Efeitos.Health, TweenInfo.new(1,Enum.EasingStyle.Circular,Enum.EasingDirection.InOut,-1,true), {Size =  UDim2.new(1.2,0,1.4,0)})
local BloodScreenLowHP 	= TS:Create(SE_GUI.Efeitos.LowHealth, TweenInfo.new(1,Enum.EasingStyle.Circular,Enum.EasingDirection.InOut,-1,true), {Size =  UDim2.new(1.2,0,1.4,0)})

local Crosshair = SE_GUI.Crosshair
local Scope = ScopeGui.Scope

local RecoilSpring = SpringMod.new(Vector3.new())
RecoilSpring.d = .1
RecoilSpring.s = 20

local cameraspring = SpringMod.new(Vector3.new())
cameraspring.d = 0.9
cameraspring.s = 12

local SwaySpring = SpringMod.new(Vector3.new())
SwaySpring.d = 2
SwaySpring.s = 15


local Stance = Evt.Stance
local Stances = 0
local Virar = 0
local CameraX = 0
local CameraY = 0

local reticle		= nil
local reticle2		= nil
local CurAimpart 	= nil
local Grenades      = 2
local LaserDist 	= 0

local ParticlePlatform = RS.Rain:Clone()
ParticlePlatform.Parent = game.Workspace
ParticlePlatform.Name = plr.Name.."_Particles"
ParticlePlatform.Position = char.Head.Position + Vector3.new(0,22,0)

local CharacterSpeed, CharacterDistance = 0, 0

local lastGrain = 0
local Grains = {
	460199742,
	460199916,
	460200108,
	460200265,
	460200379,
	460200555,
	460107714,
	460107818,
	460107958,
	460108053,
	460108179,
	460108373
}

--// Char Parts
local Humanoid = char:WaitForChild('Humanoid')
local Head = char:WaitForChild('Head')
local Torso = char:WaitForChild('UpperTorso')
local HumanoidRootPart = char:WaitForChild('HumanoidRootPart')
local RootJoint = char.LowerTorso:WaitForChild('Root')
local Neck = Head:WaitForChild('Neck')
local Right_Shoulder = char.RightUpperArm:WaitForChild('RightShoulder')
local Left_Shoulder = char.LeftUpperArm:WaitForChild('LeftShoulder')
local Right_Hip = char.RightUpperLeg:WaitForChild('RightHip')
local Left_Hip = char.LeftUpperLeg:WaitForChild('LeftHip')

local YOffset = Neck.C0.Y
local WaistYOffset = Neck.C0.Y
local CFNew, CFAng = CFrame.new, CFrame.Angles
local Asin = math.asin
local TweenService = game:GetService("TweenService")

local HM = HUDs.Hitmarker

local WeaponNearZ = CFrame.new();
local PositionOffset = CFrame.new();

local virarCFrame = CFrame.Angles(0,0,0);
local cameraOffset = CFrame.Angles(0,0,0);
local activeDroneType = nil
local ReviveTarget = nil
local KnockedUI = nil

local lastMedicUpdate = 0
local MEDIC_UPDATE_INTERVAL = 0.5
local downedBillboards = {}

User.MouseIconEnabled 	= true
plr.CameraMode 			= Enum.CameraMode.Classic

if gameRules.TeamTags then
	local tag = Engine.Essential.TeamTag:Clone()
	tag.Parent = char
	tag.Disabled = false
end

local ShellFolder = Instance.new("Folder",Game_Workspace)
ShellFolder.Name = "Casings"
local Limit = gameRules.ShellLimit
local PhysService = game:GetService("PhysicsService")

function CreateShell(Shell,Origin)
	Evt.Shell:FireServer(Shell,Origin.WorldCFrame,WeaponData.EjectionOverride)
end

local ConsecutiveShotCount = 0
local LastShotLoud = false

local WalkMod = 0

task.spawn(function()
	while task.wait(0.1) do
		if char and Game_Client then
			local currentSuppressTime = Game_Client:GetAttribute("SuppressTime") or 0
			local currentExSuppressTime = Game_Client:GetAttribute("ExplosiveSuppressTime") or 0
			if currentSuppressTime > 0 then
				Game_Client:SetAttribute("SuppressTime", math.max(0, currentSuppressTime - 0.1))
			end
			if currentExSuppressTime > 0 then
				Game_Client:SetAttribute("ExplosiveSuppressTime", math.max(0, currentExSuppressTime - 0.1))
			end
		end
	end
end)

function SetWalkSpeed(Speed)
	if RS.MapStatus.Value == "InRound" or RS.MapStatus.Value == "EndRound" then
	if gameRules.WeaponWeight and WeaponInHand and ArchetypeData and ArchetypeData.WeaponWeight then
		Speed = Speed * WeaponData.Mobility * ModTable.Mobility
		if Speed - WalkMod < 1 then
			char:WaitForChild("Humanoid").WalkSpeed = 1
		else
			char:WaitForChild("Humanoid").WalkSpeed = Speed - WalkMod
		end
	else
		char:WaitForChild("Humanoid").WalkSpeed = Speed
	end
	else
		char:WaitForChild("Humanoid").WalkSpeed = 0
	end
end

function CalcWalkSpeed(Speed)
	local S = 0
	if gameRules.WeaponWeight and WeaponInHand and ArchetypeData.WeaponWeight then
		Speed = Speed * WeaponData.Mobility * ModTable.Mobility
		if Speed - WalkMod < 1 then
			S = 1
		else
			S = Speed - ArchetypeData.WeaponWeight - WalkMod
		end
	else
		S = Speed
	end
	return S
end

Evt.Shell.OnClientEvent:Connect(function(Shell,Origin,Override)
	local Distance = (char.UpperTorso.Position - Origin.Position).Magnitude
	local shellFolder
	if Engine.AmmoModels:FindFirstChild(Shell) then
		shellFolder = Engine.AmmoModels:FindFirstChild(Shell)
	else
		shellFolder = Engine.AmmoModels.Default
	end
	local shellStats = require(shellFolder.EjectionForce)

	if Distance < 100 then
		local NewShell = shellFolder.Casing:Clone()
		NewShell.Parent = ShellFolder
		NewShell.Anchored = false
		NewShell.CanCollide = true
		NewShell.CFrame = Origin * CFrame.Angles(0,math.rad(0),0)	
		NewShell.Name = Shell.."_Casing"
		NewShell.CastShadow = false
		NewShell.CustomPhysicalProperties = shellStats.PhysProperties

		NewShell.CollisionGroup = "Casings"
		local Att = Instance.new("Attachment",NewShell)
		Att.Position = shellStats.ForcePoint
		local ShellForce = Instance.new("VectorForce",NewShell)
		ShellForce.Visible = false

		if Override then
			ShellForce.Force = Override
		else
			ShellForce.Force = shellStats.CalculateForce()
		end

		ShellForce.Attachment0 = Att
		Debris:AddItem(ShellForce,0.01)

		if #ShellFolder:GetChildren() > Limit then
			ShellFolder:GetChildren()[math.random(#ShellFolder:GetChildren()/2,#ShellFolder:GetChildren())]:Destroy()
		end

		if gameRules.ShellDespawn > 0 then Debris:AddItem(NewShell,gameRules.ShellDespawn) end

		wait(0.25)
		if NewShell and NewShell:FindFirstChild("Drop") then
			local NewSound = NewShell.Drop:Clone()
			NewSound.Parent = NewShell
			NewSound.PlaybackSpeed = math.random(30,50)/40
			NewSound:Play()
			NewSound.PlayOnRemove = true
			NewSound:Destroy()
			Debris:AddItem(NewSound,2)
		end
	end
end)

local lastFireTime = 0
local FIRE_COOLDOWN = 0.05

local lastLightingUpdate = 0
local LIGHTING_UPDATE_INTERVAL = 1

local lastSwapTime = 0
local swapUIActive = false

function handleAction(actionName, inputState, inputObject)
	if PreviousTool and PlayerState.canDrop and actionName == "" and inputState == Enum.UserInputState.Begin and gameRules.WeaponDropping then
		Evt.DropWeapon:FireServer(PreviousTool,require(PreviousTool.Settings))
		PlayerState.canDrop = false
	end
	if actionName == "Fire" and inputState == Enum.UserInputState.Begin then
		if tick() - lastFireTime < FIRE_COOLDOWN then
			return
		end
		lastFireTime = tick()

		if not PlayerState.pumpAnim and not PlayerState.reloading and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and (PlayerState.AnimDebounce or (not PlayerState.AnimDebounce and PlayerState.runKeyDown)) then
			if PlayerState.runKeyDown then
				PlayerState.runKeyDown = false
				Stand()
				if WeaponData and ArchetypeData and not PlayerState.aimming then
					UpdateCrossHair("DeScope")
				end
				if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and WeaponData and ArchetypeData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
					GunStance = 0
					Evt.GunStance:FireServer(GunStance,AnimData)
					IdleAnim()
				end
				PlayerState.CanLean = true
			end

			if WeaponData.WeaponType ~= "Rocket Launcher" and WeaponData.Type ~= "Binoculars" then
				Shoot()
			else
				if not PlayerState.aimming then
					if WeaponData and ArchetypeData and WeaponData.canAim and not PlayerState.pumpAnim and not PlayerState.CheckingMag then
						if PlayerState.runKeyDown then
							PlayerState.runKeyDown = false
							Stand()

							if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and ArchetypeData and WeaponData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
								GunStance = 0
								Evt.GunStance:FireServer(GunStance,AnimData)
								IdleAnim()
							end
						end
						PlayerState.aimming = true
						ADS(PlayerState.aimming)
						WalkMod = 5
						IdleAnim()
					end
					task.wait(ArchetypeData.adsTime*ModTable.AimSpeed/4)
					Shoot()
					task.wait(ArchetypeData.adsTime*ModTable.AimSpeed/4)
					if WeaponData and ArchetypeData and WeaponData.canAim and GunStance > -2 and not PlayerState.runKeyDown and not PlayerState.CheckingMag then
						PlayerState.aimming = false
						ADS(PlayerState.aimming)
						WalkMod = 0
						if not PlayerState.reloading and not PlayerState.pumpAnim then
							IdleAnim()
						end
					end
				else
					Shoot()
				end
			end
		end

	elseif actionName == "Fire" and inputState == Enum.UserInputState.End then
		PlayerState.mouse1down = false
		PlayerState.canShoot = true
		ConsecutiveShotCount = 0
		LastShotLoud = false
	end

	if actionName == "Melee" and inputState == Enum.UserInputState.Begin then
		if PlayerState.runKeyDown then
			PlayerState.runKeyDown = false
			Stand()

			if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and ArchetypeData and WeaponData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
				GunStance = 0
				Evt.GunStance:FireServer(GunStance,AnimData)
				IdleAnim()
			end
		end
		if PlayerState.shooting then
			PlayerState.mouse1down = false
			PlayerState.CookGrenade = false
			PlayerState.canShoot = true
		end
		if PlayerState.aimming then
			PlayerState.aimming = false
			ADS(PlayerState.aimming)
		end
		PlayerState.meleeing = true
		meleeAttack()
		RunCheck()
		PlayerState.meleeing = false
	end

	if actionName == "Grenade" and inputState == Enum.UserInputState.Begin and PlayerState.AnimDebounce and not PlayerState.pumpAnim and not PlayerState.aimming and not PlayerState.runKeyDown and not PlayerState.reloading and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and Grenades > 0 then
		PlayerState.CookGrenade = true
		PlayerState.canShoot = false
		GrenadeReady()

	elseif actionName == "Grenade" and inputState == Enum.UserInputState.End and PlayerState.AnimDebounce and not PlayerState.pumpAnim and not PlayerState.aimming and not PlayerState.runKeyDown and not PlayerState.reloading and PlayerState.GrenadeThrowing and not PlayerState.meleeing then
		PlayerState.mouse1down = false
		PlayerState.CookGrenade = false
		PlayerState.canShoot = true
		Grenades -= 1
		UpdateGui()
	end

	if actionName == "CycleFiremode" and inputState == Enum.UserInputState.Begin and WeaponData and WeaponData.FireModes.ChangeFiremode and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and PlayerState.AnimDebounce then
		Firemode()
	end

	if actionName == "Reload" and inputState == Enum.UserInputState.Begin and not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and PlayerState.AnimDebounce then
		if PlayerState.NVGActive then
			if WeaponData and ArchetypeData and GunStance > -2 and not PlayerState.runKeyDown and not PlayerState.CheckingMag then
				PlayerState.aimming = false
				ADS(PlayerState.aimming)
				WalkMod = 0
				if not PlayerState.reloading and not PlayerState.pumpAnim then
					IdleAnim()
				end
			end
		end
		Reload()
	end

	if actionName == "Reload" and inputState == Enum.UserInputState.Begin and PlayerState.reloading and not PlayerState.pumpAnim and WeaponData.ShellInsert and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and PlayerState.AnimDebounce then
		PlayerState.CancelReload = true
	end

	if actionName == "Grenade Launcher" and inputState == Enum.UserInputState.Begin and not PlayerState.shooting and PlayerState.IsUnderLauncher == false and not PlayerState.reloading and UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
		PlayerState.IsUnderLauncher = true
		if PlayerState.aimming then
			PlayerState.aimming = false
			ADS(PlayerState.aimming)
		end

		IdleAnim()
		UpdateGui()
	elseif actionName == "Grenade Launcher" and inputState == Enum.UserInputState.Begin and not PlayerState.shooting and PlayerState.IsUnderLauncher == true and not PlayerState.reloading and UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
		PlayerState.IsUnderLauncher = false

		IdleAnim()
		UpdateGui()
	elseif actionName == "Grenade Launcher" and inputState == Enum.UserInputState.Begin and not PlayerState.shooting and WeaponData and WeaponData.Type == "Drone" then
		reenterDroneControl()
	end

	if actionName == "HoldCrouch" and inputState == Enum.UserInputState.Begin then
		if PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.Crouched == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not Game_Client:GetAttribute("Collapsed") then
			if PlayerState.runKeyDown then
				PlayerState.Crouched = true
				PlayerState.Proned = false
				Stances = 1
				CameraY = -1.5
				Slide()
			else
				PlayerState.Crouched = true
				PlayerState.Proned = false
				Stances = 1
				CameraY = -1.5
				Crouch()
			end
		elseif PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.Crouched == true and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not PlayerState.runKeyDown and not Game_Client:GetAttribute("Collapsed") then
			PlayerState.CanLean = true
			PlayerState.Crouched = false
			Stances = 0
			CameraY = 0
			Stand()
		end
	end

	if actionName == "LeanLeft" and inputState == Enum.UserInputState.Begin and Stances ~= 2 and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.runKeyDown and PlayerState.CanLean and not Game_Client:GetAttribute("Collapsed") then
		Virar = -1
		CameraX = -0.8
		Lean()
	elseif actionName == "LeanLeft" and inputState == Enum.UserInputState.End and Stances ~= 2 and PlayerState.ChangeStance and not PlayerState.Swimming and not Game_Client:GetAttribute("Collapsed") then
		Virar = 0
		CameraX = 0
		Lean()
	end

	if actionName == "LeanRight" and inputState == Enum.UserInputState.Begin and Stances ~= 2 and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.runKeyDown and PlayerState.CanLean and not Game_Client:GetAttribute("Collapsed") then
		Virar = 1
		CameraX = 0.8
		Lean()
	elseif actionName == "LeanRight" and inputState == Enum.UserInputState.End and Stances ~= 2 and PlayerState.ChangeStance and not PlayerState.Swimming and not Game_Client:GetAttribute("Collapsed") then
		Virar = 0
		CameraX = 0
		Lean()
	end

	if actionName == "Bipod" and inputState == Enum.UserInputState.Begin and PlayerState.AnimDebounce and not PlayerState.shooting and BipodTable.IsBipod and not PlayerState.reloading and UnderBarrelData then
		if not BipodTable.BipodActive then
			-- Try to deploy
			local hasContact, pos, normal = CheckBipodSurface()
			if hasContact or PlayerState.Proned then
				PlayerState.BipodSurfaceContact = hasContact
				PlayerState.BipodPosition = pos
				PlayerState.BipodNormal = normal
				DeployBipod()
			end
		else
			-- Retract
			RetractBipod()
		end
	end

	if actionName == "Prone" and inputState == Enum.UserInputState.Begin and PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not Game_Client:GetAttribute("Collapsed") and PlayerState.Proned == false then
		PlayerState.CanLean = false
		if PlayerState.runKeyDown then
			PlayerState.Crouched = false
			PlayerState.Proned = true
			Stances = 2
			CameraY = -3.25
			DolphinDive()
		else
			PlayerState.Crouched = false
			PlayerState.Proned = true
			Stances = 2
			CameraY = -3.25
			Prone()
		end

	elseif actionName == "Prone" and inputState == Enum.UserInputState.Begin and PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not PlayerState.runKeyDown and not Game_Client:GetAttribute("Collapsed") and PlayerState.Proned == true then
		PlayerState.Proned = false
		Stances = 0
		CameraY = 0
		Stand()
		PlayerState.CanLean = true
	end
	--(hold B for prone, tap for crouch)
	if actionName == "ControllerStance" then
		if inputState == Enum.UserInputState.Begin then
			PlayerState.StanceButtonHeld = true
			PlayerState.StanceButtonTime = tick()

			task.spawn(function()
				task.wait(0.3)
				if PlayerState.StanceButtonHeld and (tick() - PlayerState.StanceButtonTime) >= 0.3 then
					if PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not PlayerState.runKeyDown and not Game_Client:GetAttribute("Collapsed") and not PlayerState.Proned then
						PlayerState.Proned = true
						PlayerState.Crouched = false
						Stances = 2
						CameraY = -3.25
						Prone()
						PlayerState.CanLean = false
					elseif PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not PlayerState.runKeyDown and not Game_Client:GetAttribute("Collapsed") and PlayerState.Proned then
						PlayerState.Proned = false
						Stances = 0
						CameraY = 0
						Stand()
						PlayerState.CanLean = true
					end
				end
			end)

		elseif inputState == Enum.UserInputState.End then
			local holdDuration = tick() - (PlayerState.StanceButtonTime or 0)
			PlayerState.StanceButtonHeld = false
			if holdDuration < 0.3 then
				-- Quick tap - crouch logic
				if PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.Crouched == false and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not Game_Client:GetAttribute("Collapsed") then
					if PlayerState.runKeyDown then
						PlayerState.Crouched = true
						PlayerState.Proned = false
						Stances = 1
						CameraY = -1.5
						Slide()
					else
						PlayerState.Crouched = true
						PlayerState.Proned = false
						Stances = 1
						CameraY = -1.5
						Crouch()
					end
				elseif PlayerState.Diving == false and PlayerState.Sliding == false and PlayerState.Crouched == true and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not PlayerState.runKeyDown and not Game_Client:GetAttribute("Collapsed") then
					PlayerState.CanLean = true
					PlayerState.Crouched = false
					Stances = 0
					CameraY = 0
					Stand()
				end
			end
		end
	end

	if actionName == "NVG" and inputState == Enum.UserInputState.Begin and not PlayerState.reloading and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and not PlayerState.NVGActive and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not Game_Client:GetAttribute("Collapsed") and not PlayerState.reloading and (PlayerState.AnimDebounce or (not PlayerState.AnimDebounce and PlayerState.runKeyDown)) then
		PlayerState.NVGActive = true
		NVGActivate()

	elseif actionName == "NVG" and inputState == Enum.UserInputState.Begin and not PlayerState.reloading and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and PlayerState.NVGActive and PlayerState.ChangeStance and not PlayerState.Swimming and not PlayerState.Sentado and not Game_Client:GetAttribute("Collapsed") and not PlayerState.reloading and (PlayerState.AnimDebounce or (not PlayerState.AnimDebounce and PlayerState.runKeyDown)) then
		PlayerState.NVGActive = false
		NVGUnactive()
	end

	if actionName == "SwapWeapon" and inputState == Enum.UserInputState.Begin then
		PlayerState.mouse1down = false
		local currentTool = char:FindFirstChildOfClass("Tool")
		local backpackTool = plr.Backpack:FindFirstChildOfClass("Tool")

		if backpackTool then
			Humanoid:EquipTool(backpackTool)
		elseif currentTool then
			Humanoid:UnequipTools()
		end
	end
	
	if actionName == "CycleAimpart" and inputState == Enum.UserInputState.Begin and PlayerState.aimming and not PlayerState.IsUnderLauncher and not (PlayerState.reloading and PlayerState.NVGActive) and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and (PlayerState.AnimDebounce or (not PlayerState.AnimDebounce and PlayerState.runKeyDown)) and not PlayerState.falling then
		SetAimpart()
	end

	if actionName == "ADS" and inputState == Enum.UserInputState.Begin and not PlayerState.IsUnderLauncher and not (PlayerState.reloading and PlayerState.NVGActive) and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and (PlayerState.AnimDebounce or (not PlayerState.AnimDebounce and PlayerState.runKeyDown)) and not PlayerState.falling then
		local lookingAtKnockedTeammate, targetPlayer = CheckForKnockedTeammate()

		if lookingAtKnockedTeammate and targetPlayer then
			if WeaponData and WeaponData.Type == "Stim" and WeaponData.Effect == "Health" and Ammo > 0 then
				InjectOther(targetPlayer)
			end

		elseif WeaponData and ArchetypeData and WeaponData.canAim and not PlayerState.pumpAnim and not PlayerState.CheckingMag then
			if PlayerState.runKeyDown then
				PlayerState.runKeyDown = false
				Stand()

				if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and ArchetypeData and WeaponData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
					GunStance = 0
					Evt.GunStance:FireServer(GunStance,AnimData)
					IdleAnim()
				end
			end
			PlayerState.aimming = true
			ADS(PlayerState.aimming)
			WalkMod = 5
			IdleAnim()
		end

	elseif actionName == "ADS" and inputState == Enum.UserInputState.End and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing and not PlayerState.meleeing then
		if PlayerState.IsReviving then
			PlayerState.IsReviving = false
			ReviveTarget = nil
		end

		if WeaponData and ArchetypeData and WeaponData.canAim and GunStance > -2 and not PlayerState.runKeyDown and not PlayerState.CheckingMag then
			PlayerState.aimming = false
			ADS(PlayerState.aimming)
			WalkMod = 0
			if not PlayerState.reloading and not PlayerState.pumpAnim then
				IdleAnim()
			end
		end
	end

	if actionName == "Run" and inputState == Enum.UserInputState.Begin and not PlayerState.stimActive and PlayerState.Diving == false and PlayerState.Sliding == false and not script.Parent:GetAttribute("Injured") and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and Game_Client:GetAttribute("Stamina") > 0 then


		if PlayerState.aimming and WeaponData and (((WeaponData.Sniper and not AttTable.SightAtt) or (AttTable.SightAtt and SightData.Sniper)) and (not AttTable.OtherAtt or not OtherData.Canted)) then
			PlayerState.holdBreath = true
			print("HoldingBreath")
			return
		elseif PlayerState.aimming and PlayerState.running then
			PlayerState.aimming = false
			ADS(PlayerState.aimming)
			print("Ending Aimming")
		end

		if PlayerState.running then
			PlayerState.runKeyDown = true
		end

		if PlayerState.running then
			WalkMod = 0
			PlayerState.mouse1down = false		

			Stand()
			Stances = 0
			Virar = 0
			CameraX = 0
			CameraY = 0
			Lean()

			if WeaponData and ArchetypeData then
				UpdateCrossHair("Run")
			end

			if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and WeaponData and ArchetypeData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
				GunStance = 3
				Evt.GunStance:FireServer(GunStance,AnimData)
				SprintAnim()
			end
		end

	elseif actionName == "Run" and inputState == Enum.UserInputState.End and PlayerState.Diving == false and PlayerState.Sliding == false then
		PlayerState.runKeyDown = false
		PlayerState.holdBreath = false
		Stand()
		if WeaponData and ArchetypeData and not PlayerState.aimming then
			UpdateCrossHair("DeScope")
		end
		if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.pumpAnim and WeaponData and ArchetypeData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			IdleAnim()
		end
		PlayerState.CanLean = true
	end
end



function resetMods()

	ModTable.camRecoilMod.RecoilUp 		= 1
	ModTable.camRecoilMod.RecoilLeft 	= 1
	ModTable.camRecoilMod.RecoilRight 	= 1
	ModTable.camRecoilMod.RecoilTilt 	= 1

	ModTable.gunRecoilMod.RecoilUp 		= 1
	ModTable.gunRecoilMod.RecoilTilt 	= 1
	ModTable.gunRecoilMod.RecoilLeft 	= 1
	ModTable.gunRecoilMod.RecoilRight 	= 1

	ModTable.AimRM			= 1
	ModTable.SpreadRM 		= 1
	ModTable.DamageMod 		= 1
	ModTable.minDamageMod 	= 1

	ModTable.FallOfRangeMod 		= 1
	ModTable.FallOfDamageMod 	= 1

	ModTable.MinRecoilPower 		= 1
	ModTable.MaxRecoilPower 		= 1
	ModTable.RecoilPowerStepAmount 	= 1

	ModTable.MinSpread 					= 1
	ModTable.MaxSpread 					= 1
	ModTable.AimInaccuracyStepAmount 	= 1
	ModTable.AimInaccuracyDecrease 		= 1
	ModTable.WalkMult 					= 1
	ModTable.MuzzleVelocity 			= 1

	ModTable.Handling		= 1
	ModTable.Mobility 		= 1
	ModTable.AimSpeed   	= 1

	ModTable.ReloadSpeed   	= 1
	ModTable.BoltSpeed   	= 1
	ModTable.MagSize   	    = nil
end

function setMods(ModData)

	ModTable.camRecoilMod.RecoilUp 		= ModTable.camRecoilMod.RecoilUp * ModData.camRecoil.RecoilUp
	ModTable.camRecoilMod.RecoilLeft 	= ModTable.camRecoilMod.RecoilLeft * ModData.camRecoil.RecoilLeft
	ModTable.camRecoilMod.RecoilRight 	= ModTable.camRecoilMod.RecoilRight * ModData.camRecoil.RecoilRight
	ModTable.camRecoilMod.RecoilTilt 	= ModTable.camRecoilMod.RecoilTilt * ModData.camRecoil.RecoilTilt

	ModTable.gunRecoilMod.RecoilUp 		= ModTable.gunRecoilMod.RecoilUp * ModData.gunRecoil.RecoilUp
	ModTable.gunRecoilMod.RecoilTilt 	= ModTable.gunRecoilMod.RecoilTilt * ModData.gunRecoil.RecoilTilt
	ModTable.gunRecoilMod.RecoilLeft 	= ModTable.gunRecoilMod.RecoilLeft * ModData.gunRecoil.RecoilLeft
	ModTable.gunRecoilMod.RecoilRight 	= ModTable.gunRecoilMod.RecoilRight * ModData.gunRecoil.RecoilRight

	ModTable.AimRM						= ModTable.AimRM * ModData.AimRecoilReduction
	ModTable.SpreadRM 					= ModTable.SpreadRM * ModData.AimSpreadReduction
	ModTable.DamageMod 					= ModTable.DamageMod * ModData.DamageMod
	ModTable.minDamageMod 				= ModTable.minDamageMod * ModData.minDamageMod

	ModTable.FallOfRangeMod 	     	= ModTable.FallOfRangeMod * ModData.FallOfRangeMod
	ModTable.FallOfDamageMod 	        = ModTable.FallOfDamageMod * ModData.FallOfDamageMod

	ModTable.MinRecoilPower 			= ModTable.MinRecoilPower * ModData.MinRecoilPower
	ModTable.MaxRecoilPower 			= ModTable.MaxRecoilPower * ModData.MaxRecoilPower
	ModTable.RecoilPowerStepAmount 		= ModTable.RecoilPowerStepAmount * ModData.RecoilPowerStepAmount

	ModTable.MinSpread 					= ModTable.MinSpread * ModData.MinSpread
	ModTable.MaxSpread 					= ModTable.MaxSpread * ModData.MaxSpread
	ModTable.AimInaccuracyStepAmount 	= ModTable.AimInaccuracyStepAmount * ModData.AimInaccuracyStepAmount
	ModTable.AimInaccuracyDecrease 		= ModTable.AimInaccuracyDecrease * ModData.AimInaccuracyDecrease
	ModTable.WalkMult 					= ModTable.WalkMult * ModData.WalkMult
	ModTable.MuzzleVelocity 			= ModTable.MuzzleVelocity * ModData.MuzzleVelocityMod

	ModTable.Handling		            = ModTable.Handling * ModData.Handling
	ModTable.Mobility		            = ModTable.Mobility * ModData.Mobility
	ModTable.AimSpeed		            = ModTable.AimSpeed * ModData.AimSpeed

	if ModData.ReloadSpeed then
		ModTable.ReloadSpeed                = ModTable.ReloadSpeed * ModData.ReloadSpeed
	end

	if ModData.BoltSpeed then
		ModTable.BoltSpeed                = ModTable.BoltSpeed * ModData.BoltSpeed
	end

end

function loadAttachment(weapon)
	if not weapon or not weapon:FindFirstChild("Nodes") then return; end;
	if weapon:FindFirstChild("Barrels") then
		local BarrelName = (WeaponData.BarrelAtt ~= "" and WeaponData.BarrelAtt) or "Standard Barrel"
		local selectedBarrel = weapon.Barrels:FindFirstChild(BarrelName)
		if selectedBarrel then
			-- Hide all muzzle models first
			for _, Barrel in pairs(weapon.Barrels:GetChildren()) do
				if Barrel:IsA("Folder") then
					for _, part in pairs(Barrel:GetDescendants()) do
						if part:IsA("BasePart") then
							part.Transparency = 1
							part.CanCollide = false
						end
					end
				end
			end
			selectedBarrel.Parent = weapon
			for _, part in pairs(selectedBarrel:GetChildren()) do
				if part:IsA("MeshPart") then
					if part.Name ~= "GR" then
						part.Transparency = 0
					end
					part.Parent = WeaponInHand
				end
			end
			if selectedBarrel:FindFirstChild("Nodes") then
				for i,v in pairs(selectedBarrel.Nodes:GetChildren()) do
					if WeaponInHand.Nodes:FindFirstChild(v.Name) then
						WeaponInHand.Nodes:FindFirstChild(v.Name):Destroy()
						v.Parent = WeaponInHand.Nodes
					else
						v.Parent = WeaponInHand.Nodes
					end
				end
			end
			if selectedBarrel:FindFirstChild("BarrelPos") ~= nil then
				weapon.Handle.Muzzle.WorldCFrame = selectedBarrel.BarrelPos.CFrame
			end
			if selectedBarrel:FindFirstChild("MagSize") then
				ModTable.MagSize = selectedBarrel.MagSize.Value
			end
			if WeaponData.BarrelAtt ~= "" and WeaponData.BarrelAtt ~= "Standard Barrel" and AttModules.Barrel and AttModules.Barrel[WeaponData.BarrelAtt] then
				local BarrelData = require(AttModules.Barrel[WeaponData.BarrelAtt])
				if BarrelData then
					PlayerState.Suppressor 		= BarrelData.IsSuppressor
					PlayerState.FlashHider 		= BarrelData.IsFlashHider
				end
				setMods(BarrelData)
			end
		end
	end

	if weapon:FindFirstChild("Bolts") then
		local boltName = (WeaponData.BoltAtt ~= "" and WeaponData.BoltAtt) or "Standard Bolt"
		local selectedBolt = weapon.Bolts:FindFirstChild(boltName)

		if selectedBolt then
			for _, bolt in pairs(weapon.Bolts:GetChildren()) do
				if bolt:IsA("Model") then
					for _, part in pairs(bolt:GetDescendants()) do
						if part:IsA("BasePart") then
							part.Transparency = 1
							part.CanCollide = false
						end
					end
				end
			end
			if selectedBolt:FindFirstChild("Nodes") then
				for i,v in pairs(selectedBolt.Nodes:GetChildren()) do
					if WeaponInHand.Nodes:FindFirstChild(v.Name) then
						WeaponInHand.Nodes:FindFirstChild(v.Name):Destroy()
						v.Parent = WeaponInHand.Nodes
					else
						v.Parent = WeaponInHand.Nodes
					end
				end
			end
			for _, part in pairs(selectedBolt:GetDescendants()) do
				if part:IsA("BasePart") then
					part.Transparency = 0
					part.Parent = WeaponInHand
				end
			end
			if WeaponData.BoltAtt ~= "" and WeaponData.BoltAtt ~= "Standard Bolt"  and AttModules.Bolt and AttModules.Bolt[WeaponData.BoltAtt] then
				local BoltData = require(AttModules.Bolt:FindFirstChild(WeaponData.BoltAtt))
				setMods(BoltData)
			end
		end
	end

	if weapon:FindFirstChild("Hammers") then
		local HammerName = (WeaponData.HammerAtt ~= "" and WeaponData.HammerAtt) or "Standard Hammer"
		local selectedHammer = weapon.Hammers:FindFirstChild(HammerName)

		if selectedHammer then
			for _, bolt in pairs(weapon.Hammers:GetChildren()) do
				if bolt:IsA("Model") then
					for _, part in pairs(bolt:GetDescendants()) do
						if part:IsA("BasePart") then
							part.Transparency = 1
							part.CanCollide = false
						end
					end
				end
			end

			if selectedHammer:FindFirstChild("Nodes") then
				for i,v in pairs(selectedHammer.Nodes:GetChildren()) do
					if WeaponInHand.Nodes:FindFirstChild(v.Name) then
						WeaponInHand.Nodes:FindFirstChild(v.Name):Destroy()
						v.Parent = WeaponInHand.Nodes
					else
						v.Parent = WeaponInHand.Nodes
					end
				end
			end
			for _, part in pairs(selectedHammer:GetDescendants()) do
				if part:IsA("BasePart") then
					part.Transparency = 0
					part.Parent = WeaponInHand
				end
			end
			if WeaponData.HammerAtt ~= "" and WeaponData.HammerAtt ~= "Standard Hammer" and AttModules.Hammer and AttModules.Hammer[WeaponData.HammerAtt] then
				local HammerData = require(AttModules.Hammer:FindFirstChild(WeaponData.HammerAtt))
				setMods(HammerData)
			end
		end
	end
	if weapon.Nodes:FindFirstChild("Sight") and WeaponData.SightAtt ~= "" then

		SightData =  require(AttModules.Sight[WeaponData.SightAtt])

		for index, key in pairs(weapon:GetDescendants()) do
			if key.Name == "IS" then 
				key.Transparency = 1
			end;
			if key.Name == "SI" then 
				key.Transparency = 0
			end;
			if key.Name == "ADS" or key.Name == "REG" or key.Name == "SightMark" then 
				key:Destroy()
			end;
		end

		AttTable.SightAtt = AttModels[WeaponData.SightAtt]:Clone()
		AttTable.SightAtt.Parent = weapon
		AttTable.SightAtt:SetPrimaryPartCFrame(weapon.Nodes.Sight.CFrame)
		weapon.AimPart.CFrame = AttTable.SightAtt.AimPos.CFrame
		
		if AttTable.SightAtt:FindFirstChild("AimPos2") then
			local aimpartClone = weapon.AimPart:Clone()
			aimpartClone.Parent = weapon
			aimpartClone.Name = "AimPart2" 
			aimpartClone.CFrame = AttTable.SightAtt.AimPos2.CFrame
		end

		if AttTable.SightAtt:FindFirstChild("SightMark") then
			reticle = AttTable.SightAtt.SightMark.SurfaceGui.Border.Scope	
			SightMarkPos.Sight1X = AttTable.SightAtt.SightMark.SurfaceGui.Border.Scope.Position.X.Scale
			SightMarkPos.Sight1Y = AttTable.SightAtt.SightMark.SurfaceGui.Border.Scope.Position.Y.Scale
		end
		if AttTable.SightAtt:FindFirstChild("SightMark2") then
			reticle2 = AttTable.SightAtt.SightMark2.SurfaceGui.Border.Scope	
			SightMarkPos.Sight2X = AttTable.SightAtt.SightMark2.SurfaceGui.Border.Scope.Position.X.Scale
			SightMarkPos.Sight2Y = AttTable.SightAtt.SightMark2.SurfaceGui.Border.Scope.Position.Y.Scale
		end

		if SightData.Sniper == true then
			Scope.ScopeReticle.Image = SightData.SightPicture
			Scope.ScopeReticle.Size = UDim2.new(SightData.SightPicSize,0,SightData.SightPicSize,0)
		end


		if SightData.SightZoom > 0 then
			ModTable.ZoomValue = SightData.SightZoom
		end
		if SightData.SightZoom2 > 0 then
			ModTable.Zoom2Value = SightData.SightZoom2
		end
		setMods(SightData)


		for index, key in pairs(AttTable.SightAtt:GetChildren()) do
			if not key:IsA('BasePart') then continue; end;
			if WeaponData.LidSight and weapon:FindFirstChild("Lid") and weapon:FindFirstChild("LidHinge") then
				Ultil.Weld(weapon:WaitForChild("LidHinge"), key)
			elseif WeaponData.SlideSight then
				Ultil.Weld(weapon:WaitForChild("Slide"), key)
			else
				Ultil.Weld(weapon:WaitForChild("Handle"), key )
			end
			key.Anchored = false
			key.CanCollide = false
		end
	end
	if weapon.Nodes:FindFirstChild("Muzzle") ~= nil and WeaponData.MuzzleAtt ~= "" then

		MuzzleData =  require(AttModules.Muzzle[WeaponData.MuzzleAtt])

		AttTable.MuzzleAtt = AttModels[WeaponData.MuzzleAtt]:Clone()
		AttTable.MuzzleAtt.Parent = weapon
		AttTable.MuzzleAtt:SetPrimaryPartCFrame(weapon.Nodes.Muzzle.CFrame)

		if WeaponData.Archetype == "Double Barrel" then
			local MuzzleAtt2 = AttModels[WeaponData.MuzzleAtt]:Clone()
			MuzzleAtt2.Parent = weapon
			MuzzleAtt2:SetPrimaryPartCFrame(weapon.Nodes.Muzzle2.CFrame)
			for index, key in pairs(MuzzleAtt2:GetChildren()) do
				if not key:IsA('BasePart') then 
					continue; 
				end;
				if WeaponData.Archetype == "Double Barrel" and weapon:FindFirstChild("Lid") and weapon:FindFirstChild("LidHinge") then
					Ultil.Weld(weapon:WaitForChild("LidHinge"), key)
				else
					Ultil.Weld(weapon:WaitForChild("Handle"), key )
				end
				key.Anchored = false
				key.CanCollide = false
			end
		end

		if AttTable.MuzzleAtt:FindFirstChild("BarrelPos") ~= nil then
			weapon.Handle.Muzzle.WorldCFrame = AttTable.MuzzleAtt.BarrelPos.CFrame
		end

		PlayerState.Suppressor 		= MuzzleData.IsSuppressor
		PlayerState.FlashHider 		= MuzzleData.IsFlashHider

		setMods(MuzzleData)

		for index, key in pairs(weapon:GetDescendants()) do
			if key.Name == "Muzzle" and key:IsA("BasePart") then 
				key.Transparency = 1
			end;
			if key.Name == "US" and key:IsA("BasePart") then 
				key.Transparency = 0
			end;
		end

		for index, key in pairs(AttTable.MuzzleAtt:GetChildren()) do
			if not key:IsA('BasePart') then 
				continue; 
			end;
			if WeaponData.Archetype == "Double Barrel" and weapon:FindFirstChild("Lid") and weapon:FindFirstChild("LidHinge") then
				Ultil.Weld(weapon:WaitForChild("LidHinge"), key)
			else
				Ultil.Weld(weapon:WaitForChild("Handle"), key )
			end
			key.Anchored = false
			key.CanCollide = false
		end
	end
	if weapon.Nodes:FindFirstChild("UnderBarrel") ~= nil and WeaponData.UnderBarrelAtt ~= "" then

		UnderBarrelData =  require(AttModules.UnderBarrel[WeaponData.UnderBarrelAtt])
		setMods(UnderBarrelData)
		for index, key in pairs(weapon:GetDescendants()) do
			if key.Name == "GR" or key.Name == "UB" then 
				key.Transparency = 0
			elseif key.Name == "RG" or key.Name == "BU" then
				key.Transparency = 1
			end;
		end

		if not UnderBarrelData.IsGrenadeLauncher and not UnderBarrelData.IsBipod then
			AttTable.UnderBarrelAtt = AttModels[WeaponData.UnderBarrelAtt]:Clone()
			AttTable.UnderBarrelAtt.Parent = weapon
			AttTable.UnderBarrelAtt:SetPrimaryPartCFrame(weapon.Nodes.UnderBarrel.CFrame)


			for index, key in pairs(AttTable.UnderBarrelAtt:GetChildren()) do
				if not key:IsA('BasePart') then 
					continue; 
				end;
				if WeaponData.Archetype == "Double Barrel" and weapon:FindFirstChild("Lid") and weapon:FindFirstChild("LidHinge") then
					Ultil.Weld(weapon:WaitForChild("LidHinge"), key)
				elseif WeaponData.PumpGrip and weapon:FindFirstChild("Bolt") then
					Ultil.Weld(weapon:WaitForChild("Bolt"), key)
				else
					Ultil.Weld(weapon:WaitForChild("Handle"), key )
				end
				key.Anchored = false
				key.CanCollide = false
			end
		elseif UnderBarrelData.IsBipod then
			local BipodModel = weapon:FindFirstChild("Bipod")

			if BipodModel then
				for _, bipod in pairs(weapon.Bipod:GetChildren()) do
					if bipod:IsA("Model") then
						for _, part in pairs(bipod:GetDescendants()) do
							if part:IsA("BasePart") then
								part.Transparency = 1
								part.CanCollide = false

							end
						end
					end
				end

				BipodTable.IsBipod = true
				BipodTable.BipodActive = false
				for _, part in pairs(BipodModel:GetDescendants()) do
					if part:IsA("BasePart") then
						part.Parent = WeaponInHand
						if part:IsA("MeshPart") then
							part.Transparency = 0
						end
					end
				end
			end
		end
	end

	if weapon.Nodes:FindFirstChild("Other") ~= nil and WeaponData.OtherAtt ~= "" then

		OtherData =  require(AttModules.Other[WeaponData.OtherAtt])
		AttTable.OtherAtt = AttModels[WeaponData.OtherAtt]:Clone()
		AttTable.OtherAtt.Parent = weapon
		AttTable.OtherAtt:SetPrimaryPartCFrame(weapon.Nodes.Other.CFrame)

		if OtherData and OtherData.Canted == true then
			weapon.AimPart.CFrame = AttTable.OtherAtt.AimPos.CFrame
			if OtherData.SightZoom > 0 then
				ModTable.ZoomValue = OtherData.SightZoom
			end
			if OtherData.SightZoom2 > 0 then
				ModTable.Zoom2Value = OtherData.SightZoom2
			end
		end

		setMods(OtherData)
		LaserAtt = OtherData.EnableLaser
		TorchAtt = OtherData.EnableFlashlight

		for index, key in pairs(weapon:GetDescendants()) do
			if key.Name == "GR" or key.Name == "OT" then 
				key.Transparency = 0
			elseif key.Name == "RG" or key.Name == "TO" then
				key.Transparency = 1
			end;
		end

		if OtherData.InfraRed then
			PlayerState.IREnable = true
		end

		for index, key in pairs(AttTable.OtherAtt:GetChildren()) do
			if not key:IsA('BasePart') then 
				continue; 
			end;
			if WeaponData.Archetype == "Double Barrel" and weapon:FindFirstChild("Lid") and weapon:FindFirstChild("LidHinge") then
				Ultil.Weld(weapon:WaitForChild("LidHinge"), key)
			elseif WeaponData.PumpGrip and weapon:FindFirstChild("Bolt") then
				Ultil.Weld(weapon:WaitForChild("Bolt"), key)
			else
				Ultil.Weld(weapon:WaitForChild("Handle"), key )
			end
			key.Anchored = false
			key.CanCollide = false
		end
	end
	if weapon:FindFirstChild("Mags") then
		local magName = (WeaponData.MagAtt ~= "" and WeaponData.MagAtt) or "Standard Mag"
		local selectedMag = weapon.Mags:FindFirstChild(magName)

		if selectedMag then
			for _, mag in pairs(weapon.Mags:GetChildren()) do
				if mag:IsA("Model") then
					for _, part in pairs(mag:GetDescendants()) do
						if part:IsA("BasePart") then
							part.Transparency = 1
							part.CanCollide = false
						end
					end
				end
			end
			for _, part in pairs(selectedMag:GetDescendants()) do
				if part:IsA("BasePart") then
					part.Transparency = 0
					part.Parent = WeaponInHand
				end
			end

			if selectedMag:FindFirstChild("MagSize") then
				ModTable.MagSize = selectedMag.MagSize.Value
			end
			if WeaponData.MagAtt ~= "" and WeaponData.MagAtt ~= "Standard Mag" and AttModules.Mag and AttModules.Mag[WeaponData.MagAtt] then
				local MagData = require(AttModules.Mag:FindFirstChild(WeaponData.MagAtt))
				setMods(MagData)
			end
		end
	end
	if weapon:FindFirstChild("Stocks") then
		local stockName = (WeaponData.StockAtt ~= "" and WeaponData.StockAtt) or "Standard Stock"
		local selectedStock = weapon.Stocks:FindFirstChild(stockName)

		if selectedStock then
			for _, stock in pairs(weapon.Stocks:GetChildren()) do
				if stock:IsA("Model") then
					for _, part in pairs(stock:GetDescendants()) do
						if part:IsA("BasePart") then
							part.Transparency = 1
							part.CanCollide = false
						end
					end
				end
			end
			for _, part in pairs(selectedStock:GetDescendants()) do
				if part:IsA("BasePart") then
					part.Transparency = 0
					part.Parent = WeaponInHand
				end
			end
			if WeaponData.StockAtt ~= "" and WeaponData.StockAtt ~= "Standard Stock" and AttModules.Stock and AttModules.Stock[WeaponData.StockAtt] then
				local StockData = require(AttModules.Stock:FindFirstChild(WeaponData.StockAtt))

				setMods(StockData)
			end
		end
	end
	if WeaponData.AmmoAtt == "" then 
		WeaponData.AmmoAtt = "Default"
	end
	if WeaponData.AmmoAtt ~= "" then
		AmmoData =  require(AttModules.Ammo[WeaponData.AmmoAtt])
		setMods(AmmoData)
	end
end

function SetLaser()
	if gameRules.RealisticLaser and PlayerState.IREnable then
		if not PlayerState.LaserActive and not PlayerState.IRmode then
			PlayerState.LaserActive = true
			PlayerState.IRmode 		= true

		elseif PlayerState.LaserActive and PlayerState.IRmode then
			PlayerState.IRmode 		= false
		else
			PlayerState.LaserActive = false
			PlayerState.IRmode 		= false
		end
	else
		PlayerState.LaserActive = not PlayerState.LaserActive
	end

	if PlayerState.LaserActive then
		if not Pointer then
			for index, Key in pairs(WeaponInHand:GetDescendants()) do
				if Key:IsA("BasePart") and Key.Name == "LaserPoint" then
					local LaserPointer = Instance.new('Part',Key)
					LaserPointer.Shape = 'Ball'
					LaserPointer.Size = Vector3.new(0.1, 0.1, 0.1)
					LaserPointer.CanCollide = false
					LaserPointer.Color = Key.Color
					LaserPointer.Material = Enum.Material.Neon

					local LaserSP = Instance.new('Attachment',Key)			
					local LaserEP = Instance.new('Attachment',LaserPointer)

					local Laser = Instance.new('Beam',LaserPointer)
					Laser.Transparency = NumberSequence.new(0.1)
					Laser.LightEmission = 1
					Laser.LightInfluence = 1
					Laser.Attachment0 = LaserSP
					Laser.Attachment1 = LaserEP
					Laser.Color = ColorSequence.new(Key.Color)
					Laser.FaceCamera = true
					Laser.Width0 = 0.005
					Laser.Width1 = 0.005

					if gameRules.RealisticLaser then
						Laser.Enabled = false
					end

					Pointer = LaserPointer
					break
				end
			end
		end
	else
		for index, Key in pairs(WeaponInHand:GetDescendants()) do
			if Key:IsA("BasePart") and Key.Name == "LaserPoint" then
				Key:ClearAllChildren()
				break
			end
		end
		Pointer = nil
		if gameRules.ReplicatedLaser then
			Evt.SVLaser:FireServer(nil,2,nil,false,WeaponTool)
		end
	end
	WeaponInHand.Handle.Click:play()
	UpdateGui()
end

function SetTorch()

	PlayerState.TorchActive = true

	if PlayerState.TorchActive then
		for index, Key in pairs(WeaponInHand:GetDescendants()) do
			if Key:IsA("BasePart") and Key.Name == "FlashPoint" then
				Key.Light.Enabled = true
			end
		end
	else
		for index, Key in pairs(WeaponInHand:GetDescendants()) do
			if Key:IsA("BasePart") and Key.Name == "FlashPoint" then
				Key.Light.Enabled = false
			end
		end
	end
	Evt.SVFlash:FireServer(WeaponTool,PlayerState.TorchActive)
	WeaponInHand.Handle.Click:play()
	UpdateGui()
end


function NVGToggle(Type)
	if Type == true then
		task.wait(0.1)
		TS:Create(plr.PlayerGui.NVG.Goggles,TweenInfo.new(0.15),{Position = UDim2.new(0.5,0,0.5,0)}):Play()
		TS:Create(plr.PlayerGui.NVG.Goggles,TweenInfo.new(0.15),{ImageTransparency = 0}):Play()
		task.wait(0.25)
		if PlayerState.NVGLight then
			PlayerState.NVGLight.Enabled = true
		end
		plr.PlayerGui.NVG.toggle:Play()
		TS:Create(plr.PlayerGui.NVG.Grain,TweenInfo.new(1),{ImageTransparency = 0}):Play()

		local CL = RS.SkyBoxes:FindFirstChild("NVG")
		local CLF = require(CL.Main)

		TS:Create(game.Lighting,TweenInfo.new(0.1),{Ambient = CLF.Ambient}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{Brightness = CLF.Brightness}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{ColorShift_Bottom = CLF.ColorShift_Bottom}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{ColorShift_Top = CLF.ColorShift_Top}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{EnvironmentDiffuseScale = CLF.EnvironmentDiffuseScale}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{EnvironmentSpecularScale = CLF.EnvironmentSpecularScale}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{OutdoorAmbient = CLF.OutdoorAmbient}):Play()
		TS:Create(game.Lighting,TweenInfo.new(0.1),{ShadowSoftness = CLF.ShadowSoftness}):Play()
		TS:Create(game.Lighting,TweenInfo.new(2,Enum.EasingStyle.Back),{ExposureCompensation = CLF.ExposureCompensation}):Play()

		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Density = CL.Atmosphere.Density}):Play()
		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Offset = CL.Atmosphere.Offset}):Play()
		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Color = CL.Atmosphere.Color}):Play()
		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Decay = CL.Atmosphere.Decay}):Play()
		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Glare = CL.Atmosphere.Glare}):Play()
		TS:Create(game.Lighting.Atmosphere,TweenInfo.new(0.1),{Haze = CL.Atmosphere.Haze}):Play()

		TS:Create(game.Lighting.Bloom,TweenInfo.new(0.1),{Size = CL.Bloom.Size}):Play()
		TS:Create(game.Lighting.Bloom,TweenInfo.new(0.1),{Threshold = CL.Bloom.Threshold}):Play()
		TS:Create(game.Lighting.Bloom,TweenInfo.new(0.1),{Intensity = CL.Bloom.Intensity}):Play()

		TS:Create(game.Lighting.Blur,TweenInfo.new(0.1),{Size = CL.Blur.Size}):Play()

		TS:Create(game.Lighting.ColorCorrection,TweenInfo.new(0.1),{Saturation = CL.ColorCorrection.Saturation}):Play()
		TS:Create(game.Lighting.ColorCorrection,TweenInfo.new(0.1),{Contrast = CL.ColorCorrection.Contrast}):Play()
		TS:Create(game.Lighting.ColorCorrection,TweenInfo.new(0.1),{Brightness = CL.ColorCorrection.Brightness}):Play()
		TS:Create(game.Lighting.ColorCorrection,TweenInfo.new(0.1),{TintColor = CL.ColorCorrection.TintColor}):Play()

		TS:Create(game.Lighting.DepthOfField,TweenInfo.new(0.1),{FarIntensity = CL.DepthOfField.FarIntensity}):Play()
		TS:Create(game.Lighting.DepthOfField,TweenInfo.new(0.1),{FocusDistance = CL.DepthOfField.FocusDistance}):Play()
		TS:Create(game.Lighting.DepthOfField,TweenInfo.new(0.1),{InFocusRadius = CL.DepthOfField.InFocusRadius}):Play()
		TS:Create(game.Lighting.DepthOfField,TweenInfo.new(0.1),{NearIntensity = CL.DepthOfField.NearIntensity}):Play()

		TS:Create(game.Lighting.SunRays,TweenInfo.new(0.1),{Spread = CL.SunRays.Spread}):Play()
		TS:Create(game.Lighting.SunRays,TweenInfo.new(0.1),{Intensity = CL.SunRays.Intensity}):Play()
	else
		TS:Create(plr.PlayerGui.NVG.Grain,TweenInfo.new(1),{ImageTransparency = 1}):Play()
		if PlayerState.NVGLight then
			PlayerState.NVGLight.Enabled = false
		end
		task.wait(0.25)
		TS:Create(plr.PlayerGui.NVG.Goggles,TweenInfo.new(0.15),{Position = UDim2.new(0.5,0,-0.5,0)}):Play()
		TS:Create(plr.PlayerGui.NVG.Goggles,TweenInfo.new(0.15),{ImageTransparency = 1}):Play()

	end
end

plr.PlayerGui.NVG.armsound.Played:Connect(function()
	if PlayerState.NVGActive == true then
		NVGToggle(true)
	else
		NVGToggle(false)
	end
end)

function ChainGun()
	if WeaponData.HasChain then
		if WeaponData.HasChain == true then
			if WeaponInHand:FindFirstChild("AmmoFeed1") and WeaponInHand:FindFirstChild("AmmoFeed2") and WeaponInHand:FindFirstChild("Bullets") then
				WeaponInHand.Bullets:ClearAllChildren()
				if Ammo%2 == 0 then
					for i=1,WeaponData.BulletsInChain,1 do
						if Ammo >= i then
							local BulletClone = WeaponInHand:FindFirstChild("Bullet"):Clone()
							BulletClone.Parent = WeaponInHand.Bullets
							BulletClone.CFrame = WeaponInHand.AmmoFeed1[i].WorldCFrame
							BulletClone.Name = i
							BulletClone.Transparency = 0
							BulletClone.Anchored = false
							BulletClone.CanCollide = false
							local Wld = Instance.new("WeldConstraint",BulletClone)
							Wld.Part0 = BulletClone
							Wld.Part1 = WeaponInHand:WaitForChild("Handle")
						end
					end
				else
					for i=1,WeaponData.BulletsInChain,1 do
						if Ammo >= i then
							local BulletClone = WeaponInHand:FindFirstChild("Bullet"):Clone()
							BulletClone.Parent = WeaponInHand.Bullets
							BulletClone.CFrame = WeaponInHand.AmmoFeed2[i].WorldCFrame
							BulletClone.Name = i
							BulletClone.Transparency = 0
							BulletClone.Anchored = false
							BulletClone.CanCollide = false
							local Wld = Instance.new("WeldConstraint",BulletClone)
							Wld.Part0 = BulletClone
							Wld.Part1 = WeaponInHand:WaitForChild("Handle")
						end
					end
				end
				for i=1,#WeaponInHand.Bullets:GetChildren(),1 do
					local BulletClone = WeaponInHand.Bullets[i]
					if i < #WeaponInHand.Bullets:GetChildren() then
						BulletClone.Rope1.Attachment0 = BulletClone.Chain1
						BulletClone.Rope1.Attachment1 = WeaponInHand.Bullets[i+1].Chain1
						BulletClone.Rope2.Attachment0 = BulletClone.Chain2
						BulletClone.Rope2.Attachment1 = WeaponInHand.Bullets[i+1].Chain2
					else
						BulletClone:Destroy()
					end
				end
			end
		end
	end
end


function ToggleADS(Type)
	if (((WeaponData.Sniper and not AttTable.SightAtt) or (AttTable.SightAtt and SightData.Sniper)) and (not AttTable.OtherAtt or not OtherData.Canted)) then
		if Type == "REG" then
			for _, child in pairs(WeaponInHand:GetDescendants()) do
				if (child.Name == "REG" or child.Name == "MeshPart" or child.Name == "IS")and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()

				elseif child.Name == "ADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				end
			end
		elseif Type == "ADS" then
			for _, child in pairs(WeaponInHand:GetDescendants()) do
				if (child.Name == "REG" or child.Name == "MeshPart" or child.Name == "IS") and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				elseif child.Name == "ADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()
				end
			end
		end
		if AttTable.SightAtt then
			for _, child in pairs(WeaponInHand:GetDescendants()) do
				if (child.Name == "IS") and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				end
			end
		end
	end
	if (AttTable.SightAtt) and (not AttTable.OtherAtt or not OtherData.Canted) then
		if Type == "REG" then
			for _, child in pairs(AttTable.SightAtt:GetDescendants()) do
				if (child.Name == "REG" or child.Name == "IS")and child:IsA("BasePart") and child.Name == "Glass" then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()
				elseif child.Name == "ADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				elseif child.Name == "Glass" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0.7}):Play()
				elseif child.Name == "GlassADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				end
			end
		elseif Type == "ADS" then
			for _, child in pairs(AttTable.SightAtt:GetDescendants()) do
				if (child.Name == "REG" or child.Name == "IS") and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				elseif child.Name == "ADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()
				elseif child.Name == "Glass" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
				elseif child.Name == "GlassADS" and child:IsA("BasePart") then
					TS:Create(child, TweenInfo.new(0.1), {Transparency = 0.9}):Play()
				end
			end
		end
	end
	if Type == "REG" then
		for _, child in pairs(WeaponInHand:GetDescendants()) do
			if (child.Name == "REG")and child:IsA("BasePart") then
				TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()
			elseif child.Name == "ADS" and child:IsA("BasePart") then
				TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
			end
		end
	elseif Type == "ADS" then
		for _, child in pairs(WeaponInHand:GetDescendants()) do
			if (child.Name == "REG") and child:IsA("BasePart") then
				TS:Create(child, TweenInfo.new(0.1), {Transparency = 1}):Play()
			elseif child.Name == "ADS" and child:IsA("BasePart") then
				TS:Create(child, TweenInfo.new(0.1), {Transparency = 0}):Play()
			end
		end
	end
end

function ADS(aimming)
	if WeaponData and WeaponInHand then
		if aimming then
			if PlayerState.SafeMode then
				PlayerState.SafeMode = false
				GunStance = 0
				IdleAnim()
				UpdateGui()
			end
			if ((AttTable.SightAtt) and (not OtherData or OtherData.Canted == false)) then
				if AimPartMode == 1 then
					game:GetService('UserInputService').MouseDeltaSensitivity = (ModTable.ZoomValue/100)
				else
					
					game:GetService('UserInputService').MouseDeltaSensitivity = (ModTable.Zoom2Value/100)
				end
			else
				if AimPartMode == 1 then
					game:GetService('UserInputService').MouseDeltaSensitivity = (WeaponData.Zoom/100)
				else
					game:GetService('UserInputService').MouseDeltaSensitivity = (WeaponData.Zoom2/100)
				end
			end
			WeaponInHand.Handle.AimDown:Play()
			GunStance = 2
			Evt.GunStance:FireServer(GunStance,AnimData)
			UpdateCrossHair("Scope")
			ToggleADS("ADS")
		else
			ToggleADS("REG")
			game:GetService('UserInputService').MouseDeltaSensitivity = 1
			WeaponInHand.Handle.AimUp:Play()
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			if WeaponData and ArchetypeData then
				UpdateCrossHair("DeScope")
			end
		end
	end
end

function SetAimpart()
	if PlayerState.aimming then
		if AimPartMode == 1 then
			AimPartMode = 2
			if WeaponInHand:FindFirstChild('AimPart2') then
				CurAimpart = WeaponInHand:FindFirstChild('AimPart2')
			end 
			game:GetService('UserInputService').MouseDeltaSensitivity = (ModTable.Zoom2Value/100)
		else
			AimPartMode = 1
			CurAimpart = WeaponInHand:FindFirstChild('AimPart')
			game:GetService('UserInputService').MouseDeltaSensitivity = (ModTable.ZoomValue/100)
		end
		if ((WeaponData.Sniper or AttTable.SightAtt) and (not OtherData or OtherData.Canted == false)) then
			ToggleADS("ADS")
		else
			ToggleADS("REG")
		end
	end
end

function Firemode()
	SwaySpring:accelerate(Vector3.new(-0.5, 4, 2))
	WeaponInHand.Handle.SafetyClick:Play()
	PlayerState.mouse1down = false
	
	if WeaponData.ShootType == 1 and WeaponData.FireModes.Burst == true then
		WeaponData.ShootType = 2
	elseif WeaponData.ShootType == 1 and WeaponData.FireModes.Burst == false and WeaponData.FireModes.Auto == true then
		WeaponData.ShootType = 3
	elseif WeaponData.ShootType == 2 and WeaponData.FireModes.Auto == true then
		WeaponData.ShootType = 3
	elseif WeaponData.ShootType == 2 and WeaponData.FireModes.Semi == true and WeaponData.FireModes.Auto == false then
		WeaponData.ShootType = 1
	elseif WeaponData.ShootType == 3 and WeaponData.FireModes.Semi == true then
		WeaponData.ShootType = 1
	elseif WeaponData.ShootType == 3 and WeaponData.FireModes.Semi == false and WeaponData.FireModes.Burst == true then
		WeaponData.ShootType = 2
	end
	UpdateGui()

end

function Camo(Name)
	local Camo = RS.Camos:FindFirstChild(Name)
	for i,v in pairs(WeaponInHand:GetDescendants()) do
		if v:IsA("BasePart") and v.Transparency == 0 and (v.Name ~= "Aimpart" and v.Name ~= "CentrePoint" and v.Name ~= "Handle" and v.Name ~= "LidHinge" and v.Parent.Name ~= "Nodes")  then
			if Camo then
				if (v.Name == "Bolt" and Camo.IncludeBolt.Value == true) or (v.Name == "Mag" and Camo.IncludeMag.Value == true) or (v.Name == "Muzzle" and Camo.IncludeMuzzle.Value == true) or (v.Name == "Slide" and Camo.IncludeSlide.Value == true) or (v.Name ~= "Bolt" and v.Name ~= "Mag" and v.Name ~= "Muzzle" and v.Name ~= "Slide") then
					local Left    = Camo.Texture:Clone()
					local Right   = Camo.Texture:Clone()
					local Front   = Camo.Texture:Clone()
					local Back    = Camo.Texture:Clone()
					local Top     = Camo.Texture:Clone()
					local Bottom  = Camo.Texture:Clone()

					Left.Face     = Enum.NormalId.Left
					Right.Face    = Enum.NormalId.Right
					Front.Face    = Enum.NormalId.Front
					Back.Face     = Enum.NormalId.Back
					Top.Face      = Enum.NormalId.Top
					Bottom.Face   = Enum.NormalId.Bottom

					Left.Parent   = v
					Right.Parent  = v
					Front.Parent  = v
					Back.Parent   = v
					Top.Parent    = v
					Bottom.Parent = v
				end	
			end
		end
	end
end




function setup(Tool)

	if char and char:WaitForChild("Humanoid").Health > 0 and Tool ~= nil then
		BorderGui.ImageLabel.ImageTransparency = 0.95
		PlayerState.ToolEquip = true

		if plr.Backpack:FindFirstChild("Laser Module") then
			plr.Backpack:FindFirstChild("Laser Module"):Destroy()
		end

		User.MouseIconEnabled 	= false
		plr.CameraMode 			= Enum.CameraMode.LockFirstPerson
		local ToolCheck 		= Tool
		local GunModelCheck 	= GunModels:FindFirstChild(Tool.Name)

		if not ToolCheck or not GunModelCheck then warn("Tool Or Gun Model Doesn't Exist") return; end;

		WeaponTool 		= ToolCheck
		if WeaponTool then
			PreviousTool = WeaponTool
			PlayerState.canDrop = true
		end
		User.MouseIconEnabled 	= false
		plr.CameraMode 			= Enum.CameraMode.LockFirstPerson

		if plr:FindFirstChild("PlayerData") then
			PlayerState.PlayerData = plr.PlayerData
			if PlayerState.PlayerData:FindFirstChild("Classes") then
				PlayerState.ClassData = PlayerState.PlayerData.Classes
			end
		end
		WeaponTool 		= Tool
		WeaponData 		= require(Tool:WaitForChild("Settings"))
		if WeaponData.WeaponType then
			ArchetypeData 		= require(Engine.Archetypes:WaitForChild(WeaponData.WeaponType):WaitForChild(WeaponData.Archetype))
			AimTween 		= TweenInfo.new(
				0.12*ArchetypeData.adsTime,
				Enum.EasingStyle.Linear,
				Enum.EasingDirection.InOut,
				0,
				false,
				0
			)
		end
		AnimData 		= require(Tool:WaitForChild("Animations"))
		GreAnimData     = require(Engine.GrenadeAnims:WaitForChild("Frag Grenade"))
		WeaponInHand 	= GunModels:WaitForChild(Tool.Name):Clone()
		WeaponInHand.PrimaryPart = WeaponInHand:WaitForChild("Handle")

		Evt.Equip:FireServer(Tool,1,WeaponData,AnimData)

		if WeaponTool:GetAttribute("IsLoadout") == true then
			if WeaponData.WeaponType == "Pistol" then
				local Atts = PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary
				WeaponData.SightAtt = Atts.Optic.Value
				WeaponData.BarrelAtt = Atts.Barrel.Value
				WeaponData.UnderBarrelAtt = Atts.UnderBarrel.Value
				WeaponData.OtherAtt = Atts.Other.Value
				WeaponData.AmmoAtt = Atts.Ammo.Value

				WeaponData.MagAtt = Atts.Mag.Value
				WeaponData.MuzzleAtt = Atts.Muzzle.Value
				WeaponData.StockAtt = Atts.Stock.Value
				WeaponData.BoltAtt = Atts.Bolt.Value
			else
				local Atts = PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary
				WeaponData.SightAtt = Atts.Optic.Value
				WeaponData.BarrelAtt = Atts.Barrel.Value
				WeaponData.UnderBarrelAtt = Atts.UnderBarrel.Value
				WeaponData.OtherAtt = Atts.Other.Value
				WeaponData.AmmoAtt = Atts.Ammo.Value

				WeaponData.MagAtt = Atts.Mag.Value
				WeaponData.MuzzleAtt = Atts.Muzzle.Value
				WeaponData.StockAtt = Atts.Stock.Value
				WeaponData.BoltAtt = Atts.Bolt.Value
			end
		else
			WeaponData.SightAtt = WeaponTool:GetAttribute("SightAtt")
			WeaponData.BarrelAtt = WeaponTool:GetAttribute("BarrelAtt")
			WeaponData.UnderBarrelAtt = WeaponTool:GetAttribute("UnderBarrelAtt")
			WeaponData.OtherAtt = WeaponTool:GetAttribute("OtherAtt")
			WeaponData.AmmoAtt = WeaponTool:GetAttribute("AmmoAtt")

			WeaponData.MagAtt = WeaponTool:GetAttribute("MagAtt")
			WeaponData.MuzzleAtt = WeaponTool:GetAttribute("MuzzleAtt")
			WeaponData.StockAtt = WeaponTool:GetAttribute("StockAtt")
			WeaponData.BoltAtt = WeaponTool:GetAttribute("BoltAtt")

		end

		ViewModel = ArmModel:WaitForChild("Arms"):Clone()
		ViewModel.Name = "Viewmodel"


		if char:FindFirstChild("Body Colors") ~= nil then
			local Colors = char:WaitForChild("Body Colors"):Clone()
			Colors.Parent = ViewModel
		end

		if char:FindFirstChild("Shirt") ~= nil then
			local Shirt = char:FindFirstChild("Shirt"):Clone()
			Shirt.Parent = ViewModel
		end

		WalkMod = 0


		AnimPart = Instance.new("Part",ViewModel)
		AnimPart.Size = Vector3.new(0.1,0.1,0.1)
		AnimPart.Anchored = true
		AnimPart.CanCollide = false
		AnimPart.Transparency = 1

		ViewModel.PrimaryPart = AnimPart

		LArmWeld = Instance.new("Motor6D",AnimPart)
		LArmWeld.Name = "LeftArm"
		LArmWeld.Part0 = AnimPart

		RArmWeld = Instance.new("Motor6D",AnimPart)
		RArmWeld.Name = "RightArm"
		RArmWeld.Part0 = AnimPart



		GunWeld = Instance.new("Motor6D",AnimPart)
		GunWeld.Name = "Handle"

		GreWeld = Instance.new("Motor6D",AnimPart)
		GreWeld.Name = "GreHandle"

		ViewModel.Parent = cam

		maincf = AnimData.MainCFrame
		guncf = AnimData.GunCFrame

		grecf = GreAnimData.GunCFrame
		lapcf = GreAnimData.GunCFrame

		larmcf = AnimData.LArmCFrame
		rarmcf = AnimData.RArmCFrame

		LArm = ViewModel:WaitForChild("Left Arm")
		LArmWeld.Part1 = LArm
		LArmWeld.C0 = CFrame.new()
		LArmWeld.C1 = CFrame.new(1,-1,-5) * CFrame.Angles(math.rad(0),math.rad(0),math.rad(0)):inverse()

		RArm = ViewModel:WaitForChild("Right Arm")
		RArmWeld.Part1 = RArm
		RArmWeld.C0 = CFrame.new()
		RArmWeld.C1 = CFrame.new(-1,-1,-5) * CFrame.Angles(math.rad(0),math.rad(0),math.rad(0)):inverse()
		GunWeld.Part0 = RArm
		GreWeld.Part0 = RArm

		LArm.Color = char.UpperTorso.Color
		RArm.Color = char.UpperTorso.Color

		LArm.Anchored = false
		RArm.Anchored = false

		ModTable.ZoomValue 		= WeaponData.Zoom
		ModTable.Zoom2Value 	= WeaponData.Zoom2

		if WeaponData.WeaponType == "Pistol" or WeaponData.WeaponType == "Rocket Launcher" then
			if PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary.Camo.Value ~= "None" then
				Camo(PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary.Camo.Value)
			end
		else
			if PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary.Camo.Value ~= "None" then
				Camo(PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary.Camo.Value)
			end
		end
		if WeaponData.Sniper == true and not AttTable.SightAtt then
			Scope.ScopeReticle.Image = WeaponData.SightPicture
			Scope.ScopeReticle.Size = UDim2.new(WeaponData.SightPicSize,0,WeaponData.SightPicSize,0)
		end

		CAS:BindAction("BleedOut", function(actionName, inputState, inputObj)
			if inputState == Enum.UserInputState.Begin then
				if Game_Client:GetAttribute("Knocked") then
					PlayerState.HoldingBleedout = true
					Evt.BleedOutFaster:FireServer(true)
				end
			elseif inputState == Enum.UserInputState.End then
				PlayerState.HoldingBleedout = false
				if Game_Client:GetAttribute("Knocked") then
					Evt.BleedOutFaster:FireServer(false)
				end
			end
		end, false, Enum.KeyCode.E)

		BindActions()

		if WeaponData.WeaponType and WeaponData.Type == "Gun" then
			AttModels 	= Engine:WaitForChild("AttModels"):WaitForChild(WeaponData.WeaponType)
			AttModules  	= Engine:WaitForChild("AttModules"):WaitForChild(WeaponData.WeaponType)
		end

		loadAttachment(WeaponInHand)

		zRun = 0
		xRun = 0

		if WeaponData.Type == "Gun" then
			local calculatedStepAmount = CalculateSpreadStep(WeaponData, ArchetypeData)

			BSpread = math.min((ArchetypeData.MinSpread * ModTable.MinSpread), (ArchetypeData.MaxSpread * 1.5) * ModTable.MaxSpread)
			RecoilPower = math.min(ArchetypeData.MinRecoilPower * ModTable.MinRecoilPower, ArchetypeData.MaxRecoilPower * ModTable.MaxRecoilPower)

			ArchetypeData._calculatedStepAmount = calculatedStepAmount
		end

		if ModTable.MagSize ~= nil then
			WeaponData.Ammo = ModTable.MagSize
			if WeaponTool:GetAttribute("Equipped") == false then
				WeaponData.AmmoInGun = ModTable.MagSize
				WeaponData.StoredAmmo = WeaponData.Ammo * 8
			else
				if WeaponData.AmmoInGun > ModTable.MagSize then
					WeaponData.AmmoInGun = ModTable.MagSize
				end
			end
		end

		Ammo = WeaponData.AmmoInGun
		if WeaponData.Type == "Gun" then
			StoredAmmo = WeaponData.StoredAmmo
			CurAimpart = WeaponInHand:FindFirstChild("AimPart")
		end

		if UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
			UnderBarrelAmmo = WeaponData.UBAmmoInGun
			StoredUnderBarrelAmmo = WeaponData.UBStoredAmmo
		end

		for index, Key in pairs(WeaponInHand:GetDescendants()) do
			if Key:IsA("BasePart") and Key.Name == "FlashPoint" then
				TorchAtt = true
			end
			if Key:IsA("BasePart") and Key.Name == "LaserPoint" then
				LaserAtt = true
			end
		end

		ChainGun()

		PlayerState.Spawned = true

		WeaponTool:SetAttribute("Equipped",true)

		if WeaponData.Type == "Gun" then
			WeaponInHand.Bolt.SlidePull.Played:Connect(function()
				if Ammo > 0 or PlayerState.canPump or WeaponData.Archetype == "Double Barrel" then
					CreateShell(ArchetypeData.BulletType,WeaponInHand.Handle.Chamber)
					WeaponInHand.Handle.Chamber.Smoke:Emit(math.random(10,30))
					PlayerState.canPump = false
				end
			end)
			if UnderBarrelData and UnderBarrelData.IsGrenadeLauncher and WeaponInHand.Handle:FindFirstChild("CoverBack") then
				WeaponInHand.Handle.CoverBack.Played:Connect(function()
					CreateShell("40mm",WeaponInHand.Handle.GrenadeChamber)
					WeaponInHand.Handle.GrenadeChamber.Smoke:Emit(math.random(10,20))
				end)
			elseif WeaponInHand.Handle:FindFirstChild("CoverBack") then
				WeaponInHand.Handle.CoverBack.Played:Connect(function()
					CreateShell("40mm",WeaponInHand.Handle.Chamber)
					WeaponInHand.Handle.Chamber.Smoke:Emit(math.random(10,20))
				end)
			end

		end

		WeaponInHand.Handle.Swing.Played:Connect(function()
			if WeaponData.Type ~= "Stim" and WeaponData.Type ~= "Ammo" then
				meleeCast()
			end
		end)


		SE_GUI.GunHUD.Visible = true
		if WeaponData and not PlayerState.aimming then
			UpdateCrossHair("DeScope")
		end
		
		local NVGLightSet   = Instance.new("SpotLight",AnimPart)
		NVGLightSet.Name    = "NVGLight"
		NVGLightSet.Color   = Color3.fromRGB(0, 255, 119)
		NVGLightSet.Angle   = 180
		NVGLightSet.Shadows = false
		NVGLightSet.Range   = 70
		NVGLightSet.Brightness = 20
		NVGLightSet.Enabled = PlayerState.NVGActive

		PlayerState.NVGLight = NVGLightSet

		UpdateGui()
		
		SE_GUI.GunHUD.Selection.Primary.Title.Text = PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary.Value
		SE_GUI.GunHUD.Selection.Secondary.Title.Text = PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary.Value
		SE_GUI.GunHUD.Selection.Kit.Title.Text = PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Kit.Value
		
		for index, key in pairs(WeaponInHand:GetChildren()) do
			if key:IsA('BasePart') and key.Name ~= 'Handle' then
				if key.Name ~= "Bolt" and key.Name ~= "BoltLever" and key.Name ~= 'Lid' and key.Name ~= 'Hammer' and key.Name ~= "SlideAtt" and key.Name ~= "Slide" and key.Name ~= 'Cover' and key.Name ~= 'Bipod' and key.Name ~= 'BipodLeft' and key.Name ~= 'BipodRight' and key.Name ~= 'BipodLeftHinge' and key.Name ~= 'BipodRightHinge' then
					Ultil.Weld(WeaponInHand:WaitForChild("Handle"), key)
				end
				if key.Name == "Bolt" or key.Name == "Slide" then
					Ultil.WeldComplex(WeaponInHand:WaitForChild("Handle"), key, key.Name)
				end;
				if key.Name == "SlideAtt" then
					Ultil.WeldComplex(WeaponInHand:WaitForChild("Slide"), key, key.Name)
				end;
				if key.Name == "Hammer" then
					if WeaponInHand:FindFirstChild('HammerHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("HammerHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "Lid" then
					if WeaponInHand:FindFirstChild('LidHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("LidHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "BoltLever" then
					if WeaponInHand:FindFirstChild('BoltLeverHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BoltLeverHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "Cover" then
					if WeaponInHand:FindFirstChild('CoverHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("CoverHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "Bipod" then
					if WeaponInHand:FindFirstChild('BipodHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BipodHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "BipodLeft" then
					if WeaponInHand:FindFirstChild('BipodLeftHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BipodLeftHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "BipodRight" then
					if WeaponInHand:FindFirstChild('BipodRightHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BipodRightHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "BipodLeftHinge" then
					if WeaponInHand:FindFirstChild('BipodHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BipodHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
				if key.Name == "BipodRightHinge" then
					if WeaponInHand:FindFirstChild('BipodHinge') then
						Ultil.Weld(key, WeaponInHand:WaitForChild("BipodHinge"))
					else
						Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
					end
				end
			end
		end;

		if UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
			for index, key in pairs(WeaponInHand["Grenade Launcher"]:GetDescendants()) do
				if key:IsA('BasePart') and key.Name ~= 'Handle' then

					if key.Name ~= 'Cover' then
						Ultil.Weld(WeaponInHand:WaitForChild("Handle"), key)
					end

					if key.Name == "Cover" then
						if WeaponInHand:FindFirstChild('CoverHinge') then
							Ultil.Weld(key, WeaponInHand:WaitForChild("CoverHinge"))
						else
							Ultil.Weld(key, WeaponInHand:WaitForChild("Handle"))
						end
					end
				end
			end;
		else
			if WeaponInHand:FindFirstChild("Grenade Launcher") then
				for index, key in pairs(WeaponInHand["Grenade Launcher"]:GetDescendants()) do
					if key:IsA('BasePart') then
						key.Transparency = 1
					end
				end;
			end
		end

		if WeaponData.Type == "Gun" then
			if RS.Engine.FX:FindFirstChild(WeaponData.MuzzleFlash) then
				for i,v in pairs(RS.Engine.FX[WeaponData.MuzzleFlash]:GetChildren()) do
					local vC = v:Clone()
					vC.Parent = WeaponInHand.Handle.Muzzle
				end
				Evt.SetupMuzzle:FireServer(WeaponData,"Muzzle")
			end
		end
		if UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
			for i,v in pairs(RS.Engine.FX["Grenade Launcher"]:GetChildren()) do
				local vC = v:Clone()
				vC.Parent = WeaponInHand.Handle.GrenadeMuzzle
			end
			Evt.SetupMuzzle:FireServer(WeaponData,"GrenadeMuzzle")
		end

		for L_213_forvar1, L_214_forvar2 in pairs(WeaponInHand:GetChildren()) do
			if L_214_forvar2:IsA('BasePart') then
				L_214_forvar2.Anchored = false
				L_214_forvar2.CanCollide = false
			end
		end;

		if WeaponInHand:FindFirstChild("Nodes") then
			for L_213_forvar1, L_214_forvar2 in pairs(WeaponInHand.Nodes:GetChildren()) do
				if L_214_forvar2:IsA('BasePart') then
					Ultil.Weld(WeaponInHand:WaitForChild("Handle"), L_214_forvar2)
					L_214_forvar2.Anchored = false
					L_214_forvar2.CanCollide = false
				end
			end;
		end
		
		if WeaponInHand:FindFirstChild("MenuNodes") then
			WeaponInHand.MenuNodes:Destroy()
		end
		script.Parent.EquippedGun.Value = Tool.Name

		GunWeld.Part1 = WeaponInHand:WaitForChild("Handle")
		GunWeld.C1 = guncf

		if ArchetypeData and ArchetypeData.IsLauncher and Ammo <= 0 and WeaponData.Type == "Gun" then
			for _, cPart in pairs(WeaponInHand:GetDescendants()) do
				if (cPart.Name == "Warhead" or cPart.Parent.Name == "Warhead") and cPart:IsA("BasePart") then
					cPart.Transparency = 1

				end
			end
		end

		if LaserAtt then
			SetLaser()
		end
		if TorchAtt then
			SetTorch()
		end

		WeaponInHand.Parent = ViewModel	
		if Ammo and Ammo <= 0 and WeaponData.Type == "Gun" then
			WeaponInHand.Handle.Slide.C0 = WeaponData.SlideEx:inverse()
		end
		EquipAnim()
		if WeaponData and WeaponData.Type ~= "Grenade" then
			RunCheck()
		end
	end
end

function unset()
	TS:Create(Scope.Scope, TweenInfo.new(.0,Enum.EasingStyle.Linear), {ImageTransparency = 1 }):Play()
	TS:Create(Scope.ScopeReticle, TweenInfo.new(.0,Enum.EasingStyle.Linear), {ImageTransparency = 1 }):Play()
	for i,v in pairs(Crosshair:GetDescendants()) do
		if v.ClassName == "Frame" then
			TS:Create(v, TweenInfo.new(.2,Enum.EasingStyle.Linear), {BackgroundTransparency = 1}):Play()
		elseif v.ClassName == "ImageLabel" then
			TS:Create(v, TweenInfo.new(.2,Enum.EasingStyle.Linear), {ImageTransparency = 1}):Play()
		end
	end
	PlayerState.ToolEquip = false
	Evt.Equip:FireServer(WeaponTool,2)
	CAS:UnbindAction("Fire")
	CAS:UnbindAction("ADS")
	CAS:UnbindAction("Reload")
	CAS:UnbindAction("CycleLaser")
	CAS:UnbindAction("CycleLight")
	CAS:UnbindAction("CycleFiremode")
	CAS:UnbindAction("CycleAimpart")
	CAS:UnbindAction("ZeroUp")
	CAS:UnbindAction("ZeroDown")
	CAS:UnbindAction("CheckMag")
	
	SightMarkPos = {
		Sight1X = 0.5,
		Sight1Y = 0.5,
		Sight2X = 0.5,
		Sight2Y = 0.5
	}

	PlayerState.mouse1down = false
	PlayerState.aimming = false

	TS:Create(cam,AimTween,{FieldOfView = PlayerState.PlayerData.Settings.FOV.Value}):Play()

	UnBindActions()
	
	User.MouseIconEnabled = true
	game:GetService('UserInputService').MouseDeltaSensitivity = 1
	cam.CameraType = Enum.CameraType.Custom
	plr.CameraMode = Enum.CameraMode.Classic


	if WeaponInHand then

		WeaponData.AmmoInGun = Ammo
		WeaponData.StoredAmmo = StoredAmmo

		if UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
			WeaponData.UBAmmoInGun = UnderBarrelAmmo
			WeaponData.UBStoredAmmo = StoredUnderBarrelAmmo
		end

		ViewModel:Destroy()
		ViewModel 		= nil
		WeaponInHand	= nil
		WeaponTool		= nil
		LArm 			= nil
		RArm 			= nil
		LArmWeld 		= nil
		RArmWeld 		= nil
		WeaponData 		= nil
		ArchetypeData   = nil
		AnimData		= nil

		reticle			= nil

		reticle2			= nil

		PlayerState.LaserAtt 		= false
		PlayerState.LaserActive		= false
		PlayerState.IRmode			= false
		PlayerState.TorchAtt 		= false
		PlayerState.TorchActive 	= false
		PlayerState.IsUnderLauncher = false
		LaserDist 		= 0
		Pointer 		= nil

		AttTable.AmmoAtt = nil
		AttTable.BarrelAtt = nil
		AttTable.MagAtt = nil
		AttTable.MuzzleAtt = nil
		AttTable.StockAtt = nil
		AttTable.OtherAtt = nil
		AttTable.SightAtt = nil
		AttTable.UnderBarrelAtt = nil

		UnderBarrelData = nil
		SightData = nil
		OtherData = nil
		StockData = nil
		MuzzleData = nil
		MagData = nil
		BarrelData = nil
		AmmoData = nil

		BSpread 		= nil
		RecoilPower 	= nil
		PlayerState.Suppressor 		= false
		PlayerState.FlashHider 		= false

		PlayerState.CancelReload 	= false
		PlayerState.reloading 		= false
		PlayerState.SafeMode		= false
		PlayerState.CheckingMag		= false
		PlayerState.GRDebounce 		= false
		PlayerState.CookGrenade 	= false
		GunStance 		= 0
		resetMods()
		generateBullet 	= 1
		AimPartMode 	= 1

		SE_GUI.GunHUD.Visible = false
		SE_GUI.GrenadeForce.Visible = false

		if gameRules.ReplicatedLaser then
			Evt.SVLaser:FireServer(nil,2,nil,false,WeaponTool)
		end
	end
	TS:Create(BorderGui.ImageLabel, TweenInfo.new(.2,Enum.EasingStyle.Linear), {ImageTransparency = 0.95}):Play()
end

local HalfStep = false
function HeadMovement()
	if char.Humanoid.Health > 0 and char:FindFirstChild("HumanoidRootPart") then
		local CameraDirection = char.HumanoidRootPart.CFrame:toObjectSpace(cam.CFrame).lookVector
		if Neck then
			if char.Humanoid.RigType == Enum.HumanoidRigType.R15 and char.Humanoid.Health > 0 and char.Humanoid.PlatformStand == false then
				HalfStep = not HalfStep
				local neckCFrame = CFNew(0, YOffset, 0) * CFAng(-Asin(char.UpperTorso.CFrame.lookVector.Y), -Asin(CameraDirection.X/1.15), 0) * CFAng(Asin(CameraDirection.Y), 0, 0)
				TS:Create(Neck, TweenInfo.new(.2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out, 0, false, 0), {C0 = neckCFrame}):Play()
				if HalfStep then
					Evt.HeadRot:FireServer(neckCFrame)
				end
			end
		end
	end
end

function renderCam()			
	cam.CFrame = cam.CFrame*CFrame.Angles(cameraspring.p.x,cameraspring.p.y,cameraspring.p.z)
end

function renderGunRecoil()			
	recoilcf = recoilcf*CFrame.Angles(RecoilSpring.p.x,RecoilSpring.p.y,RecoilSpring.p.z)
end

function CalculateSpreadStep(weaponData, archetypeData)
	if archetypeData.AimInaccuracyStepAmount and archetypeData.AimInaccuracyStepAmount > 0 then
		return archetypeData.AimInaccuracyStepAmount
	end
	local timeBetweenShots = 60 / weaponData.ShootRate
	local decayMultiplier = (5 / weaponData.ShootRate) * 2
	local estimatedDecay = archetypeData.AimInaccuracyDecrease * decayMultiplier

	local calculatedStep = estimatedDecay * 1.09
	local minStep = (archetypeData.MaxSpread - archetypeData.MinSpread) * 0.05
	local maxStep = (archetypeData.MaxSpread - archetypeData.MinSpread) * 0.25

	return math.clamp(calculatedStep, minStep, maxStep)
end


function Recoil()
	local vr = (math.random(ArchetypeData.camRecoil.camRecoilUp[1], ArchetypeData.camRecoil.camRecoilUp[2])/8) * ModTable.camRecoilMod.RecoilUp
	local lr = (math.random(ArchetypeData.camRecoil.camRecoilLeft[1], ArchetypeData.camRecoil.camRecoilLeft[2])/4) * ModTable.camRecoilMod.RecoilLeft
	local rr = (math.random(ArchetypeData.camRecoil.camRecoilRight[1], ArchetypeData.camRecoil.camRecoilRight[2])/4) * ModTable.camRecoilMod.RecoilRight
	local hr = (math.random(-rr, lr)/2)
	local tr = (math.random(ArchetypeData.camRecoil.camRecoilTilt[1], ArchetypeData.camRecoil.camRecoilTilt[2])) * ModTable.camRecoilMod.RecoilTilt

	local RecoilX = math.rad(vr * RAND( 1, 1, .1))
	local RecoilY = math.rad(hr * RAND(-1, 1, .1))
	local RecoilZ = math.rad(tr * RAND(-2, 1, .1))

	local gvr = (math.random(ArchetypeData.gunRecoil.gunRecoilUp[1], ArchetypeData.gunRecoil.gunRecoilUp[2]) /10) * ModTable.gunRecoilMod.RecoilUp
	local gdr = (math.random(-1,1) * math.random(ArchetypeData.gunRecoil.gunRecoilTilt[1], ArchetypeData.gunRecoil.gunRecoilTilt[2]) /10) * ModTable.gunRecoilMod.RecoilTilt
	local glr = (math.random(ArchetypeData.gunRecoil.gunRecoilLeft[1], ArchetypeData.gunRecoil.gunRecoilLeft[2])) * ModTable.gunRecoilMod.RecoilLeft
	local grr = (math.random(ArchetypeData.gunRecoil.gunRecoilRight[1], ArchetypeData.gunRecoil.gunRecoilRight[2])) * ModTable.gunRecoilMod.RecoilRight

	local ghr = (math.random(-grr, glr)/10)	

	local ARR = ArchetypeData.AimRecoilReduction * ModTable.AimRM

	cameraspring:accelerate(Vector3.new( RecoilX*1.2 , RecoilY*1.2, RecoilZ ))
	if not PlayerState.aimming then
		RecoilSpring:accelerate(Vector3.new( math.rad(gvr * RecoilPower*0.5), math.rad(ghr * RecoilPower*0.5), math.rad(gdr*0.5)))
	else
		RecoilSpring:accelerate(Vector3.new( math.rad(gvr * RecoilPower*0.5/ARR) , math.rad(ghr * RecoilPower*0.5/ARR), math.rad(gdr*0.5/ ARR)))
	end
	local pushbackCF = CFrame.new();
	if WeaponData.WeaponType == "Pistol" then
		pushbackCF = PlayerState.aimming and CFrame.new(0,-0.3*ArchetypeData.YRecoil/(ARR/4),.4*ArchetypeData.ZRecoil/(ARR/4)) * CFrame.Angles( math.rad( gvr * RecoilPower )/ARR,math.rad( ghr * RecoilPower )/ARR,math.rad( gdr * RecoilPower )/ARR) or CFrame.new(0,-.4*ArchetypeData.YRecoil,.4*ArchetypeData.ZRecoil*2) * CFrame.Angles( math.rad( gvr * RecoilPower ),math.rad( ghr * RecoilPower ),math.rad( gdr * RecoilPower ));
	else
		pushbackCF = PlayerState.aimming and CFrame.new(0,-0.1*ArchetypeData.YRecoil/(ARR/4),.6*ArchetypeData.ZRecoil/(ARR/4)) * CFrame.Angles( math.rad( gvr * RecoilPower )/ARR,math.rad( ghr * RecoilPower )/ARR,math.rad( gdr * RecoilPower )/ARR) or CFrame.new(0,-.4*ArchetypeData.YRecoil,.6*ArchetypeData.ZRecoil*2) * CFrame.Angles( math.rad( gvr * RecoilPower ),math.rad( ghr * RecoilPower ),math.rad( gdr * RecoilPower ));
	end
	recoilcf = recoilcf * pushbackCF
end

function ShakeCam(Position, Power)
	local playerPos = HumanoidRootPart.Position
	local explosionVector = Position - playerPos
	local distance = explosionVector.Magnitude

	local relativeDir = cam.CFrame:VectorToObjectSpace(explosionVector.Unit)

	local maxDistance = 100
	local distanceFalloff = math.max(0, 1 - (distance / maxDistance))

	local shakePower = Power * distanceFalloff

	if shakePower <= 0.1 then return end

	local forwardFactor = math.abs(relativeDir.Z)
	local sideFactor = math.abs(relativeDir.X)
	local verticalFactor = math.abs(relativeDir.Y)

	local vr = RAND(1, 2) * shakePower * (forwardFactor + verticalFactor)
	local hr = RAND(-1, 1) * shakePower * sideFactor
	local tr = RAND(-1, 1) * shakePower

	local ShakeX = math.rad(vr * RAND(0.8, 1.2))
	local ShakeY = math.rad(hr * RAND(0.8, 1.2))
	local ShakeZ = math.rad(tr * RAND(-1, 1))

	local gvr = RAND(1, 2) * shakePower * (forwardFactor + verticalFactor)
	local ghr = RAND(-1, 1) * shakePower * sideFactor
	local gdr = RAND(-1, 1) * shakePower

	cameraspring:accelerate(Vector3.new(ShakeX * 1.5, ShakeY * 1.5, ShakeZ))

	if WeaponInHand and not PlayerState.aimming then
		RecoilSpring:accelerate(Vector3.new(
			math.rad(gvr * 0.3), 
			math.rad(ghr * 0.3), 
			math.rad(gdr * 0.3)
			))
		local pushbackStrength = shakePower * 0.5
		recoilcf = recoilcf * CFrame.new(
			0,
			-0.05 * pushbackStrength,
			0.1 * pushbackStrength
		) * CFrame.Angles(
			math.rad(gvr * 0.2),
			math.rad(ghr * 0.2),
			math.rad(gdr * 0.2)
		)
	elseif WeaponInHand and PlayerState.aimming then
		local aimReduction = 0.4
		RecoilSpring:accelerate(Vector3.new(
			math.rad(gvr * 0.15 * aimReduction), 
			math.rad(ghr * 0.15 * aimReduction), 
			math.rad(gdr * 0.15 * aimReduction)
			))

		local pushbackStrength = shakePower * 0.3
		recoilcf = recoilcf * CFrame.new(
			0,
			-0.04 * pushbackStrength,
			0.09 * pushbackStrength
		) * CFrame.Angles(
			math.rad(gvr * 0.1 * aimReduction),
			math.rad(ghr * 0.1 * aimReduction),
			math.rad(gdr * 0.1 * aimReduction)
		)
	end

	SwaySpring:accelerate(Vector3.new(
		hr * 0.05,
		vr * 0.05,
		tr * 0.03
		))
end

function UnderBarrelRecoil()
	local vr = (math.random(2, 4))
	local lr = (math.random(1,2))
	local rr = (math.random(1,2))
	local hr = (math.random(-rr, lr)/2)
	local tr = (math.random(2, 4))

	local RecoilX = math.rad(vr * RAND( 1, 1, .1))
	local RecoilY = math.rad(hr * RAND(-1, 1, .1))
	local RecoilZ = math.rad(tr * RAND(-2, 1, .1))

	local gvr = (math.random(30, 40))
	local gdr = (math.random(-1,1) * math.random(20, 30))
	local glr = (math.random(15, 30))
	local grr = (math.random(15, 30))

	local ghr = (math.random(-grr, glr)/2)	

	local ARR = 0.5

	cameraspring:accelerate(Vector3.new( RecoilX*1.2 , RecoilY*1.2, RecoilZ ))
	if not PlayerState.aimming then
		RecoilSpring:accelerate(Vector3.new( math.rad(gvr * RecoilPower*0.5), math.rad(ghr * RecoilPower*0.5), math.rad(gdr*0.5)))
	else
		RecoilSpring:accelerate(Vector3.new( math.rad(gvr * RecoilPower*0.5/ARR) , math.rad(ghr * RecoilPower*0.5/ARR), math.rad(gdr*0.5/ ARR)))
	end
	local pushbackCF = CFrame.new();
	pushbackCF = PlayerState.aimming and CFrame.new(0,-0.2/(ARR/4),0.5/(ARR/4)) * CFrame.Angles( math.rad( gvr * RecoilPower )/ARR,math.rad( ghr * RecoilPower )/ARR,math.rad( gdr * RecoilPower )/ARR) or CFrame.new(0,-.4*ArchetypeData.YRecoil,.6*ArchetypeData.ZRecoil*2) * CFrame.Angles( math.rad( gvr * RecoilPower ),math.rad( ghr * RecoilPower ),math.rad( gdr * RecoilPower ));
	recoilcf = recoilcf * pushbackCF
end

function CheckForJet(hitPart)
	if not hitPart then
		return false, nil
	end
	if hitPart.Parent and hitPart.Parent.Name:match("'s Jet$") then
		return true, hitPart.Parent
	end
	if hitPart.Parent and hitPart.Parent.Parent and hitPart.Parent.Parent.Name:match("'s Jet$") then
		return true, hitPart.Parent.Parent
	end
	if hitPart.Parent and hitPart.Parent.Name:match("'s Drone$") then
		return true, hitPart.Parent
	end
	if hitPart.Parent and hitPart.Parent.Parent and hitPart.Parent.Parent.Name:match("'s Drone$") then
		return true, hitPart.Parent.Parent
	end
	return false, nil
end

function CheckForHumanoid(L_225_arg1)
	local L_226_ = false
	local L_227_ = nil
	if L_225_arg1 then
		if L_225_arg1.Name == "Hitbox" and L_225_arg1.Parent:FindFirstChildOfClass("Humanoid") then
			L_226_ = true
			L_227_ = L_225_arg1.Parent:FindFirstChildOfClass("Humanoid")
		elseif (L_225_arg1.Parent and L_225_arg1.Parent:FindFirstChildOfClass("Humanoid") or L_225_arg1.Parent and L_225_arg1.Parent.Parent and L_225_arg1.Parent.Parent:FindFirstChildOfClass("Humanoid")) then
			L_226_ = true
			if L_225_arg1.Parent:FindFirstChildOfClass('Humanoid') then
				L_227_ = L_225_arg1.Parent:FindFirstChildOfClass('Humanoid')
			elseif L_225_arg1.Parent.Parent:FindFirstChildOfClass('Humanoid') then
				L_227_ = L_225_arg1.Parent.Parent:FindFirstChildOfClass('Humanoid')
			end
		else
			L_226_ = false
		end	
	end
	return L_226_, L_227_
end

local IgnoreAccessoriesList = {
	"Top",
	"Helmet",
	"Up",
	"Down",
	"Face",
	"Olho",
	"Headset",
	"Numero",
	"Vest",
	"Chest",
	"UpperTorso",
	"Back",
	"Belt",
	"Leg1",
	"Leg2",
	"Arm1",
	"Arm2",
	"Limbbox"
}

local TorsoList = {
	"UpperTorso",
	"LowerTorso",
	"Torso",
	"Hitbox"
}

local LimbsList = {
	"LeftFoot",
	"LeftLowerLeg",
	"LeftUpperLeg",
	"RightFoot",
	"RightLowerLeg",
	"RightUpperLeg",
	"LeftHand",
	"LeftLowerArm",
	"LeftUpperArm",
	"RightHand",
	"RightLowerArm",
	"RightUpperArm",
	"Left Arm",
	"Right Arm",
	"Left Leg",
	"Right Leg",
}

local RicochetMaterialMaxAngles = gameRules.RicochetMaterialMaxAngles
local RicochetLoss = gameRules.RicochetLoss
local WallbangEnabled = gameRules.WallbangEnabled
local WallbangDamage = gameRules.WallbangDamage
local WallbangMaterialHardness = gameRules.WallbangMaterialHardness
local WallbangSpecialNames = gameRules.WallbangSpecialNames

function ShouldbeAddedtoIgnoreList(Part)
	if (((Part.CanCollide == false or Part.Transparency >= .9) and Part.Name ~= "Hitbox" and Part.Name ~= "Headbox") or Part.Name == "ResistantGlass" or Part.Name == "Shard" or Part.Name == "Barrier") and 
		Part.Name ~= "RightUpperLeg" and Part.Name ~= "RightLowerLeg" and Part.Name ~= "RightFoot" and 
		Part.Name ~= "LeftUpperLeg" and Part.Name ~= "LeftLowerLeg" and Part.Name ~= "LeftFoot" and 
		Part.Name ~= "RightUpperArm" and Part.Name ~= "RightLowerArm" and Part.Name ~= "RightHand" and 
		Part.Name ~= "LeftUpperArm" and Part.Name ~= "LeftLowerArm" and Part.Name ~= "LeftHand" and 
		Part.Name ~= "UpperTorso" and Part.Name ~= "LowerTorso" and Part.Name ~= "Torso" and 
		Part.Name ~= "Right Arm" and Part.Name ~= "Left Arm" and Part.Name ~= "Left Leg" and 
		Part.Name ~= "Right Leg" and Part.Name ~= "Neck" and Part.Name ~= "Head" and 
		Part.Name ~= "Groin" and Part.Name ~= "Tree_Collision" and Part.Name ~= "BulletProtection" then
		table.insert(Ignore_Model, Part)
		return true
	else 
		return false
	end
end

local raycastParams = RaycastParams.new()
raycastParams.FilterDescendantsInstances = Ignore_Model
raycastParams.FilterType = Enum.RaycastFilterType.Exclude
raycastParams.IgnoreWater = false

local HitEntities = {}

function CastRay(Bullet, Origin, isUnderBarrel, GrenadeData)
	local Hit2, Pos2, Norm2, Mat2, raycastResult2
	local raycastResult
	local BulletVector
	local WallbangRay

	local PrevPos = Origin
	local BulletPos = Bullet.Position
	local TotalDistTraveled = 0
	local recast
	local BulletStopped = false
	local WallbangParts = {}
	local Debounce = false

	local MAX_PENETRATIONS = 40
	local penetrationCount = 0

	local RicoHappened = false
	local RicoPos = Vector3.new(0,0,0)

	local BulletHitEntities = {}

	local currentArchetypeData = isUnderBarrel and GrenadeData or ArchetypeData
	local currentAmmoData
	if isUnderBarrel then
		currentAmmoData = nil
	else
		currentAmmoData = AmmoData
	end
	local maxDistance = isUnderBarrel and 7000 or (ArchetypeData.BulletRange)

	local MPosition = cam.CFrame.Position
	local MVector

	if not isUnderBarrel and WeaponData.WeaponType ~= "Rocket Launcher" and WeaponData.WeaponType ~= "Grenade Launcher" and WeaponData.WeaponType ~= "Flamethrower" then
		MPosition = cam.CFrame.Position
		MVector = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
	elseif isUnderBarrel then
		MPosition = WeaponInHand.Handle.GrenadeMuzzle.WorldPosition
		MVector = (cam.CFrame.LookVector + Vector3.new(0, math.tan(math.rad(5)), 0)).Unit * 2
	else
		MPosition = WeaponInHand.Handle.Muzzle.WorldPosition
		MVector = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
	end

	local WhizzedPlayers = {}
	local SplashedPlayers = {}

	local function GetEntityIdentifier(instance)
		local FoundHuman, Victim = CheckForHumanoid(instance)
		if FoundHuman and Victim then
			return "Humanoid_" .. tostring(Victim.Parent)
		end
		local FoundJet, EnemyJet = CheckForJet(instance)
		if FoundJet and EnemyJet then
			return "Jet_" .. tostring(EnemyJet)
		end

		return nil
	end

	while not BulletStopped do
		Run.Heartbeat:wait()
		BulletPos = Bullet.Position
		TotalDistTraveled = TotalDistTraveled + (BulletPos - PrevPos).magnitude
		if TotalDistTraveled > maxDistance then
			if not isUnderBarrel then
				if Bullet:FindFirstChild("Smoke") then
					Debris:AddItem(Bullet.Smoke,5)
					Bullet.Smoke.Parent = workspace
				end
				if Bullet:FindFirstChild("Fire") then
					Debris:AddItem(Bullet.Fire,5)
					Bullet.Fire.Parent = workspace
				end
				if Bullet:FindFirstChild("SmokeTrail") then
					Debris:AddItem(Bullet.SmokeTrail,5)
					Bullet.SmokeTrail.Parent = workspace
				end
				if Bullet:FindFirstChild("Trail") then
					Debris:AddItem(Bullet.Trail,5)
					Bullet.Trail.Parent = workspace
				end
			end
			Bullet:Destroy()
			break
		end

		for _, plyr in pairs(game.Players:GetPlayers()) do
			if Debounce or plyr == plr or not plyr.Character or not plyr.Character:FindFirstChild('Head') or (plyr.Character.Head.Position - BulletPos).magnitude > 25 then continue; end;
			Evt.Whizz:FireServer(plyr)
			Evt.Suppression:FireServer(plyr,1,nil,nil)
			Debounce = true
		end

		raycastResult2 = workspace:Raycast(PrevPos, (BulletPos - PrevPos)*5, raycastParams)

		if raycastResult2 then
			Hit2 = raycastResult2.Instance
			Pos2 = raycastResult2.Position
			Norm2 = raycastResult2.Normal
			Mat2 = raycastResult2.Material
		end

		local BulletRay = Ray.new(PrevPos, (BulletPos - PrevPos))
		raycastResult = workspace:Raycast(PrevPos, (BulletPos - PrevPos), raycastParams)
		BulletVector = BulletPos - PrevPos

		for _, plyr in pairs(game.Players:GetPlayers()) do
			if Debounce or plyr == plr or not plyr.Character or not plyr.Character:FindFirstChild('Head') or (plyr.Character.Head.Position - PrevPos).magnitude > 25 then continue; end;
			Evt.Suppression:FireServer(plyr,1,nil,nil)
			Debounce = true
		end

		if raycastResult then
			local shouldIgnore = false

			if Hit2 then
				while not recast do
					wait()
					if Hit2 and ShouldbeAddedtoIgnoreList(Hit2) then
						shouldIgnore = true
						recast = true
					end

					if recast then
						raycastParams.FilterDescendantsInstances = Ignore_Model

						raycastResult2 = workspace:Raycast(PrevPos, (BulletPos - PrevPos)*20, raycastParams)
						if raycastResult2 then
							Hit2 = raycastResult2.Instance
							Pos2 = raycastResult2.Position
							Norm2 = raycastResult2.Normal
							Mat2 = raycastResult2.Material
						end

						raycastResult = workspace:Raycast(PrevPos, (BulletPos - PrevPos), raycastParams)
						BulletVector = BulletPos - PrevPos
						recast = false
					else
						break
					end
				end
			end

			if shouldIgnore then
				PrevPos = BulletPos
				continue
			end

			if raycastResult and raycastResult.Instance then
				local CastDist
				local WallbangIgnore
				if Ignore_Model then
					WallbangIgnore = {table.unpack(Ignore_Model)}
				else
					WallbangIgnore = {}
				end

				local RayDirection = (BulletPos - PrevPos).Unit

				while not BulletStopped do
					wait()
					if raycastResult and raycastResult.Instance and Bullet.AssemblyLinearVelocity.Magnitude >= 0 then
						local HitPart = raycastResult.Instance
						TotalDistTraveled = (raycastResult.Position - Origin).Magnitude
						local entityId = GetEntityIdentifier(HitPart)
						local shouldDealDamage = false
						if entityId then
							if not BulletHitEntities[entityId] then
								BulletHitEntities[entityId] = true
								shouldDealDamage = true
							end
						end
						local FoundHuman, Victim = CheckForHumanoid(HitPart)
						if FoundHuman and Victim and Victim.Health > 0 and shouldDealDamage then
							local SKP_02 = SKP_01.."-"..plr.UserId
							if HitPart.Name == "Head" or HitPart.Name == "Headbox" or HitPart.Parent.Name == "Top" or HitPart.Parent.Name == "Headset" or HitPart.Parent.Name == "Olho" or HitPart.Parent.Name == "Face" or HitPart.Parent.Name == "Numero" then
								Evt.Damage:InvokeServer(WeaponTool, Victim, TotalDistTraveled, 1, WeaponData, ModTable, nil, nil, SKP_02, currentArchetypeData, nil, nil, nil)
							elseif HitPart.Name == "Torso" or HitPart.Name == "Hitbox" or HitPart.Name == "UpperTorso" or HitPart.Name == "LowerTorso" or HitPart.Parent.Name == "Chest" or HitPart.Parent.Name == "Waist" or HitPart.Name == "Right Arm" or HitPart.Name == "Left Arm" or HitPart.Name == "RightUpperArm" or HitPart.Name == "RightLowerArm" or HitPart.Name == "RightHand" or HitPart.Name == "LeftUpperArm" or HitPart.Name == "LeftLowerArm" or HitPart.Name == "LeftHand" then				
								Evt.Damage:InvokeServer(WeaponTool, Victim, TotalDistTraveled, 2, WeaponData, ModTable, nil, nil, SKP_02, currentArchetypeData, nil, nil, nil)
							elseif HitPart.Name == "Right Leg" or HitPart.Name == "Left Leg" or HitPart.Name == "RightUpperLeg" or HitPart.Name == "RightLowerLeg" or HitPart.Name == "RightFoot" or HitPart.Name == "LeftUpperLeg" or HitPart.Name == "LeftLowerLeg" or HitPart.Name == "LeftFoot" then
								Evt.Damage:InvokeServer(WeaponTool, Victim, TotalDistTraveled, 2, WeaponData, ModTable, nil, nil, SKP_02, currentArchetypeData, nil, nil, nil)		
							end	
						end
						local FoundJet, EnemyJet = CheckForJet(HitPart)
						if FoundJet and EnemyJet and EnemyJet.Info.Health.Value > 0 and shouldDealDamage then
							local SKP_02 = SKP_01.."-"..plr.UserId
							Evt.JetDamage:InvokeServer(WeaponTool, EnemyJet, TotalDistTraveled, 1, WeaponData, ModTable, nil, nil, SKP_02, currentArchetypeData, nil, nil, nil)
						end
						local WallbangParams = RaycastParams.new()
						WallbangParams.FilterDescendantsInstances = {raycastResult.Instance}
						WallbangParams.FilterType = Enum.RaycastFilterType.Include
						local BulletPenetration = currentArchetypeData.PenetrationPower / 50
						local Hardness = WallbangMaterialHardness[tostring(raycastResult.Material.Name)]

						if WallbangSpecialNames[raycastResult.Instance.Name] then
							CastDist = BulletPenetration / WallbangSpecialNames[raycastResult.Instance.Name]
						elseif Hardness then
							CastDist = BulletPenetration / Hardness
						else
							CastDist = BulletPenetration / WallbangMaterialHardness["default"]
						end

						local CastDist2 = CastDist * (Bullet.AssemblyLinearVelocity.Magnitude / (currentArchetypeData.MuzzleVelocity))
						local WBRayPosition = raycastResult.Position + RayDirection * CastDist2
						local WBRayVector = -RayDirection * CastDist2
						WallbangRay = workspace:Raycast(WBRayPosition, WBRayVector, WallbangParams)

						if WallbangRay then
							local thickness = (WallbangRay.Position - raycastResult.Position).Magnitude
							local velocityMultiplier = 0
							if not (table.find(LimbsList, raycastResult.Instance.Name) or table.find(TorsoList, raycastResult.Instance.Name) or raycastResult.Instance.Name == "Head") then
								velocityMultiplier = math.max((Bullet.AssemblyLinearVelocity.Magnitude / (currentArchetypeData.MuzzleVelocity)) - thickness, 0)
							else
								velocityMultiplier = math.max((Bullet.AssemblyLinearVelocity.Magnitude / (currentArchetypeData.MuzzleVelocity)) * 0.7, 0)
							end

							Bullet.AssemblyLinearVelocity = Bullet.AssemblyLinearVelocity * velocityMultiplier

							table.insert(WallbangParts, WallbangRay.Instance)
							table.insert(WallbangIgnore, WallbangRay.Instance)

							if not ShouldbeAddedtoIgnoreList(raycastResult.Instance) then
								HitMod.HitEffect(Ignore_Model, raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData)
								if isUnderBarrel then
									Evt.HitEffect:FireServer(raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData, currentAmmoData, TotalDistTraveled)
								else
									Evt.HitEffect:FireServer(raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData, currentAmmoData)
								end
							end

							if not ShouldbeAddedtoIgnoreList(WallbangRay.Instance) then
								HitMod.HitEffect(WallbangIgnore, WallbangRay.Position, WallbangRay.Instance, WallbangRay.Normal, WallbangRay.Material, WeaponData, currentArchetypeData)
								if isUnderBarrel then
									Evt.HitEffect:FireServer(WallbangRay.Position, WallbangRay.Instance, WallbangRay.Normal, WallbangRay.Material, WeaponData, currentArchetypeData, currentAmmoData, TotalDistTraveled)
								else
									Evt.HitEffect:FireServer(WallbangRay.Position, WallbangRay.Instance, WallbangRay.Normal, WallbangRay.Material, WeaponData, currentArchetypeData, currentAmmoData)
								end
							end

							BulletVector = BulletPos - PrevPos

							local params = RaycastParams.new()
							params.FilterDescendantsInstances = WallbangIgnore
							params.FilterType = Enum.RaycastFilterType.Exclude
							params.IgnoreWater = false
							raycastResult = workspace:Raycast(PrevPos, BulletVector, params)
						else
							if not ShouldbeAddedtoIgnoreList(raycastResult.Instance) then
								HitMod.HitEffect(Ignore_Model, raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData)
								if isUnderBarrel then
									Evt.HitEffect:FireServer(raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData, currentAmmoData, TotalDistTraveled)
								else
									Evt.HitEffect:FireServer(raycastResult.Position, raycastResult.Instance, raycastResult.Normal, raycastResult.Material, WeaponData, currentArchetypeData, currentAmmoData)
								end
							end

							if (RicoPos - raycastResult.Position).Magnitude > 0.2 then
								local Angle = math.deg(math.acos(BulletVector.Unit:Dot(raycastResult.Normal.Unit))) - 90
								local RicochetMaxAngle = RicochetMaterialMaxAngles[tostring(raycastResult.Material.Name)]
								if Angle < RicochetMaxAngle then
									Bullet.Position = raycastResult.Position
									Bullet.AssemblyLinearVelocity = (Bullet.AssemblyLinearVelocity.Magnitude * (BulletVector.Unit - (2 * BulletVector.Unit:Dot(raycastResult.Normal) * raycastResult.Normal))) * 0.35
									RicoPos = raycastResult.Position
									PrevPos = Bullet.Position
									raycastResult = nil
									RicoHappened = true
								else
									if not isUnderBarrel then
										if Bullet:FindFirstChild("Smoke") then
											Debris:AddItem(Bullet.Smoke,5)
											Bullet.Smoke.Parent = workspace
										end
										if Bullet:FindFirstChild("Fire") then
											Debris:AddItem(Bullet.Fire,5)
											Bullet.Fire.Parent = workspace
										end
										if Bullet:FindFirstChild("SmokeTrail") then
											Debris:AddItem(Bullet.SmokeTrail,5)
											Bullet.SmokeTrail.Parent = workspace
										end
										if Bullet:FindFirstChild("Trail") then
											Debris:AddItem(Bullet.Trail,5)
											Bullet.Trail.Parent = workspace
										end
									end
									Bullet:Destroy()
									BulletStopped = true
								end
							else
								if not isUnderBarrel then
									if Bullet:FindFirstChild("Smoke") then
										Debris:AddItem(Bullet.Smoke,5)
										Bullet.Smoke.Parent = workspace
									end
									if Bullet:FindFirstChild("Fire") then
										Debris:AddItem(Bullet.Fire,5)
										Bullet.Fire.Parent = workspace
									end
									if Bullet:FindFirstChild("SmokeTrail") then
										Debris:AddItem(Bullet.SmokeTrail,5)
										Bullet.SmokeTrail.Parent = workspace
									end
									if Bullet:FindFirstChild("Trail") then
										Debris:AddItem(Bullet.Trail,5)
										Bullet.Trail.Parent = workspace
									end
								end
								Bullet:Destroy()
								BulletStopped = true
							end
						end
					else
						break
					end
				end
			end
		end
		if RicoHappened then
			RicoHappened = false
		else 
			PrevPos = BulletPos
		end
	end
end

local Tracers = 0
function TracerCalculation(currentArchetypeData)
	if not currentArchetypeData.Tracer and not currentArchetypeData.BulletFlare then
		return false; 
	end;

	if currentArchetypeData.RandomTracer.Enabled then
		if math.random(1, 100) <= currentArchetypeData.RandomTracer.Chance then
			return true;
		end;
		return false;
	end;

	if Tracers >= currentArchetypeData.TracerEveryXShots then
		Tracers = 0;
		return true;
	end;
	Tracers = Tracers + 1;
	return false;
end;

function CreateBullet(isUnderBarrel)
	local currentArchetypeData, currentAmmoData
	if isUnderBarrel then
		currentArchetypeData = require(Engine.Archetypes.UnderBarrelGrenade.Default)
		currentAmmoData = nil
	else
		currentArchetypeData = ArchetypeData
		currentAmmoData = AmmoData

		if ArchetypeData.IsLauncher then
			for _, cPart in pairs(WeaponInHand:GetDescendants()) do
				if (cPart.Name == "Warhead" or cPart.Parent.Name == "Warhead") and cPart:IsA("BasePart") then
					cPart.Transparency = 1
				end
			end
		end
	end

	local Bullet = Instance.new("Part", Game_Workspace.Client)
	Bullet.Name = string.format("%s_Bullet", plr.Name)
	Bullet.CanCollide = false
	Bullet.Color = currentArchetypeData.TracerColor 
	Bullet.Shape = Enum.PartType.Ball
	Bullet.Transparency = 1
	Bullet.Size = Vector3.new(1,1,1)

	local Origin
	local Direction

	if isUnderBarrel then
		Origin = WeaponInHand.Handle.GrenadeMuzzle.WorldPosition
		Direction = (cam.CFrame.LookVector + Vector3.new(0, math.tan(math.rad(5)), 0)).Unit * 2
	elseif WeaponData.WeaponType ~= "Rocket Launcher" and WeaponData.WeaponType ~= "Flamethrower" and WeaponData.WeaponType ~= "Grenade Launcher" then
		Origin = cam.CFrame.Position
		Direction = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
	else
		Origin = WeaponInHand.Handle.Muzzle.WorldPosition
		Direction = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
	end

	local BulletCF = CFrame.new(Origin, Direction) 
	local WalkMul = currentArchetypeData.WalkMult
	local BColor = Color3.fromRGB(255,255,255)
	local balaspread

	local bulletsCount = isUnderBarrel and currentArchetypeData.Bullets or currentAmmoData.Bullets

	if PlayerState.aimming and bulletsCount <= 1 then
		balaspread = CFrame.Angles(
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / (10 * currentArchetypeData.AimSpreadReduction)),
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / (10 * currentArchetypeData.AimSpreadReduction)),
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / (10 * currentArchetypeData.AimSpreadReduction))
		)
	else
		balaspread = CFrame.Angles(
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / 10),
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / 10),
			math.rad(RAND(-BSpread - (charspeed/1) * WalkMul, BSpread + (charspeed/2) * WalkMul) / 10)
		)
	end

	Direction = balaspread * Direction

	local Visivel = TracerCalculation(currentArchetypeData)
	BColor = currentArchetypeData.TracerColor

	if Visivel then
		if gameRules.ReplicatedBullets then
			Evt.ServerBullet:FireServer(Origin, Direction, WeaponData, ModTable, currentArchetypeData)
		end

		if currentArchetypeData.Tracer == true then
			local At1 = Instance.new("Attachment")
			At1.Name = "At1"
			At1.Position = Vector3.new(-(.1),0,0)
			At1.Parent = Bullet

			local At2 = Instance.new("Attachment")
			At2.Name = "At2"
			At2.Position = Vector3.new((.2),0,0)
			At2.Parent = Bullet

			local Particles = Instance.new("Trail")
			Particles.Transparency = NumberSequence.new({
				NumberSequenceKeypoint.new(0, 1, 0);
				NumberSequenceKeypoint.new(1, 1);
			})

			local bulletLifeTime = isUnderBarrel and currentArchetypeData.BulletLifeTime or (currentArchetypeData.BulletLifeTime * currentAmmoData.BulletLifeTime)

			task.delay(0.2,function()
				Particles.Transparency = NumberSequence.new({
					NumberSequenceKeypoint.new(0, currentArchetypeData.BulletTransparency, 0);
					NumberSequenceKeypoint.new(0.5, currentArchetypeData.BulletTransparency, 0);
					NumberSequenceKeypoint.new(1, 1);
				})
			end)

			Particles.WidthScale = NumberSequence.new({
				NumberSequenceKeypoint.new(0, currentArchetypeData.BulletSize, 0);
				NumberSequenceKeypoint.new(0.5, currentArchetypeData.BulletSize, 0);
				NumberSequenceKeypoint.new(1, currentArchetypeData.BulletSize/10);
			})

			Particles.Color = ColorSequence.new(BColor)
			Particles.Texture = "rbxassetid://14846394635"
			Particles.TextureMode = Enum.TextureMode.Stretch

			if currentArchetypeData.GlowingBullet == true then
				Particles.Brightness = 10
				Particles.LightInfluence = 0
				Particles.LightEmission = 1
				
				local BulletLight = Instance.new("PointLight",Bullet)
				BulletLight.Color = BColor
				BulletLight.Range = 5
				BulletLight.Brightness = 12
			end

			Particles.FaceCamera = true
			Particles.LightEmission = 1
			Particles.LightInfluence = 0
			Particles.Lifetime = bulletLifeTime
			Particles.Attachment0 = At1
			Particles.Attachment1 = At2
			Particles.Parent = Bullet
		end
		if not isUnderBarrel then
			if WeaponData.WeaponType == "Flamethrower" or currentAmmoData.DragonsBreath == true then
				Engine.FX.Fire:Clone().Parent = Bullet
				Engine.FX.Smoke:Clone().Parent = Bullet
			end
			if WeaponData.WeaponType == "Rocket Launcher" then
				Engine.FX.SmokeTrail:Clone().Parent = Bullet
			end
		end

		if currentArchetypeData.BulletFlare == true then
			local bg = Instance.new("BillboardGui", Bullet)
			bg.Adornee = Bullet
			bg.Enabled = false
			local flashsize = math.random(75, 100)/10
			bg.Size = UDim2.new(flashsize, 0, flashsize, 0)
			bg.LightInfluence = 0
			bg.Brightness = 20
			local flash = Instance.new("ImageLabel", bg)
			flash.BackgroundTransparency = 1
			flash.Size = UDim2.new(1, 0, 1, 0)
			flash.Position = UDim2.new(0, 0, 0, 0)
			flash.Image = "http://www.roblox.com/asset/?id=1047066405"
			flash.ImageTransparency = math.random(2, 5)/15
			flash.ImageColor3 = BColor

			spawn(function()
				task.wait(.1)
				if not Bullet:FindFirstChild("BillboardGui") then return; end;
				Bullet.BillboardGui.Enabled = true
			end)
		end
	end

	local BulletMass = Bullet:GetMass()
	local Force = Vector3.new(0,(BulletMass) * (workspace.Gravity) - (currentArchetypeData.BulletDrop) * (workspace.Gravity), 0)
	local BF = Instance.new("BodyForce",Bullet)

	Bullet.CFrame = BulletCF

	local muzzleVelocityMultiplier = isUnderBarrel and 9 or (ModTable.MuzzleVelocity * 9)
	Bullet:ApplyImpulse(Direction * currentArchetypeData.MuzzleVelocity * muzzleVelocityMultiplier)

	BF.Force = Force
	Bullet.CollisionGroup = "Bullet"
	game.Debris:AddItem(Bullet, 5)

	CastRay(Bullet, Origin, isUnderBarrel, isUnderBarrel and currentArchetypeData or nil)
end

function CreateUnderBarrelBullet()
	CreateBullet(true)
end
function CreateNormalBullet()
	CreateBullet(false)
end
function CheckBipodSurface()
	if not WeaponInHand or not WeaponInHand:FindFirstChild("BipodHinge") then 
		return false, nil, nil 
	end
	local bipodHinge = WeaponInHand.BipodHinge
	local rayOrigin = bipodHinge.Position
	local rayDirection = Vector3.new(0, -BipodMods.MaxDistance, 0)

	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = Ignore_Model
	raycastParams.FilterType = Enum.RaycastFilterType.Exclude
	raycastParams.IgnoreWater = true

	local result = workspace:Raycast(rayOrigin, rayDirection, raycastParams)

	if result then
		local distance = (result.Position - rayOrigin).Magnitude
		if distance <= BipodMods.MaxDistance then
			return true, result.Position, result.Normal
		end
	end

	return false, nil, nil
end
function DeployBipod()
	if not BipodTable.IsBipod or BipodTable.BipodActive then return end

	BipodTable.BipodActive = true
	PlayerState.BipodDeployed = true

	if PlayerState.AnimDebounce and not PlayerState.shooting then
		BipodOpen()
	end

	if WeaponData and ArchetypeData then

		if not BipodTable.OriginalSpread then
			BipodTable.OriginalMinSpread = ArchetypeData.MinSpread
			BipodTable.OriginalMaxSpread = ArchetypeData.MaxSpread
		end

		ModTable.MinSpread = ModTable.MinSpread * BipodMods.SpreadReduction
		ModTable.MaxSpread = ModTable.MaxSpread * BipodMods.SpreadReduction
		ModTable.camRecoilMod.RecoilUp = ModTable.camRecoilMod.RecoilUp * BipodMods.RecoilReduction
		ModTable.gunRecoilMod.RecoilUp = ModTable.gunRecoilMod.RecoilUp * BipodMods.RecoilReduction

		if BSpread then
			BSpread = BSpread * BipodMods.SpreadReduction
		end
	end
end
function RetractBipod()
	if not BipodTable.BipodActive then return end

	BipodTable.BipodActive = false
	PlayerState.BipodDeployed = false
	PlayerState.BipodSurfaceContact = false
	BipodTable.BipodLocked = false

	if BipodTable.OriginalMinSpread then
		ModTable.MinSpread = ModTable.MinSpread / BipodMods.SpreadReduction
		ModTable.MaxSpread = ModTable.MaxSpread / BipodMods.SpreadReduction
		ModTable.camRecoilMod.RecoilUp = ModTable.camRecoilMod.RecoilUp / BipodMods.RecoilReduction
		ModTable.gunRecoilMod.RecoilUp = ModTable.gunRecoilMod.RecoilUp / BipodMods.RecoilReduction

		BipodTable.OriginalMinSpread = nil
		BipodTable.OriginalMaxSpread = nil
	end
	if PlayerState.AnimDebounce and not PlayerState.shooting and not PlayerState.reloading then
		BipodClose()
	end
end


function meleeCast()
	local recast
	local rayOrigin 	= cam.CFrame.Position
	local rayDirection 	= cam.CFrame.LookVector  * 10
	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = Ignore_Model
	raycastParams.FilterType = Enum.RaycastFilterType.Exclude
	raycastParams.IgnoreWater = false
	local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
	if raycastResult then
		local Hit2 = raycastResult.Instance
		if Hit2 and Hit2.Parent:IsA('Accessory') or Hit2.Parent:IsA('Hat') then
			for _,players in pairs(game.Players:GetPlayers()) do
				if players.Character then
					for i, hats in pairs(players.Character:GetChildren()) do
						if hats:IsA("Accessory") then
							table.insert(Ignore_Model, hats)
						end
					end
				end
			end
			return meleeCast()
		end
		if Hit2 and Hit2.Name == "Ignorable" or Hit2.Name == "Glass" or Hit2.Name == "Ignore" or Hit2.Parent.Name == "Top" or Hit2.Parent.Name == "Helmet" or Hit2.Parent.Name == "Up" or Hit2.Parent.Name == "Down" or Hit2.Parent.Name == "Face" or Hit2.Parent.Name == "Olho" or Hit2.Parent.Name == "Headset" or Hit2.Parent.Name == "Numero" or Hit2.Parent.Name == "Vest" or Hit2.Parent.Name == "Chest" or Hit2.Parent.Name == "Waist" or Hit2.Parent.Name == "Back" or Hit2.Parent.Name == "Belt" or Hit2.Parent.Name == "Leg1" or Hit2.Parent.Name == "Leg2" or Hit2.Parent.Name == "Arm1"  or Hit2.Parent.Name == "Arm2" then
			table.insert(Ignore_Model, Hit2)
			return meleeCast()
		end
		if Hit2 and Hit2.Parent.Name == "Top" or Hit2.Parent.Name == "Helmet" or Hit2.Parent.Name == "Up" or Hit2.Parent.Name == "Down" or Hit2.Parent.Name == "Face" or Hit2.Parent.Name == "Olho" or Hit2.Parent.Name == "Headset" or Hit2.Parent.Name == "Numero" or Hit2.Parent.Name == "Vest" or Hit2.Parent.Name == "Chest" or Hit2.Parent.Name == "Waist" or Hit2.Parent.Name == "Back" or Hit2.Parent.Name == "Belt" or Hit2.Parent.Name == "Leg1" or Hit2.Parent.Name == "Leg2" or Hit2.Parent.Name == "Arm1"  or Hit2.Parent.Name == "Arm2" then
			table.insert(Ignore_Model, Hit2.Parent)
			return meleeCast()
		end
		if Hit2 and (Hit2.Transparency >= 1 or Hit2.CanCollide == false) and Hit2.Name ~= 'Head' and Hit2.Name ~= 'Right Arm' and Hit2.Name ~= 'Left Arm' and Hit2.Name ~= 'Right Leg' and Hit2.Name ~= 'Left Leg' and Hit2.Name ~= "UpperTorso" and Hit2.Name ~= "LowerTorso" and Hit2.Name ~= "RightUpperArm" and Hit2.Name ~= "RightLowerArm" and Hit2.Name ~= "RightHand" and Hit2.Name ~= "LeftUpperArm" and Hit2.Name ~= "LeftLowerArm" and Hit2.Name ~= "LeftHand" and Hit2.Name ~= "RightUpperLeg" and Hit2.Name ~= "RightLowerLeg" and Hit2.Name ~= "RightFoot" and Hit2.Name ~= "LeftUpperLeg" and Hit2.Name ~= "LeftLowerLeg" and Hit2.Name ~= "LeftFoot" and Hit2.Name ~= 'Armor' and Hit2.Name ~= 'EShield' then
			table.insert(Ignore_Model, Hit2)
			return meleeCast()
		end
		if Hit2 and (Hit2.Transparency >= 1 or Hit2.CanCollide == false) and Hit2.Name ~= 'Shield' and Hit2.Name ~= 'HeadShield' then
			table.insert(Ignore_Model, Hit2)
			return meleeCast()
		end
	end

	if raycastResult then
		local FoundHuman,VitimaHuman = CheckForHumanoid(raycastResult.Instance)
		HitMod.HitEffect(Ignore_Model, raycastResult.Position, raycastResult.Instance , raycastResult.Normal, raycastResult.Material, WeaponData,ArchetypeData)
		Evt.HitEffect:FireServer(raycastResult.Position, raycastResult.Instance , raycastResult.Normal, raycastResult.Material, WeaponData,ArchetypeData,AmmoData)
		local HitPart = raycastResult.Instance
		if FoundHuman == true and VitimaHuman.Health > 0 then
			local SKP_02 = SKP_01.."-"..plr.UserId

			if HitPart.Name == "Right Arm" or HitPart.Name == "Right Leg" or HitPart.Name == "Left Leg" or HitPart.Name == "Left Arm" or HitPart.Name == "RightUpperLeg" or HitPart.Name == "RightLowerLeg" or HitPart.Name == "RightFoot" or HitPart.Name == "LeftUpperLeg" or HitPart.Name == "LeftLowerLeg" or HitPart.Name == "LeftFoot" or HitPart.Name == "Torso" or HitPart.Name == "UpperTorso" or HitPart.Name == "LowerTorso" or HitPart.Parent.Name == "Chest" or HitPart.Parent.Name == "Waist" or HitPart.Name == "RightUpperArm" or HitPart.Name == "RightLowerArm" or HitPart.Name == "RightHand" or HitPart.Name == "LeftUpperArm" or HitPart.Name == "LeftLowerArm" or HitPart.Name == "LeftHand" or HitPart.Name == "Head" or HitPart.Parent.Name == "Top" or HitPart.Parent.Name == "Headset" or HitPart.Parent.Name == "Olho" or HitPart.Parent.Name == "Face" or HitPart.Parent.Name == "Numero" then
				task.spawn(function()
					Evt.Damage:InvokeServer(WeaponTool, VitimaHuman, 0, 3, WeaponData, ModTable, nil, nil, SKP_02,ArchetypeData)	
				end)
			end
		end			
	end
end
Evt.Xp.OnClientEvent:Connect(function(Type)
	local HMC = Engine.FX.Killmarker:Clone()
	local HMGC = Crosshair.HitFrame.Kill:Clone()
	local Xp
	HMGC.Parent = Crosshair.HitFrame

	HMGC.Name = "ActiveKillmarker"

	HMGC.Size=UDim2.new(0.06,0,0.06,0)
	HMGC.ZIndex = 2
	HMC.Parent = plr.PlayerGui
	HMC.PlayOnRemove = true
	HMC:Destroy()

	for i,v in pairs (HMGC:GetDescendants()) do
		if v:IsA("Frame") then
			TweenService:Create(v,TweenInfo.new(0.2),{BackgroundTransparency=0}):Play()
		elseif v:IsA("UIStroke") then
			TweenService:Create(v,TweenInfo.new(0.2),{Transparency=0.7}):Play()
		end
	end
	TweenService:Create(HMGC,TweenInfo.new(0.25),{Size=UDim2.new(0.04,0,0.04,0)}):Play()
	if Type == "Head" then
		Xp = 175
	else
		Xp = 135
	end
	local Medal = HMGUI.XpFrame.Medals.Temp:Clone()
	Medal.Parent = HMGUI.XpFrame.Medals
	Medal.Visible = true
	Medal.Text = "ELIMINATION"
	Medal.Name = "ELIMINATION"

	local Amount = HMGUI.XpFrame.Amount.Temp:Clone()
	Amount.Parent = HMGUI.XpFrame.Amount
	Amount.Visible = true
	Amount.Text = " + "..Xp.." XP"
	Amount.Name = "Amount"

	TweenService:Create(Amount,TweenInfo.new(0.25),{TextTransparency=0}):Play()

	task.wait(3)

	for i,v in pairs (HMGC:GetDescendants()) do
		if v:IsA("Frame") then
			TweenService:Create(v,TweenInfo.new(0.5),{BackgroundTransparency=1}):Play()
		elseif v:IsA("UIStroke") then
			TweenService:Create(v,TweenInfo.new(0.5),{Transparency=1}):Play()
		end
	end

	TweenService:Create(Amount,TweenInfo.new(1),{TextTransparency=1}):Play()
	TweenService:Create(Medal,TweenInfo.new(1),{TextTransparency=1}):Play()

	TweenService:Create(HMGC,TweenInfo.new(0.75),{Size=UDim2.new(0.08,0,0.08,0)}):Play()
	task.wait(0.75)
	Amount:Destroy()
	Medal:Destroy()
	HMGC:Destroy()

end)
Evt.RankUp.OnClientEvent:Connect(function(Type,GunName,Amount)
	if HMGUI:FindFirstChild("RankClone") then
		repeat 
			task.wait(0.5)
		until not HMGUI:FindFirstChild("RankClone")
	end
	if Type == "Gun" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "WEAPON RANK UP"
		RankClone.Description.Text = GunName.." ranked up to rank "..Amount
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()

		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()

		task.wait(2.4)

		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()

		task.wait(0.1)

		RankClone:Destroy()
	elseif Type == "Rank" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "RANKED UP"
		RankClone.Description.Text = "New Rank "..Amount
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1

		local Badge = math.ceil(Amount/10)
		RankClone.GunLogo.Image = RS.Ranks[Badge].Texture
		RankClone.Rarity.Image = "http://www.roblox.com/asset/?id=12123475331"
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		task.wait(2.4)
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		task.wait(0.1)
		RankClone:Destroy()
	elseif Type == "GunUnlock" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "NEW WEAPON"
		RankClone.Description.Text = GunName.." unlocked"
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		task.wait(2.4)
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		task.wait(0.1)
		RankClone:Destroy()
	elseif Type == "KitUnlock" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "NEW KIT"
		RankClone.Description.Text = GunName.." unlocked"
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		task.wait(2.4)
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		task.wait(0.1)
		RankClone:Destroy()
	elseif Type == "GrenadeUnlock" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "NEW GRENADE"
		RankClone.Description.Text = GunName.." unlocked"
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		task.wait(2.4)
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		task.wait(0.1)
		RankClone:Destroy()
	elseif Type == "AttUnlock" then
		local RankClone = HMGUI.RankUp:Clone()
		RankClone.Name = "RankClone"
		RankClone.Parent = HMGUI
		RankClone.Visible = true
		RankClone.Size = UDim2.new(1.2,0,1.2,0)
		RankClone.Medals.Description.Text = "NEW ATTACHMENT"
		RankClone.Description.Text = GunName.." unlocked"
		RankClone.Medals.Transparency = 1
		RankClone.Medals.Description.TextTransparency = 1
		RankClone.GunLogo.ImageTransparency = 1
		RankClone.Rarity.ImageTransparency = 1
		RankClone.Description.TextTransparency = 1

		RankClone.GunLogo.Image = "http://www.roblox.com/asset/?id=13577838989"
		RankClone.Rarity.Image = "http://www.roblox.com/asset/?id=12123475331"
		TweenService:Create(RankClone,TweenInfo.new(0.2),{Size=UDim2.new(0.25,0,0.275,0)}):Play()

		TweenService:Create(RankClone.Medals,TweenInfo.new(0.2),{Transparency = 0.5}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.2),{ImageTransparency = 0}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.2),{ImageTransparency = 0.5}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.2),{TextTransparency = 0}):Play()
		task.wait(2.4)
		TweenService:Create(RankClone.Medals,TweenInfo.new(0.1),{Transparency = 1}):Play()
		TweenService:Create(RankClone.Medals.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		TweenService:Create(RankClone.GunLogo,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Rarity,TweenInfo.new(0.1),{ImageTransparency = 1}):Play()
		TweenService:Create(RankClone.Description,TweenInfo.new(0.1),{TextTransparency = 1}):Play()
		task.wait(0.1)
		RankClone:Destroy()
	end
end)

Evt.HitMarker.OnClientEvent:Connect(function(Type,Damage)
	if Damage > 0 then
		local HMC
		local HMGC = Crosshair.HitFrame.Hit:Clone()
		HMGC.Parent = Crosshair.HitFrame
		HMGC.Name = "ActiveHitmarker"
		HMGC.Size=UDim2.new(0.04,0,0.04,0)
		if Type == "Head" then
			HMC = Engine.FX.Headmarker:Clone()
		else
			HMC = Engine.FX.Hitmarker:Clone()
		end
		HMC.Parent = plr.PlayerGui
		HMC.PlayOnRemove = true
		HMC:Destroy()
		for i,v in pairs (HMGC:GetDescendants()) do
			if v:IsA("Frame") then
				TweenService:Create(v,TweenInfo.new(0.1),{BackgroundTransparency=0.2}):Play()
			elseif v:IsA("UIStroke") then
				TweenService:Create(v,TweenInfo.new(0.1),{Transparency=0.7}):Play()
			end
		end
		TweenService:Create(HMGC,TweenInfo.new(0.1),{Size=UDim2.new(0.035,0,0.035,0)}):Play()
		task.wait(2)
		for i,v in pairs (HMGC:GetDescendants()) do
			if v:IsA("Frame") then
				TweenService:Create(v,TweenInfo.new(0.25),{BackgroundTransparency=1}):Play()
			elseif v:IsA("UIStroke") then
				TweenService:Create(v,TweenInfo.new(0.25),{Transparency=1}):Play()
			end
		end
		if HMC:FindFirstChild("ActiveHitmarker") then
			if HMC:FindFirstChild("ActiveHitmarker") == HMGC then
				TweenService:Create(HMGC,TweenInfo.new(0.5),{Size=UDim2.new(0.08,0,0.08,0)}):Play()
			end
		end
		task.wait(0.5)
		HMGC:Destroy()
	end
end)

function UpdateCrossHair(Aim)
	local CrosshairString = PlayerState.PlayerData.Settings[WeaponData.WeaponType.."_Crosshair"].Value
	local CentreDot = PlayerState.PlayerData.Settings[WeaponData.WeaponType.."_CenterDot"].Value
	local function SetVisibility(container, transparent)
		for i, v in pairs(container:GetChildren()) do
			if v:FindFirstChild("UIStroke") then
				if v.ClassName == "Frame" then
					v.BackgroundTransparency = 1
				elseif v.ClassName == "ImageLabel" then
					v.ImageTransparency = 1
				end
				v.UIStroke.Transparency = transparent and 1 or 0
			else
				if v.ClassName == "Frame" then
					TS:Create(v, TweenInfo.new(.2, Enum.EasingStyle.Linear), {BackgroundTransparency = transparent and 1 or 0}):Play()
				elseif v.ClassName == "ImageLabel" then
					TS:Create(v, TweenInfo.new(.2, Enum.EasingStyle.Linear), {ImageTransparency = transparent and 1 or 0}):Play()
				end
			end
		end
	end
	local function HideAllCrosshairs()
		for crosshairType, crosshairContainer in pairs(Crosshair:GetChildren()) do
			SetVisibility(crosshairContainer, true)
		end
	end
	if Aim == "DeScope" then
		SetVisibility(Scope, true)
		TS:Create(BorderGui.ImageLabel, TweenInfo.new(.2, Enum.EasingStyle.Linear), {ImageTransparency = 0.95}):Play()

		HideAllCrosshairs()
		if WeaponData.CrossHair then
			SetVisibility(Crosshair[CrosshairString], false)
		end
		if CentreDot then
			print("Setting Centre Dot to visible")
			SetVisibility(Crosshair.CentreDot, false)
		end
	elseif Aim == "Scope" then
		HideAllCrosshairs()
		if (((WeaponData.Sniper and not AttTable.SightAtt) or (AttTable.SightAtt and SightData.Sniper)) and (not AttTable.OtherAtt or not OtherData.Canted)) then
			TS:Create(BorderGui.ImageLabel, TweenInfo.new(.2, Enum.EasingStyle.Linear), {ImageTransparency = 0}):Play()
			SetVisibility(Crosshair[CrosshairString], true)
			SetVisibility(Crosshair.CentreDot, true)

		else
			SetVisibility(Crosshair[CrosshairString], true)
			SetVisibility(Crosshair.CentreDot, true)
			TS:Create(BorderGui.ImageLabel, TweenInfo.new(.2, Enum.EasingStyle.Linear), {ImageTransparency = 0.5}):Play()
		end
	elseif Aim == "Run" then
		HideAllCrosshairs()
		SetVisibility(Scope, true)
		SetVisibility(Crosshair.CentreDot, true)
		TS:Create(BorderGui.ImageLabel, TweenInfo.new(.2, Enum.EasingStyle.Linear), {ImageTransparency = 0.95}):Play()
	elseif Aim == "Red" then
		for i, v in pairs(Crosshair[CrosshairString]:GetChildren()) do
			if v.ClassName == "Frame" then
				v.BackgroundColor3 = Color3.fromRGB(135, 0, 0)
			elseif v.ClassName == "ImageLabel" then
				v.ImageColor3 = Color3.fromRGB(135, 0, 0)
			end
			if v:FindFirstChild("UIStroke") then
				v.UIStroke.Color = Color3.fromRGB(135, 0, 0)
			end
		end
	elseif Aim == "White" then
		for i, v in pairs(Crosshair[CrosshairString]:GetChildren()) do
			if v.ClassName == "Frame" then
				v.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
			elseif v.ClassName == "ImageLabel" then
				v.ImageColor3 = Color3.fromRGB(255, 255, 255)
			end
			if v:FindFirstChild("UIStroke") then
				v.UIStroke.Color = Color3.fromRGB(255, 255, 255)
			end
		end

	elseif Aim == "Green" then
		for i, v in pairs(Crosshair[CrosshairString]:GetChildren()) do
			if v.ClassName == "Frame" then
				v.BackgroundColor3 = Color3.fromRGB(5, 155, 20)
			elseif v.ClassName == "ImageLabel" then
				v.ImageColor3 = Color3.fromRGB(5, 155, 20)
			end
			if v:FindFirstChild("UIStroke") then
				v.UIStroke.Color = Color3.fromRGB(5, 155, 20)
			end
		end
	end
end

function UpdateGui()
	if SE_GUI then
		local HUD = SE_GUI.GunHUD

		if WeaponData ~= nil then
			if PlayerState.IsUnderLauncher then
				HUD.CurrentGun.Ammo.Text = UnderBarrelAmmo
				if UnderBarrelAmmo < 10 then
					HUD.CurrentGun.Empty.Text = "00"
				elseif UnderBarrelAmmo < 100 then
					HUD.CurrentGun.Empty.Text = "0"
				else
					HUD.CurrentGun.Empty.Text = ""
				end

				if WeaponData.MagCount then
					local res = math.ceil(StoredUnderBarrelAmmo/WeaponData.UBAmmo)
					HUD.CurrentGun.Reserve.Text = res
					if res < 10 then
						HUD.CurrentGun.ReserveEmpty.Text = "00"
					elseif res < 100 then
						HUD.CurrentGun.ReserveEmpty.Text = "0"
					else
						HUD.CurrentGun.ReserveEmpty.Text = ""
					end
				else
					HUD.CurrentGun.Reserve.Text = StoredUnderBarrelAmmo
					if StoredUnderBarrelAmmo < 10 then
						HUD.CurrentGun.ReserveEmpty.Text = "00"
					elseif StoredUnderBarrelAmmo < 100 then
						HUD.CurrentGun.ReserveEmpty.Text = "0"
					else
						HUD.CurrentGun.ReserveEmpty.Text = ""
					end
				end


				if UnderBarrelAmmo >= 0 and WeaponData.AmmoCounter == true and WeaponInHand.Counter then
					WeaponInHand.Counter.SurfaceGui.TextBox.Visible = true
					if UnderBarrelAmmo < 10 then
						WeaponInHand.Counter.SurfaceGui.TextBox.Text = "00"..UnderBarrelAmmo
					elseif UnderBarrelAmmo < 100 then
						WeaponInHand.Counter.SurfaceGui.TextBox.Text = "0"..UnderBarrelAmmo
					else
						WeaponInHand.Counter.SurfaceGui.TextBox.Text = UnderBarrelAmmo
					end
				end

				if (UnderBarrelAmmo/WeaponData.UBAmmo)*100 > 17 then
					HUD.CurrentGun.Ammo.TextColor3 = Color3.new(1,1,1)
					HUD.CurrentGun.Ammo.TextStrokeColor3 = Color3.new(1,1,1)
				else
					HUD.CurrentGun.Ammo.TextColor3 = Color3.new(1,0,0)
					HUD.CurrentGun.Ammo.TextStrokeColor3 = Color3.new(1,0,0)
				end
			else
				if Ammo ~= nil then
					HUD.CurrentGun.Ammo.Text = Ammo
					if Ammo < 10 then
						HUD.CurrentGun.Empty.Text = "00"
					elseif Ammo < 100 then
						HUD.CurrentGun.Empty.Text = "0"
					else
						HUD.CurrentGun.Empty.Text = ""
					end
					
					if StoredAmmo ~= nil then
						if WeaponData.MagCount then
							local res = math.ceil(StoredAmmo/WeaponData.Ammo)
							HUD.CurrentGun.Reserve.Text = res
							if res < 10 then
								HUD.CurrentGun.ReserveEmpty.Text = "00"
							elseif res < 100 then
								HUD.CurrentGun.ReserveEmpty.Text = "0"
							else
								HUD.CurrentGun.ReserveEmpty.Text = ""
							end
						else
							HUD.CurrentGun.Reserve.Text = StoredAmmo
							if StoredAmmo < 10 then
								HUD.CurrentGun.ReserveEmpty.Text = "00"
							elseif StoredAmmo < 100 then
								HUD.CurrentGun.ReserveEmpty.Text = "0"
							else
								HUD.CurrentGun.ReserveEmpty.Text = ""
							end
						end
					end

					if Ammo >= 0 and WeaponData.AmmoCounter == true and WeaponInHand.Counter then
						WeaponInHand.Counter.SurfaceGui.TextBox.Visible = true
						if Ammo < 10 then
							WeaponInHand.Counter.SurfaceGui.TextBox.Text = "00"..Ammo
						elseif Ammo < 100 then
							WeaponInHand.Counter.SurfaceGui.TextBox.Text = "0"..Ammo
						else
							WeaponInHand.Counter.SurfaceGui.TextBox.Text = Ammo
						end
					end

					if (Ammo/WeaponData.Ammo)*100 > 17 then
						HUD.CurrentGun.Ammo.TextColor3 = Color3.new(1,1,1)
						HUD.CurrentGun.Ammo.TextStrokeColor3 = Color3.new(1,1,1)
					else
						HUD.CurrentGun.Ammo.TextColor3 = Color3.new(1,0,0)
						HUD.CurrentGun.Ammo.TextStrokeColor3 = Color3.new(1,0,0)
					end
				end
			end

			SE_GUI.GunHUD.Health.Fill.Size = UDim2.new(Humanoid.Health/Humanoid.MaxHealth,0,0.95,0)

			if WeaponInHand:FindFirstChild("Lines") then
				for i, v in pairs(WeaponInHand.Lines.SurfaceGui:GetChildren()) do 
					v.Visible = true
				end
			end

			HUD.CurrentGun.GrenadeBar.Ammo.Text = Grenades
			HUD.CurrentGun.GunLogo.Image = WeaponData.GunLogoImage
			HUD.CurrentGun.GrenadeBar.Grenade.Image = RS.Grenades[PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Grenade.Value].Logo.Image
			if WeaponData.ShootType == 1 then
				HUD.CurrentGun.FireMode.Text = "[ SEMI ]"
			elseif WeaponData.ShootType == 2 then
				HUD.CurrentGun.FireMode.Text = "[ BURST ]"
			elseif WeaponData.ShootType == 3 then
				HUD.CurrentGun.FireMode.Text = "[ AUTO ]"
			elseif WeaponData.ShootType == 4 or WeaponData.ShootType == 5 or WeaponData.ShootType == 8 then
				HUD.CurrentGun.FireMode.Text = "[ SINGLE ]"
			end
		end
	end
end

function CheckMagFunction()
	if PlayerState.aimming then
		PlayerState.aimming = false
		ADS(PlayerState.aimming)
	end
	PlayerState.mouse1down 	= false
	PlayerState.SafeMode 	= false
	GunStance 	= 0
	Evt.GunStance:FireServer(GunStance,AnimData)
	UpdateGui()
	if Ammo <= 0 then
		EmptyMagCheckAnim()
	else
		MagCheckAnim()
	end
	RunCheck()
end
function GrenadeModel(GreName)
	local SKP_02 = SKP_01.."-"..plr.UserId
	GreModel 	= Engine.GrenadeModels:WaitForChild(GreName):Clone()
	GreModel.PrimaryPart = GreModel:WaitForChild("Grenade")
	for index, key in pairs(GreModel:GetChildren()) do
		if key:IsA('BasePart') and key.Name ~= 'Grenade' then

			if key.Name ~= "Bolt" and key.Name ~= 'Lid' and key.Name ~= "Slide" then
				Ultil.Weld(GreModel:WaitForChild("Grenade"), key)
			end

			if key.Name == "Bolt" or key.Name == "Slide" then
				Ultil.WeldComplex(GreModel:WaitForChild("Grenade"), key, key.Name)
			end;
			key.CanCollide = false
		end

	end;
	GreModel.Parent = ViewModel
	GreModel.Grenade.CanCollide = false
	GreModel:SetPrimaryPartCFrame(WeaponInHand.Handle.CFrame)

	GreWeld.Part1 = GreModel:WaitForChild("Grenade")
	GreWeld.C1 = grecf

	GreModel.Grenade.Trail:Destroy()

	GreModel.Grenade.Throw.Played:Connect(function()
		Evt.Grenade:FireServer(WeaponTool,WeaponData,GreModel.PrimaryPart.CFrame,cam.CFrame.LookVector,100,SKP_02,Timer,GreName)
	end)

	GreModel.Grenade.PullPin.Played:Connect(function()
		BeginCookGrenade()
	end)
end
function BeginCookGrenade()
	Timer = 3
	repeat
		Timer = Timer - 0.2
		wait(0.2)
	until not PlayerState.CookGrenade or Timer <= 0
	GrenadeThrow(Timer)
end
function Grenade(GRL)
	if GRL then
		if GRL == true then
			PlayerState.GRDebounce = true
			GrenadeReady()

			repeat
				wait()
			until not PlayerState.CookGrenade
			TossGrenade(GRL)
		else
			if not PlayerState.GRDebounce then
				PlayerState.GRDebounce = true
				GrenadeReady()

				repeat
					wait()
				until not PlayerState.CookGrenade
				TossGrenade()
			end
		end
	else
		if not PlayerState.GRDebounce then
			PlayerState.GRDebounce = true
			GrenadeReady()

			repeat
				wait()
			until not PlayerState.CookGrenade
			TossGrenade()
			PlayerState.GRDebounce = false
		end
	end
end

function TossGrenade(GRL)
	local SKP_02 = SKP_01.."-"..plr.UserId
	GrenadeThrow()
	if WeaponTool and WeaponData then
		if GRL then
			if GRL == true then
			end
		else
		end
	end
end

function NewSpring(Initial)
	local t0 = tick()
	local p0 = Initial or 0
	local v0 = Initial and 0*Initial or 0
	local t	= Initial or 0
	local d	= 1
	local s	= 1

	local function positionVelocity(Tick)
		local x	= Tick - t0
		local c0 = p0 - t
		if s == 0 then
			return p0, 0
		elseif d < 1 then
			local c	= math.sqrt(1 - d ^ 2)
			local c1 = (v0 / s + d * c0) / c
			local co = math.cos(c * s * x)
			local si = math.sin(c * s * x)
			local e	= math.exp(d * s * x)
			return t + (c0 * co + c1 * si) / e, s * ((c * c1 - d * c0) * co - (c * c0 + d * c1) * si) / e
		else
			local c1 = v0 / s + c0
			local e	= math.exp(s * x)
			return t + (c0 + c1 * s * x) / e, s * (c1 - c0 - c1 * s * x) / e
		end
	end

	return setmetatable(
		{
			accelerate = function(_, acceleration)
				local T = tick()
				local p, v = positionVelocity(T)
				p0 = p
				v0 = v + acceleration
				t0 = T
			end;
		},
		{
			__index = function(_, index)
				if index == "value" or index == "position" or index == "p" then
					local p, v = positionVelocity(tick())
					return p
				elseif index == "velocity" or index == "v" then
					local p, v = positionVelocity(tick())
					return v
				elseif index == "acceleration" or index == "a" then
					local x	= tick() - t0
					local c0 = p0 - t
					if s == 0 then
						return 0
					elseif d < 1 then
						local c = math.sqrt(1 - d ^ 2)
						local c1 = (v0 / s + d * c0) / c
						local cs = (c0 * d ^ 2 - 2 * c * d * c1 - c0 * c ^ 2) * math.cos(c * s * x)
						local sn = (c1 * d ^ 2 + 2 * c * d * c0 - c1 * c ^ 2) * math.sin(c * s * x)
						return s ^ 2 *(cs + sn) / math.exp(d * s * x)
					else
						local c1 = v0 / s + c0
						return s ^ 2 * (c0 - 2 * c1 + c1 * s * x) / math.exp(s * x)
					end
				elseif index == "target" or index == "t" then
					return t
				elseif index == "damper" or index == "d" then
					return d
				elseif index == "speed" or index == "s" then
					return s
				elseif index == "magnitude" or index == "m" then
					local p, v = positionVelocity(tick())
					return p.magnitude
				else
					error(index.." is not a valid member of spring", 0)
				end
			end;

			__newindex = function(_, index, value)
				local T = tick()
				if index == "value" or index == "position" or index == "p" then
					local p, v = positionVelocity(T)
					p0, v0 = value, v
				elseif index == "velocity" or index == "v" then
					local p, v = positionVelocity(T)
					p0, v0 = p, value
				elseif index == "acceleration" or index == "a" then
					local p, v = positionVelocity(T)
					p0, v0 = p, v + value
				elseif index == "target" or index == "t" then
					p0, v0 = positionVelocity(T)
					t = value
				elseif index == "damper" or index == "d" then
					p0, v0 = positionVelocity(T)
					d = value < 0 and 0 or value < 1 and value or 1
				elseif index == "speed" or index == "s" then
					p0, v0 = positionVelocity(T)
					s = value < 0 and 0 or value
				else
					error(index.." is not a valid member of spring", 0)
				end
				t0 = T
			end;
		}
	)
end

function FromAxisAngle(x, y, z)
	if not y then
		x, y, z = x.x, x.y, x.z
	end
	local m = (x * x + y * y + z * z) ^ 0.5
	if m > 1e-5 then
		local si = math.sin(m / 2) / m
		return CFrame.new(0, 0, 0, si * x, si * y, si * z, math.cos(m / 2))
	else
		return CFrame.new()
	end
end

function Reload()
	if PlayerState.IsUnderLauncher then
		if WeaponData.Type == "Gun" and StoredUnderBarrelAmmo > 0 and (UnderBarrelAmmo < WeaponData.UBAmmo) then
			PlayerState.mouse1down = false
			PlayerState.reloading = true
			PlayerState.SafeMode = false
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			UpdateGui()
			UnderBarrelReloadAnim()
			if (UnderBarrelAmmo - (WeaponData.UBAmmo - StoredUnderBarrelAmmo)) < 0 then
				UnderBarrelAmmo = UnderBarrelAmmo + StoredUnderBarrelAmmo
				StoredUnderBarrelAmmo = 0

			elseif UnderBarrelAmmo <= 0 then
				StoredUnderBarrelAmmo = StoredUnderBarrelAmmo - (WeaponData.UBAmmo - UnderBarrelAmmo)
				UnderBarrelAmmo = WeaponData.UBAmmo

			elseif UnderBarrelAmmo > 0 and WeaponData.IncludeChamberedBullet then
				StoredUnderBarrelAmmo = StoredUnderBarrelAmmo - (WeaponData.UBAmmo - UnderBarrelAmmo) - 1
				UnderBarrelAmmo = WeaponData.UBAmmo + 1

			elseif UnderBarrelAmmo > 0 and not WeaponData.IncludeChamberedBullet then
				StoredUnderBarrelAmmo = StoredAmmo - (WeaponData.UBAmmo - UnderBarrelAmmo)
				UnderBarrelAmmo = WeaponData.UBAmmo
			end
			PlayerState.CancelReload = false
			PlayerState.reloading = false
			RunCheck()
			UpdateGui()
			ChainGun()
		end
	else
		if WeaponData.Type == "Gun" and StoredAmmo > 0 and (Ammo < WeaponData.Ammo) then
			PlayerState.mouse1down = false
			PlayerState.reloading = true

			PlayerState.SafeMode = false
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			UpdateGui()
			if WeaponData.ShellInsert then
				if Ammo > 0 then
					for i = 1,WeaponData.Ammo - Ammo do
						if StoredAmmo > 0 and Ammo < WeaponData.Ammo then
							if PlayerState.CancelReload then
								IdleAnim()
								break
							end
							ReloadAnim()
							Ammo = Ammo + 1
							StoredAmmo = StoredAmmo - 1
							UpdateGui()
						end
					end
				else
					TacticalReloadAnim()
					Ammo = Ammo + 1
					StoredAmmo = StoredAmmo - 1
					UpdateGui()
					for i = 1,WeaponData.Ammo - Ammo do
						if StoredAmmo > 0 and WeaponData and Ammo < WeaponData.Ammo then
							if PlayerState.CancelReload then
								IdleAnim()
								break
							end
							ReloadAnim()
							Ammo = Ammo + 1
							StoredAmmo = StoredAmmo - 1
							UpdateGui()
						end
					end

				end
			else
				if Ammo > 0 then
					ReloadAnim()
				else
					TacticalReloadAnim()
				end

				if (Ammo - (WeaponData.Ammo - StoredAmmo)) < 0 then
					Ammo = Ammo + StoredAmmo
					StoredAmmo = 0

				elseif Ammo <= 0 then
					StoredAmmo = StoredAmmo - (WeaponData.Ammo - Ammo)
					Ammo = WeaponData.Ammo

				elseif Ammo > 0 and WeaponData.IncludeChamberedBullet then
					StoredAmmo = StoredAmmo - (WeaponData.Ammo - Ammo) - 1
					Ammo = WeaponData.Ammo + 1

				elseif Ammo > 0 and not WeaponData.IncludeChamberedBullet then
					StoredAmmo = StoredAmmo - (WeaponData.Ammo - Ammo)
					Ammo = WeaponData.Ammo
				end
			end
			PlayerState.CancelReload = false
			PlayerState.reloading = false
			RunCheck()
			UpdateGui()
			ChainGun()
		end
	end
end

function CheckForKnockedTeammate()
	local rayOrigin = cam.CFrame.Position
	local rayDirection = cam.CFrame.LookVector * 15

	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = Ignore_Model
	raycastParams.FilterType = Enum.RaycastFilterType.Exclude

	local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)

	if raycastResult and raycastResult.Instance then
		local hit = raycastResult.Instance
		local targetChar = hit.Parent

		if targetChar and targetChar:FindFirstChild("Humanoid") then
			local targetPlayer = game.Players:GetPlayerFromCharacter(targetChar)

			if targetPlayer and targetPlayer.Team == plr.Team and targetPlayer ~= plr then
				local targetClient = targetChar:FindFirstChild("Client")
				if targetClient and targetClient:GetAttribute("Knocked") then
					return true, targetPlayer
				end
			end
		end
	end

	return false, nil
end

function SetupKnockedState()
	if not KnockedUI then
		KnockedUI = HUDs.KnockedUI:Clone()
		KnockedUI.Parent = plr.PlayerGui
	end
	plr.CameraMode = Enum.CameraMode.LockFirstPerson
	plr.CameraMaxZoomDistance = 0.5
	plr.CameraMinZoomDistance = 0.5

	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = 0
		char.Humanoid.JumpPower = 0
	end

	KnockedUI.Enabled = true

	task.spawn(function()
		while Game_Client:GetAttribute("Knocked") do
			task.wait(0.05)

			local bleedoutTime = Game_Client:GetAttribute("BleedoutTime") or 0
			local beingRevived = Game_Client:GetAttribute("BeingRevived") or false
			local reviveProgress = Game_Client:GetAttribute("ReviveProgress") or 0

			if KnockedUI then
				KnockedUI.Frame.BleedoutTimer.Text = string.format("%.1f", bleedoutTime)
				local maxBleedoutTime = 30
				KnockedUI.Frame.BleedoutBar.Fill.Size = UDim2.new(bleedoutTime / maxBleedoutTime, 0, 1, 0)

				if beingRevived then
					KnockedUI.Frame.ReviveBar.Visible = true
					KnockedUI.Frame.ReviveBar.Fill.Size = UDim2.new(reviveProgress, 0, 1, 0)
					KnockedUI.Frame.Instructions.Text = "Being revived..."
					KnockedUI.Frame.NearestMedic.Visible = false
				else
					KnockedUI.Frame.ReviveBar.Visible = false
					KnockedUI.Frame.Instructions.Text = "Hold E to bleed out faster\nWait for teammate to revive"
					KnockedUI.Frame.NearestMedic.Visible = true
					if tick() - lastMedicUpdate > MEDIC_UPDATE_INTERVAL then
						lastMedicUpdate = tick()
						UpdateNearestMedic()
					end
				end
			end
		end

		if KnockedUI then
			KnockedUI.Enabled = false
		end
		plr.CameraMode = Enum.CameraMode.LockFirstPerson
		plr.CameraMaxZoomDistance = 128
		plr.CameraMinZoomDistance = 0.5
	end)
end

function UpdateNearestMedic()
	if not KnockedUI or not KnockedUI.Frame:FindFirstChild("NearestMedic") then return end
	local nearestDistance = math.huge
	local foundMedic = false

	for _, player in pairs(game.Players:GetPlayers()) do
		if player ~= plr and player.Team == plr.Team then
			if player.PlayerData and player.PlayerData.Classes then
				local currentClass = player.PlayerData.Classes.CurrentClass.Value
				if currentClass == "Medic" then
					if player.Character and player.Character:FindFirstChild("Head") then
						local distance = (player.Character.Head.Position - char.Head.Position).Magnitude
						if distance < nearestDistance then
							nearestDistance = distance
							foundMedic = true
						end
					end
				end
			end
		end
	end
	if foundMedic then
		KnockedUI.Frame.NearestMedic.Text = string.format("Nearest Medic: %.0fm", nearestDistance)
		KnockedUI.Frame.NearestMedic.TextColor3 = nearestDistance < 50 and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 255, 0)
	else
		KnockedUI.Frame.NearestMedic.Text = "No Medics Nearby"
		KnockedUI.Frame.NearestMedic.TextColor3 = Color3.fromRGB(255, 0, 0)
	end
end

local CurrentBarrelRotation = 0

function GunFx()
	local Muzzle = WeaponInHand.Handle.Muzzle

	if WeaponData.ShootType == 4 or WeaponData.ShootType == 5 or WeaponData.ShootType == 8 then
		PlayerState.canPump = true
	end

	ConsecutiveShotCount = ConsecutiveShotCount + 1
	local shotVolumeMultiplier = 1.0
	if ConsecutiveShotCount == 1 then
		shotVolumeMultiplier = 1.6
	elseif ConsecutiveShotCount == 2 then
		shotVolumeMultiplier = 1.3
	else
		shotVolumeMultiplier = 1.0
	end
	if not PlayerState.mouse1down and ConsecutiveShotCount > 1 then
		shotVolumeMultiplier = 1.5
		LastShotLoud = true
	end
	if Muzzle:FindFirstChild("Echo") then
		local newSound = Muzzle.Echo:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireEcho"
		if PlayerState.Suppressor then
			if Muzzle:FindFirstChild("Suppressed") then
				newSound.SoundId = Muzzle.Suppressed.SoundId
			end
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
			newSound.EqualizerSoundEffect.HighGain = 10
			newSound.EqualizerSoundEffect.LowGain = -10
			newSound.EqualizerSoundEffect.MidGain = -5
		end
		newSound.Volume = newSound.Volume * shotVolumeMultiplier
		newSound:Play()

		newSound.Ended:Connect(function()
			newSound:Destroy()
		end)
	end
	if Muzzle:FindFirstChild("Bass") then
		local newSound = Muzzle.Bass:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireBass"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume/2
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		newSound.Volume = newSound.Volume * shotVolumeMultiplier
		newSound:Play()

		newSound.Ended:Connect(function()
			newSound:Destroy()
		end)
	end
	if Muzzle:FindFirstChild("ADSDisconnect") then
		local newSound = Muzzle.ADSDisconnect:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireADSDisconnect"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume/2
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		newSound.Volume = newSound.Volume * shotVolumeMultiplier

		newSound.PlayOnRemove = true
		newSound:Destroy()
	end
	if Muzzle:FindFirstChild("ADSMech") then
		local newSound = Muzzle.ADSMech:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireADSMech"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume/2
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		local magEmptyPercent = 1 - (Ammo / WeaponData.Ammo)
		local adsMechVolumeMultiplier = 1.0 + (magEmptyPercent * 0.5)
		newSound.Volume = newSound.Volume * adsMechVolumeMultiplier

		newSound:Play()

		newSound.Ended:Connect(function()
			newSound:Destroy()
		end)
	end
	if PlayerState.Suppressor then
		local newSound = Muzzle.Fire1:Clone()
		newSound.Parent = Muzzle
		newSound.Volume = newSound.Volume * shotVolumeMultiplier
		local EqualizerSoundEffect= Instance.new("EqualizerSoundEffect",newSound)
		EqualizerSoundEffect.HighGain = 5
		EqualizerSoundEffect.LowGain = -5
		EqualizerSoundEffect.MidGain = -2
		newSound.Name = "Firing"
		newSound.PlayOnRemove = true
		newSound:Destroy()
		if ((Ammo/WeaponData.Ammo)*100) <= 15 then
			local newSound = Muzzle.Low:Clone()
			newSound.PlaybackSpeed = newSound.PlaybackSpeed + (WeaponData.Ammo-Ammo)/500
			newSound.Parent = Muzzle
			newSound.Name = "Firing"
			newSound.Volume = newSound.Volume * shotVolumeMultiplier
			newSound:Play()

			newSound.Ended:Connect(function()
				newSound:Destroy()
			end)
		end
	else
		local newSound = Muzzle.Fire1:Clone()

		newSound.Parent = Muzzle
		newSound.Name = "Firing"
		newSound.Volume = newSound.Volume * shotVolumeMultiplier

		if Ammo == 0 then
			newSound.PlaybackSpeed = newSound.PlaybackSpeed * 1.1
		end
		newSound:Play()

		newSound.Ended:Connect(function()
			newSound:Destroy()
		end)

		if ((Ammo/WeaponData.Ammo)*100) <= 15 then
			local newSound = Muzzle.Low:Clone()
			newSound.PlaybackSpeed = newSound.PlaybackSpeed + (WeaponData.Ammo-Ammo)/500
			newSound.Parent = Muzzle
			newSound.Name = "Firing"
			newSound.Volume = newSound.Volume * shotVolumeMultiplier
			newSound:Play()

			newSound.Ended:Connect(function()
				newSound:Destroy()
			end)
		end
	end
	if Muzzle:FindFirstChild("FlashFX") then
		Muzzle["FlashFX"].Enabled = true
		task.delay(0.05,function()
			if Muzzle:FindFirstChild("FlashFX") then
				Muzzle["FlashFX"].Enabled = false
			end
		end)
	end
	Muzzle["FlashFX[Flash]"]:Emit(math.random(5,10))
	if Muzzle:FindFirstChild("FlashFX[Right]") then
		Muzzle["FlashFX[Right]"]:Emit(math.random(5,10))
	end
	if Muzzle:FindFirstChild("FlashFX[Left]") then
		Muzzle["FlashFX[Left]"]:Emit(math.random(5,10))
	end
	Muzzle["Smoke"]:Emit(math.random(20,30))
	if Muzzle:FindFirstChild("Smoke2") then
		Muzzle["Smoke2"]:Emit(math.random(20,30))
	end
	if Muzzle:FindFirstChild("Smoke3") then
		Muzzle["Smoke3"]:Emit(math.random(20,30))
	end
	if BSpread then
		local stepAmount = ArchetypeData._calculatedStepAmount or ArchetypeData.AimInaccuracyStepAmount
		BSpread = math.min((ArchetypeData.MaxSpread * 1.6) * ModTable.MaxSpread, BSpread + stepAmount * ModTable.AimInaccuracyStepAmount)
		RecoilPower = math.min(ArchetypeData.MaxRecoilPower * ModTable.MaxRecoilPower, RecoilPower + ArchetypeData.RecoilPowerStepAmount * ModTable.RecoilPowerStepAmount)
	end
	generateBullet = generateBullet + 1
	LastSpreadUpdate = time()
	if WeaponData.BarrelSpins then
		local AdditionalRotation = 360 / WeaponData.BarrelCount
		local NextRotation = CurrentBarrelRotation + AdditionalRotation
		CurrentBarrelRotation = NextRotation
		TS:Create(WeaponInHand.Handle.Barrels, TweenInfo.new(0.2,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,false,0), {C1 = CFrame.Angles(0,0, -math.rad(NextRotation)):Inverse() }):Play()	
	end
	local slideSpeed = WeaponData.SlideSpeed

	if Ammo > 0 or not WeaponData.SlideLock then
		TS:Create( WeaponInHand.Handle.Slide, TweenInfo.new(slideSpeed/WeaponData.ShootRate,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,true,0), {C0 =  WeaponData.SlideEx:inverse() }):Play()
	elseif Ammo <= 0 and WeaponData.SlideLock then
		TS:Create( WeaponInHand.Handle.Slide, TweenInfo.new(slideSpeed/WeaponData.ShootRate,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,false,0), {C0 =  WeaponData.SlideEx:inverse() }):Play()
	end
	WeaponInHand.Handle.Chamber.Smoke:Emit(math.random(10,30))
	for _, effect in pairs(WeaponInHand.Handle.Chamber:GetChildren()) do
		if effect.Name == "Shell" then
			effect:Emit(1)
		end
	end
	ChainGun()
end

function UnderBarrelGunFx()
	local Muzzle = WeaponInHand.Handle.GrenadeMuzzle

	if WeaponData.ShootType == 4 or WeaponData.ShootType == 5 or WeaponData.ShootType == 8 then
		PlayerState.canPump = true
	end

	if PlayerState.Suppressor then
		local newSound = Muzzle["Fire"..math.random(1,3)]:Clone()
		newSound.Parent = Muzzle
		newSound.Volume = newSound.Volume * 1.5
		newSound.PlaybackSpeed = newSound.PlaybackSpeed * 1.5
		local EqualizerSoundEffect= Instance.new("EqualizerSoundEffect",newSound)
		EqualizerSoundEffect.HighGain = 10
		EqualizerSoundEffect.LowGain = -10
		EqualizerSoundEffect.MidGain = -5
		newSound.Name = "Firing"
		newSound:Play()
		newSound.PlayOnRemove = true
		newSound:Destroy()
		if ((Ammo/WeaponData.Ammo)*100) <= 15 then
			local newSound = Muzzle.Low:Clone()
			newSound.PlaybackSpeed = newSound.PlaybackSpeed + (WeaponData.Ammo-Ammo)/500
			newSound.Parent = Muzzle
			newSound.Name = "Firing"
			newSound:Play()
			newSound.PlayOnRemove = true
			newSound:Destroy()
		end
	else
		local newSound
		if Ammo == 0 then
			newSound = Muzzle["FireLast"]:Clone()
		else
			newSound = Muzzle["Fire"..math.random(1,3)]:Clone()
		end

		newSound.Parent = Muzzle
		newSound.Name = "Firing"
		newSound:Play()
		newSound.PlayOnRemove = true
		newSound:Destroy()
		if ((Ammo/WeaponData.Ammo)*100) <= 15 then
			local newSound = Muzzle.Low:Clone()
			newSound.PlaybackSpeed = newSound.PlaybackSpeed + (WeaponData.Ammo-Ammo)/500
			newSound.Parent = Muzzle
			newSound.Name = "Firing"
			newSound:Play()
			newSound.PlayOnRemove = true
			newSound:Destroy()
		end
	end
	if Muzzle:FindFirstChild("Echo") then
		local newSound = Muzzle.Echo:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireEcho"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume/2
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
			newSound.EqualizerSoundEffect.HighGain = 10
			newSound.EqualizerSoundEffect.LowGain = -10
			newSound.EqualizerSoundEffect.MidGain = -5
		end
		newSound:Play()
		newSound.PlayOnRemove = true
		newSound:Destroy()
	end
	if Muzzle:FindFirstChild("Bass") then
		local newSound = Muzzle.Bass:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireBass"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		newSound:Play()
		newSound.PlayOnRemove = true
		newSound:Destroy()
	end

	if Muzzle:FindFirstChild("ADSDisconnect") then

		local newSound = Muzzle.ADSDisconnect:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireADSDisconnect"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		newSound:Play()

		newSound.PlayOnRemove = true
		newSound:Destroy()
	end
	if Muzzle:FindFirstChild("ADSMech") then
		local newSound = Muzzle.ADSMech:Clone()
		newSound.Parent = Muzzle
		newSound.Name = "FireADSMech"
		if PlayerState.Suppressor then
			newSound.Volume = newSound.Volume
			newSound.PlaybackSpeed = newSound.PlaybackSpeed*1.5
		end
		newSound:Play()
		newSound.PlayOnRemove = true
		newSound:Destroy()
	end
	if Muzzle:FindFirstChild("FlashFX") then
		Muzzle["FlashFX"].Enabled = true
		task.delay(0.05,function()
			if Muzzle:FindFirstChild("FlashFX") then
				Muzzle["FlashFX"].Enabled = false
			end
		end)
	end
	Muzzle["FlashFX[Flash]"]:Emit(math.random(5,10))
	if Muzzle:FindFirstChild("FlashFX[Right]") then
		Muzzle["FlashFX[Right]"]:Emit(math.random(5,10))
	end
	if Muzzle:FindFirstChild("FlashFX[Left]") then
		Muzzle["FlashFX[Left]"]:Emit(math.random(5,10))
	end
	Muzzle["Smoke"]:Emit(math.random(20,30))
	if Muzzle:FindFirstChild("Smoke2") then
		Muzzle["Smoke2"]:Emit(math.random(20,30))
	end
	if Muzzle:FindFirstChild("Smoke3") then
		Muzzle["Smoke3"]:Emit(math.random(20,30))
	end

	if BSpread then
		BSpread = math.min((ArchetypeData.MaxSpread * 1.6) * ModTable.MaxSpread, BSpread + ArchetypeData.AimInaccuracyStepAmount * ModTable.AimInaccuracyStepAmount)
		RecoilPower =  math.min(ArchetypeData.MaxRecoilPower * ModTable.MaxRecoilPower, RecoilPower + ArchetypeData.RecoilPowerStepAmount * ModTable.RecoilPowerStepAmount)
	end

	generateBullet = generateBullet + 1
	LastSpreadUpdate = time()

	if WeaponData.BarrelSpins then
		local AdditionalRotation = 360 / WeaponData.BarrelCount
		local NextRotation = CurrentBarrelRotation + AdditionalRotation
		CurrentBarrelRotation = NextRotation
		TS:Create(WeaponInHand.Handle.Barrels, TweenInfo.new(0.2,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,false,0), {C1 = CFrame.Angles(0,0, -math.rad(NextRotation)):Inverse() }):Play()	
	end
	local slideSpeed = WeaponData.SlideSpeed

	if Ammo > 0 or not WeaponData.SlideLock then
		TS:Create( WeaponInHand.Handle.Slide, TweenInfo.new(slideSpeed/WeaponData.ShootRate,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,true,0), {C0 =  WeaponData.SlideEx:inverse() }):Play()
	elseif Ammo <= 0 and WeaponData.SlideLock then
		TS:Create( WeaponInHand.Handle.Slide, TweenInfo.new(slideSpeed/WeaponData.ShootRate,Enum.EasingStyle.Linear,Enum.EasingDirection.InOut,0,false,0), {C0 =  WeaponData.SlideEx:inverse() }):Play()
	end

	WeaponInHand.Handle.Chamber.Smoke:Emit(math.random(10,30))

	for _, effect in pairs(WeaponInHand.Handle.Chamber:GetChildren()) do
		if effect.Name == "Shell" then
			effect:Emit(1)
		end
	end
	ChainGun()
end

function ShellCheck()
	if WeaponData.ShellEjectionMod and WeaponData.ShootType < 4 then
		if Engine.AmmoModels:FindFirstChild(ArchetypeData.BulletType) then
			CreateShell(ArchetypeData.BulletType,WeaponInHand.Handle.Chamber)
		else
			CreateShell("Default",WeaponInHand.Handle.Chamber)
		end
	end
end


function VibrateController()
	if UIS:GetGamepadConnected(Enum.UserInputType.Gamepad1) then
		if HapticService:IsMotorSupported(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large) then
			HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0.5*WeaponData.RecoilMod)
		end
		if HapticService:IsMotorSupported(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small) then
			HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small, 0.5*WeaponData.RecoilMod)
		end
	end
end

function UnVibrateController()
	if UIS:GetGamepadConnected(Enum.UserInputType.Gamepad1) then
		if HapticService:IsMotorSupported(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large) then
			HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Large, 0)
		end
		if HapticService:IsMotorSupported(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small) then
			HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small, 0)
		end
	end
end

function InjectStim(Effect)
	if Effect == "Health" then
		PlayerState.AnimDebounce = false
		pcall(function()
			AnimData.InjectStimSelf({
				RArmWeld,
				LArmWeld,
				GunWeld,
				WeaponInHand,
				ViewModel,
			})
		end)
		PlayerState.AnimDebounce = true

		local healthToAdd = 50
		local duration = 1
		local steps = 20
		local healthPerStep = healthToAdd / steps
		local waitTime = duration / steps

		PlayerState.stimActive = true

		local currentStimTool = WeaponTool

		for i = 1, steps do
			if WeaponTool ~= currentStimTool or not WeaponTool or WeaponData.Type ~= "Stim" then
				PlayerState.stimActive = false
				break
			end
			if Humanoid.Health > 0 and Humanoid.Health < Humanoid.MaxHealth then
				Humanoid.Health = math.min(Humanoid.Health + healthPerStep, Humanoid.MaxHealth)
			end

			task.wait(waitTime)
		end
		PlayerState.stimActive = false
		IdleAnim()
	elseif Effect == "Stamina" then
		PlayerState.AnimDebounce = false
		pcall(function()
			AnimData.InjectStimSelf({
				RArmWeld,
				LArmWeld,
				GunWeld,
				WeaponInHand,
				ViewModel,
			})
		end)
		PlayerState.AnimDebounce = true

		local staminaToAdd = 500
		local duration = 1
		local steps = 20
		local staminaPerStep = staminaToAdd / steps
		local waitTime = duration / steps

		PlayerState.stimActive = true
		local currentStimTool = WeaponTool

		for i = 1, steps do
			if WeaponTool ~= currentStimTool or not WeaponTool or WeaponData.Type ~= "Stim" then
				PlayerState.stimActive = false
				break
			end

			local currentStamina = Game_Client:GetAttribute("Stamina") or 0
			if currentStamina < 1000 then
				Game_Client:SetAttribute("Stamina", math.min(currentStamina + staminaPerStep, 1000))
			end
			task.wait(waitTime)
		end
		PlayerState.stimActive = false
		IdleAnim()
	end
end

function InjectOther(targetPlayer)
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.InjectStimOther({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.AnimDebounce = true

	local healthToAdd = 50
	local duration = 1
	local steps = 20
	local healthPerStep = healthToAdd / steps
	local waitTime = 0.1

	PlayerState.stimActive = true
	Evt.ReviveTeammate:FireServer(targetPlayer, PlayerState.stimActive)
	PlayerState.IsReviving = true
	ReviveTarget = targetPlayer

	local currentStimTool = WeaponTool

	for i = 1, steps do
		if WeaponTool ~= currentStimTool or not WeaponTool or WeaponData.Type ~= "Stim" then
			PlayerState.stimActive = false
			break
		end

		task.wait(waitTime)
	end
	PlayerState.stimActive = false
	IdleAnim()
end

function Shoot()
	if WeaponData and WeaponData.Type == "Gun" and not PlayerState.shooting and not PlayerState.reloading then

		if PlayerState.reloading or PlayerState.runKeyDown or PlayerState.SafeMode or PlayerState.CheckingMag then
			PlayerState.mouse1down = false
			return
		end

		if Ammo <= 0 then
			WeaponInHand.Handle.Click:Play()
			PlayerState.mouse1down = false
			RecoilSpring:accelerate(Vector3.new(-.3, 0, RAND(-1, 1, .1) * .8))
			return
		end

		PlayerState.mouse1down = true

		task.delay(0, function()
			if PlayerState.IsUnderLauncher == true then
				if UnderBarrelAmmo <= 0 then
					return
				end
				PlayerState.shooting = true	
				Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
				ShellCheck()
				for _ =  1, UnderBarrelData.Bullets do
					task.spawn(CreateUnderBarrelBullet)
				end
				UnderBarrelAmmo -= 1
				UnderBarrelGunFx()
				UpdateGui()
				task.spawn(UnderBarrelRecoil)
				VibrateController()
				task.wait(60/WeaponData.ShootRate)
				PlayerState.shooting = false
				UnVibrateController()
				return
			else
				if ArchetypeData and WeaponData.ShootType == 1 then 
					PlayerState.shooting = true	
					Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
					ShellCheck()
					for _ =  1, AmmoData.Bullets do
						task.spawn(CreateBullet)
					end
					Ammo = Ammo - 1
					GunFx()
					UpdateGui()
					task.spawn(Recoil)
					VibrateController()
					task.wait(60/WeaponData.ShootRate)
					PlayerState.shooting = false
					UnVibrateController()

				elseif ArchetypeData and WeaponData.ShootType == 2 then
					for i = 1, ArchetypeData.BurstShot do
						if i == ArchetypeData.BurstShot then
							if PlayerState.shooting or Ammo <= 0 then
								break
							end
							PlayerState.shooting = true	
							Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
							ShellCheck()
							for _ =  1, AmmoData.Bullets do
								task.spawn(CreateBullet)
							end
							Ammo = Ammo - 1
							GunFx()
							UpdateGui()
							task.spawn(Recoil)
							VibrateController()
							task.wait(240/WeaponData.ShootRate)
							PlayerState.shooting = false
							UnVibrateController()
						else
							if PlayerState.shooting or Ammo <= 0 then
								break
							end
							PlayerState.shooting = true	
							Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
							ShellCheck()
							for _ =  1, AmmoData.Bullets do
								task.spawn(CreateBullet)
							end
							Ammo = Ammo - 1
							GunFx()
							UpdateGui()
							task.spawn(Recoil)
							VibrateController()
							task.wait(60/WeaponData.ShootRate)
							PlayerState.shooting = false
							UnVibrateController()
						end
					end
				elseif ArchetypeData and WeaponData.ShootType == 3 and WeaponData.WeaponType == "Light Machine Gun" then
					PlayerState.shooting = true
					task.wait(0.06)

					if not PlayerState.mouse1down then
						PlayerState.shooting = false
						return
					end
					local targetFireRate = WeaponData.ShootRate
					local rampUpDuration = 0.8
					local rampUpStartTime = tick()
					local minFireRateMultiplier = 0.7

					while PlayerState.mouse1down do
						if Ammo <= 0 then
							break
						end
						local elapsedTime = tick() - rampUpStartTime
						local rampProgress = math.min(elapsedTime / rampUpDuration, 1)
						local currentFireRateMultiplier = minFireRateMultiplier + (1 - minFireRateMultiplier) * rampProgress
						local currentFireRate = targetFireRate * currentFireRateMultiplier

						Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
						ShellCheck()
						for _ =  1, AmmoData.Bullets do
							task.spawn(CreateBullet)
						end
						Ammo = Ammo - 1
						GunFx()
						UpdateGui()
						task.spawn(Recoil)
						VibrateController()
						task.wait(60/currentFireRate)
						UnVibrateController()
					end
					PlayerState.shooting = false
				elseif ArchetypeData and WeaponData.ShootType == 3 then
					while PlayerState.mouse1down do
						if PlayerState.shooting or Ammo <= 0 then
							break
						end
						PlayerState.shooting = true	
						Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
						ShellCheck()
						for _ =  1, AmmoData.Bullets do
							task.spawn(CreateBullet)
						end
						Ammo = Ammo - 1
						GunFx()
						UpdateGui()
						task.spawn(Recoil)
						VibrateController()
						task.wait(60/WeaponData.ShootRate)
						PlayerState.shooting = false
						UnVibrateController()
					end
				elseif ArchetypeData and WeaponData.ShootType == 4 or ArchetypeData and WeaponData.ShootType == 5 then
					PlayerState.shooting = true	
					Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
					for _ =  1, AmmoData.Bullets do
						task.spawn(CreateBullet)
					end
					Ammo = Ammo - 1
					GunFx()
					UpdateGui()
					Thread:Spawn(Recoil)
					VibrateController()
					PumpAnim()
					task.wait(60/WeaponData.ShootRate)
					UnVibrateController()
					RunCheck()
					PlayerState.shooting = false
				elseif ArchetypeData and WeaponData.ShootType == 8 then
					while PlayerState.mouse1down do
						if PlayerState.shooting or Ammo <= 0 then
							break
						end
						PlayerState.shooting = true	
						Evt.Atirar:FireServer(WeaponTool,PlayerState.Suppressor,PlayerState.FlashHider,WeaponInHand.Handle.Muzzle.WorldPosition)
						for _ =  1, AmmoData.Bullets do
							task.spawn(CreateBullet)
						end
						Ammo = Ammo - 1
						GunFx()
						UpdateGui()
						Thread:Spawn(Recoil)
						VibrateController()
						task.wait(15/WeaponData.ShootRate)
						if Ammo > 0 then
							PumpAnim()
						end
						UnVibrateController()
						RunCheck()
						PlayerState.shooting = false
					end
				end



				if ArchetypeData and ArchetypeData.IsLauncher then
					Evt.RepAmmo:FireServer(WeaponTool,Ammo,StoredAmmo)
				end
			end
		end)
	elseif WeaponData and WeaponData.Type == "Melee" and not PlayerState.runKeyDown then
		if not PlayerState.shooting then
			PlayerState.shooting = true
			
			meleeAttack()
			RunCheck()
			PlayerState.shooting = false
		end
	elseif WeaponData and WeaponData.Type == "Stim" and not PlayerState.runKeyDown then
		if not PlayerState.shooting and Ammo > 0 then
			PlayerState.shooting = true
			Ammo -= 1
			task.spawn(function()
				InjectStim(WeaponData.Effect)
				task.wait(0.1)
				PlayerState.shooting = false
			end)
			UpdateGui()
		end
	elseif WeaponData and WeaponData.Type == "Drone" and not PlayerState.runKeyDown then
		if not PlayerState.shooting then
			PlayerState.shooting = true
			activeDroneType = WeaponTool.Name
			PlayerState.droneSpawned = true
			task.spawn(function()
				char.DroneName.Value = WeaponTool.Name
				unset()
				Humanoid:UnequipTools()
				char.DroneController.Enabled = true

				script.Enabled = false
			end)
			UpdateGui()
		end
	elseif WeaponData and WeaponData.Type == "Ammo" and not PlayerState.shooting then
		if Ammo > 0 then
			PlayerState.shooting = true
			Ammo -= 1

			ThrowSupplyBox()

			local throwOrigin = WeaponInHand.Handle.Position
			local throwDirection = cam.CFrame.LookVector

			Evt.ThrowSupplyBox:FireServer(WeaponTool, throwOrigin, throwDirection)

			UpdateGui()

			task.wait(1)
			PlayerState.shooting = false
		end
	end
end

function reenterDroneControl()
	if not PlayerState.droneSpawned then return end
	if not WeaponTool or WeaponData.Type ~= "Drone" then return end
	
	local existingDrone = Game_Workspace.Drones:FindFirstChild(plr.Name .. "'s Drone")
	if not existingDrone then
		PlayerState.droneSpawned = false
		return
	end
	local droneInfo = existingDrone:FindFirstChild("Info")
	if droneInfo and droneInfo:FindFirstChild("Terminal") and droneInfo.Terminal.Value then
		return
	end
	Humanoid:UnequipTools()
	char.DroneController.Enabled = true
	script.Enabled = false
end




local L_150_ = {}

local LeanSpring = {}
LeanSpring.cornerPeek = SpringMod.new(0)
LeanSpring.cornerPeek.d = 1
LeanSpring.cornerPeek.s = 20
LeanSpring.peekFactor = math.rad(-15)
LeanSpring.dirPeek = 0

function L_150_.Update()

	LeanSpring.cornerPeek.t = LeanSpring.peekFactor * Virar
	local NewLeanCF = CFrame.fromAxisAngle(Vector3.new(0, 0, 1), LeanSpring.cornerPeek.p)
	cam.CFrame = cam.CFrame * NewLeanCF
end

game:GetService("RunService"):BindToRenderStep("Camera Update", 200, L_150_.Update)

function RunCheck()
	if PlayerState.runKeyDown then
		PlayerState.mouse1down = false
		GunStance = 3
		Evt.GunStance:FireServer(GunStance,AnimData)
		SprintAnim()
	else
		if PlayerState.aimming then
			GunStance = 2
			Evt.GunStance:FireServer(GunStance,AnimData)
		else
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
		end
		if not PlayerState.reloading then
			IdleAnim()
		end
	end
end

function Stand()
	Stance:FireServer(Stances,Virar)
	TS:Create(char.Humanoid, TweenInfo.new(.3), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()

	SE_GUI.MainFrame.Poses.Levantado.Visible = true
	SE_GUI.MainFrame.Poses.Agaixado.Visible = false
	SE_GUI.MainFrame.Poses.Deitado.Visible = false

	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, true)

	if BipodTable.BipodActive then
		RetractBipod()
	end
end

function Crouch()
	Stance:FireServer(Stances,Virar)
	TS:Create(char.Humanoid, TweenInfo.new(.3), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()

	SE_GUI.MainFrame.Poses.Levantado.Visible = false
	SE_GUI.MainFrame.Poses.Agaixado.Visible = true
	SE_GUI.MainFrame.Poses.Deitado.Visible = false

	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)

	if BipodTable.BipodActive then
		RetractBipod()
	end
end

function Prone()
	Stance:FireServer(Stances,Virar)
	TS:Create(char.Humanoid, TweenInfo.new(.9), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()

	SE_GUI.MainFrame.Poses.Levantado.Visible = false
	SE_GUI.MainFrame.Poses.Agaixado.Visible = false
	SE_GUI.MainFrame.Poses.Deitado.Visible = true

	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)

	if BipodTable.IsBipod and not BipodTable.BipodActive then
		local hasContact, pos, normal = CheckBipodSurface()
		if hasContact then
			PlayerState.BipodSurfaceContact = true
			PlayerState.BipodPosition = pos
			PlayerState.BipodNormal = normal
			DeployBipod()
		end
	end
end

function Slide()
	Stance:FireServer(Stances,Virar)
	TS:Create(char.Humanoid, TweenInfo.new(.3), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()
	SE_GUI.MainFrame.Poses.Levantado.Visible = false
	SE_GUI.MainFrame.Poses.Agaixado.Visible = true
	SE_GUI.MainFrame.Poses.Deitado.Visible = false
	SetWalkSpeed(gameRules.CrouchWalkSpeed)
	Evt.Slide:FireServer()
	local Direct = cam.CFrame.LookVector

	local DiveForce = Instance.new("LinearVelocity")
	DiveForce.Attachment0 = char.HumanoidRootPart.RootRigAttachment
	DiveForce.ForceLimitMode = Enum.ForceLimitMode.PerAxis
	DiveForce.MaxAxesForce = Vector3.new(1,0,1) * 50000
	DiveForce.VectorVelocity = Direct*CalcWalkSpeed(gameRules.RunWalkSpeed)*3
	DiveForce.RelativeTo = Enum.ActuatorRelativeTo.World
	DiveForce.Parent = char.HumanoidRootPart

	PlayerState.runKeyDown 	= false
	if WeaponData and ArchetypeData and not PlayerState.aimming then
		UpdateCrossHair("DeScope")
	end
	IdleAnim()

	TS:Create(DiveForce, TweenInfo.new(1.5), {VectorVelocity = Direct*CalcWalkSpeed(gameRules.CrouchWalkSpeed)} ):Play()

	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)
	PlayerState.Sliding = true
	wait(0.9)
	PlayerState.Sliding = false
	PlayerState.CanLean = true
	DiveForce:Destroy()
end

function DolphinDive()
	Stance:FireServer(Stances,Virar)
	TS:Create(char.Humanoid, TweenInfo.new(.4), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()

	SE_GUI.MainFrame.Poses.Levantado.Visible = false
	SE_GUI.MainFrame.Poses.Agaixado.Visible = false
	SE_GUI.MainFrame.Poses.Deitado.Visible = true

	SetWalkSpeed(gameRules.ProneWalksSpeed)

	Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)

	local Direct = cam.CFrame.LookVector

	local DiveForce = Instance.new("LinearVelocity")
	DiveForce.Attachment0 = char.HumanoidRootPart.RootRigAttachment
	DiveForce.ForceLimitMode = Enum.ForceLimitMode.PerAxis
	DiveForce.MaxAxesForce = Vector3.new(1,0,1) * 50000
	DiveForce.VectorVelocity = Direct*CalcWalkSpeed(gameRules.RunWalkSpeed)*1.75
	DiveForce.RelativeTo = Enum.ActuatorRelativeTo.World

	DiveForce.Parent = char.HumanoidRootPart

	PlayerState.runKeyDown 	= false
	if WeaponData and ArchetypeData and not PlayerState.aimming then
		UpdateCrossHair("DeScope")
	end
	IdleAnim()
	TS:Create(DiveForce, TweenInfo.new(1), {VectorVelocity = Direct*CalcWalkSpeed(gameRules.ProneWalksSpeed)} ):Play()

	PlayerState.Diving = true
	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, false)
	PlayerState.CanLean = true
	wait(0.75)
	PlayerState.Diving = false


	PlayerState.CanLean = false
	char.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping, true)
	DiveForce:Destroy()
end

function Lean()
	TS:Create(char.Humanoid, TweenInfo.new(.5), {CameraOffset = Vector3.new(CameraX,CameraY,char.Humanoid.CameraOffset.Z)} ):Play()
	Stance:FireServer(Stances,Virar)

	if Virar == 0 then
		SE_GUI.MainFrame.Poses.Esg_Left.Visible = false
		SE_GUI.MainFrame.Poses.Esg_Right.Visible = false
	elseif Virar == 1 then
		SE_GUI.MainFrame.Poses.Esg_Left.Visible = false
		SE_GUI.MainFrame.Poses.Esg_Right.Visible = true
	elseif Virar == -1 then
		SE_GUI.MainFrame.Poses.Esg_Left.Visible = true
		SE_GUI.MainFrame.Poses.Esg_Right.Visible = false
	end
end

mouse.WheelBackward:Connect(function()
	PlayerState.mouse1down = false
	local tool = plr.Backpack:FindFirstChildWhichIsA("Tool")
	if not tool then
		return
	end
	Humanoid:EquipTool(tool)
	lastSwapTime = tick()
	swapUIActive = true
	for i,v in pairs(SE_GUI.GunHUD.Selection:GetDescendants()) do
		if v:IsA("TextLabel") then
			TS:Create(v,TweenInfo.new(0.5),{TextTransparency = 0.5}):Play()
			TS:Create(v,TweenInfo.new(0.5),{TextStrokeTransparency = 0.8}):Play()
			v.FontFace.Bold = false
		end
	end
	if tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary.Value then
		local v = SE_GUI.GunHUD.Selection.Primary.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
		local v = SE_GUI.GunHUD.Selection.Primary.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	elseif tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary.Value then
		local v = SE_GUI.GunHUD.Selection.Secondary.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true	
		local v = SE_GUI.GunHUD.Selection.Secondary.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	elseif tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Kit.Value then
		local v = SE_GUI.GunHUD.Selection.Kit.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
		local v = SE_GUI.GunHUD.Selection.Kit.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	end
end)

mouse.WheelForward:Connect(function()
	PlayerState.mouse1down = false
	local tool = plr.Backpack:FindFirstChildWhichIsA("Tool")
	if not tool then
		return
	end
	Humanoid:EquipTool(tool)
	lastSwapTime = tick()
	swapUIActive = true
	for i,v in pairs(SE_GUI.GunHUD.Selection:GetDescendants()) do
		if v:IsA("TextLabel") then
			TS:Create(v,TweenInfo.new(0.5),{TextTransparency = 0.5}):Play()
			TS:Create(v,TweenInfo.new(0.5),{TextStrokeTransparency = 0.8}):Play()
			v.FontFace.Bold = false
		end
	end
	if tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Primary.Value then
		local v = SE_GUI.GunHUD.Selection.Primary.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
		local v = SE_GUI.GunHUD.Selection.Primary.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	elseif tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Secondary.Value then
		local v = SE_GUI.GunHUD.Selection.Secondary.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true	
		local v = SE_GUI.GunHUD.Selection.Secondary.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	elseif tool.Name == PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Kit.Value then
		local v = SE_GUI.GunHUD.Selection.Kit.Keybind
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
		local v = SE_GUI.GunHUD.Selection.Kit.Title
		TS:Create(v,TweenInfo.new(0.2),{TextTransparency = 0.2}):Play()
		TS:Create(v,TweenInfo.new(0.2),{TextStrokeTransparency = 0.7}):Play()
		v.FontFace.Bold = true
	end
end)

function EquipAnim()
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.EquipAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},1,cameraspring)
	end)
	PlayerState.AnimDebounce = true
end
function ThrowSupplyBox()
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.ThrowSupplyBox({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.AnimDebounce = true
end
function IdleAnim()
	if PlayerState.aimming == true and not PlayerState.reloading then
		if not PlayerState.IsUnderLauncher and UnderBarrelData and not UnderBarrelData.IsGrenadeLauncher and not UnderBarrelData.IsBipod then
			pcall(function()
				AnimData.AimGripAnim({
					RArmWeld,
					LArmWeld,
					GunWeld,
					WeaponInHand,
					ViewModel,
				})
			end)
		elseif UnderBarrelData and UnderBarrelData.IsGrenadeLauncher and not UnderBarrelData.IsBipod then
			pcall(function()
				AnimData.LauncherAnim({
					RArmWeld,
					LArmWeld,
					GunWeld,
					WeaponInHand,
					ViewModel,
				})
			end)

		else
			pcall(function()
				AnimData.AimAnim({
					RArmWeld,
					LArmWeld,
					GunWeld,
					WeaponInHand,
					ViewModel,
				})
			end)
		end

	else
		if UnderBarrelData and not UnderBarrelData.IsBipod then
			if PlayerState.IsUnderLauncher then
				pcall(function()
					AnimData.GrenadeUnderAnim({
						RArmWeld,
						LArmWeld,
						GunWeld,
						WeaponInHand,
						ViewModel,
					})
				end)
			elseif UnderBarrelData and not UnderBarrelData.IsGrenadeLauncher then
				pcall(function()
					AnimData.GripAnim({
						RArmWeld,
						LArmWeld,
						GunWeld,
						WeaponInHand,
						ViewModel,
					})
				end)
			elseif UnderBarrelData and UnderBarrelData.IsGrenadeLauncher then
				pcall(function()
					AnimData.LauncherAnim({
						RArmWeld,
						LArmWeld,
						GunWeld,
						WeaponInHand,
						ViewModel,
					})
				end)
			end
		else
			pcall(function()
				AnimData.IdleAnim({
					RArmWeld,
					LArmWeld,
					GunWeld,
					WeaponInHand,
					ViewModel,
				})
			end)
		end
		PlayerState.AnimDebounce = true
	end
end

function SprintAnim()
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.SprintAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function HighReady()
	pcall(function()
		AnimData.HighReady({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function LowReady()
	pcall(function()
		AnimData.LowReady({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function Patrol()
	pcall(function()
		AnimData.Patrol({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function BipodOpen()
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.BipodOpen({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.AnimDebounce = true
end
function BipodClose()
	PlayerState.AnimDebounce = false
	pcall(function()
		AnimData.BipodClose({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.AnimDebounce = true
end

function ReloadAnim()
	pcall(function()
		AnimData.ReloadAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},ModTable.ReloadSpeed,cameraspring)
	end)
end

function UnderBarrelReloadAnim()
	pcall(function()
		AnimData.UnderBarrelReloadAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},1,cameraspring)
	end)
end

function BoltBack()
	pcall(function()
		AnimData.BoltBack({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function BoltForward()
	pcall(function()
		AnimData.BoltForward({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function TacticalReloadAnim()
	pcall(function()
		AnimData.TacticalReloadAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},ModTable.ReloadSpeed,cameraspring)
	end)
end

function ReverseTacticalReloadAnim()
	pcall(function()
		AnimData.ReverseTacticalReloadAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},ModTable.ReloadSpeed,cameraspring)
	end)
end

function JammedAnim()
	pcall(function()
		AnimData.JammedAnim({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function PumpAnim()
	PlayerState.reloading = true
	PlayerState.inPumpAnim = true
	if PlayerState.aimming == true then
		pcall(function()
			AnimData.AimPumpAnim({
				RArmWeld,
				LArmWeld,
				GunWeld,
				WeaponInHand,
				ViewModel,
			},ModTable.BoltSpeed,cameraspring)
		end)
	else
		pcall(function()
			AnimData.PumpAnim({
				RArmWeld,
				LArmWeld,
				GunWeld,
				WeaponInHand,
				ViewModel,
			},ModTable.BoltSpeed,cameraspring)
		end)
	end
	PlayerState.inPumpAnim = false
	PlayerState.reloading = false
end

function MagCheckAnim()
	PlayerState.CheckingMag = true
	pcall(function()
		AnimData.MagCheck({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.CheckingMag = false
end

function EmptyMagCheckAnim()
	PlayerState.CheckingMag = true
	pcall(function()
		AnimData.EmptyMagCheck({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
	PlayerState.CheckingMag = false
end

function meleeAttack()
	pcall(function()
		AnimData.MeleeAttack({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		})
	end)
end

function GrenadeReady()
	PlayerState.GrenadeThrowing = true
	GrenadeModel(PlayerState.ClassData[PlayerState.ClassData.CurrentClass.Value].Grenade.Value)
	pcall(function()
		GreAnimData.GrenadeReady({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},GreWeld, GreModel)
	end)
end


function GrenadeThrow()
	pcall(function()
		GreAnimData.GrenadeThrow({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},GreWeld, GreModel)
	end)
	PlayerState.GrenadeThrowing = false
	IdleAnim()
end

function PackageReady()
	PlayerState.GrenadeThrowing = true
	GrenadeModel("Airdrop")
	pcall(function()
		GreAnimData.GrenadeReady({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},GreWeld, GreModel)
	end)
end

function NVGActivate()
	PlayerState.AnimDebounce = false
	pcall(function()
		require(Engine.Animations:WaitForChild("NVG")).NVGActivate({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},plr.PlayerGui.NVG.armsound)
	end)
	IdleAnim()
end

function NVGUnactive()
	PlayerState.AnimDebounce = false
	pcall(function()
		require(Engine.Animations:WaitForChild("NVG")).NVGUnactive({
			RArmWeld,
			LArmWeld,
			GunWeld,
			WeaponInHand,
			ViewModel,
		},plr.PlayerGui.NVG.armsound)
	end)
	IdleAnim()
end

function BindActions()
	CAS:BindAction("Fire", handleAction, true, Enum.UserInputType.MouseButton1, Enum.KeyCode.ButtonR2)
	CAS:BindAction("ADS", handleAction, true, Enum.UserInputType.MouseButton2, Enum.KeyCode.ButtonL2)
	CAS:BindAction("Reload", handleAction, true, Enum.KeyCode.R, Enum.KeyCode.ButtonX)
	CAS:BindAction("Grenade", handleAction, true, Enum.KeyCode.G, Enum.KeyCode.ButtonR1)
	CAS:BindAction("Grenade Launcher", handleAction, true, Enum.KeyCode.X, Enum.KeyCode.DPadLeft)
	CAS:BindAction("Melee", handleAction, true, Enum.KeyCode.F, Enum.KeyCode.ButtonR3)

	CAS:BindAction("SwapWeapon", handleAction, true, Enum.KeyCode.ButtonY)

	CAS:BindAction("HoldCrouch", handleAction, false, gameRules.HoldCrouch)
	CAS:BindAction("Prone", handleAction, true, Enum.KeyCode.LeftControl)
	CAS:BindAction("ControllerStance", handleAction, false, Enum.KeyCode.ButtonB)

	CAS:BindAction("Run", handleAction, false, gameRules.Sprint, Enum.KeyCode.ButtonL3)
	CAS:BindAction("NVG", handleAction, false, gameRules.ToggleNVG, Enum.KeyCode.DPadUp)
	CAS:BindAction("ToggleWalk", handleAction, false, gameRules.SlowWalk)
	CAS:BindAction("LeanLeft", handleAction, false, gameRules.LeanLeft)
	CAS:BindAction("LeanRight", handleAction, false, gameRules.LeanRight)

	CAS:BindAction("Bipod", handleAction, true, Enum.KeyCode.B, Enum.KeyCode.DPadDown)
	CAS:BindAction("CycleAimpart", handleAction, false, Enum.KeyCode.H)
	CAS:BindAction("CycleFiremode", handleAction, false, gameRules.FireMode, Enum.KeyCode.DPadRight)
	CAS:BindAction("CheckMag", handleAction, false, Enum.KeyCode.M)
end

function BindMountableActions()
	CAS:BindAction("ExitMountable", handleAction, false, Enum.KeyCode.E)
end

function UnBindActions()
	CAS:UnbindAction("NVG")
	CAS:UnbindAction("Melee")

	CAS:UnbindAction("Run")

	CAS:UnbindAction("Crouch")

	CAS:UnbindAction("HoldCrouch")

	CAS:UnbindAction("ToggleWalk")
	CAS:UnbindAction("LeanLeft")
	CAS:UnbindAction("LeanRight")

	CAS:UnbindAction("ControllerStance")

	CAS:UnbindAction("SwapWeapon")

	CAS:UnbindAction("Fire")
	CAS:UnbindAction("ADS")
	CAS:UnbindAction("Reload")
	CAS:UnbindAction("Grenade")
	CAS:UnbindAction("Grenade Launcher")
	CAS:UnbindAction("Prone")

	CAS:UnbindAction("Bipod")

	CAS:UnbindAction("CycleAimpart")
	CAS:UnbindAction("CycleFiremode")
	CAS:UnbindAction("CheckMag")
end
BindActions()

function UpdateDownedBillboards()
	if not PlayerState.PlayerData or not PlayerState.ClassData then return end
	local currentClass = PlayerState.ClassData.CurrentClass.Value

	if currentClass == "Medic" then
		for _, player in pairs(game.Players:GetPlayers()) do
			if player ~= plr and player.Team == plr.Team then
				if player.Character and player.Character:FindFirstChild("Client") then
					if Game_Client:GetAttribute("Knocked") then
						if not downedBillboards[player.UserId] then
							CreateDownedBillboard(player)
						end
					else
						if downedBillboards[player.UserId] then
							downedBillboards[player.UserId]:Destroy()
							downedBillboards[player.UserId] = nil
						end
					end
				end
			end
		end
	else
		for userId, billboard in pairs(downedBillboards) do
			billboard:Destroy()
		end
		downedBillboards = {}
	end
end
function CreateDownedBillboard(player)
	if not player.Character or not player.Character:FindFirstChild("Head") then return end
	local billboard = HUDs:FindFirstChild("DownedUI"):Clone()
	billboard.Parent = player.Character.Head
	billboard.Adornee = player.Character.Head
	billboard.Frame.PlayerName.Text = player.Name

	downedBillboards[player.UserId] = billboard
	task.spawn(function()
		while billboard and billboard.Parent and player.Character and player.Character:FindFirstChild("Head") do
			if char and char:FindFirstChild("Head") then
				local distance = math.floor((player.Character.Head.Position - char.Head.Position).Magnitude+0.5)
				billboard.Frame.Distance.Text = distance.."m"
			end
			task.wait(0.1)
		end
	end)
end
local L_199_ = nil
char.ChildAdded:connect(function(Tool)
	if Tool:IsA("Tool") and not Tool:FindFirstChild("Settings") then
		PreviousTool = nil
		PlayerState.canDrop = false
	end
	if Tool:IsA('Tool') and Humanoid.Health > 0 and not PlayerState.ToolEquip and Tool:FindFirstChild("Settings") ~= nil and (require(Tool.Settings).Type == 'Gun' or require(Tool.Settings).Type == 'Melee' or require(Tool.Settings).Type == 'Grenade' or require(Tool.Settings).Type == 'Laser' or require(Tool.Settings).Type == 'Binoculars' or require(Tool.Settings).Type == 'Stim' or require(Tool.Settings).Type == 'Ammo' or require(Tool.Settings).Type == 'Drone') then
		local L_370_ = true
		if char:WaitForChild("Humanoid").Sit then
			if char.Humanoid.SeatPart:IsA("VehicleSeat") and not gameRules.EquipInVehicleSeat then 
				L_370_ = false
			elseif char.Humanoid.SeatPart:IsA("Seat") and not gameRules.EquipInSeat then
				L_370_ = false
			end
		end
		if L_370_ then
			L_199_ = Tool
			if not PlayerState.ToolEquip then
				setup(Tool)
			elseif PlayerState.ToolEquip then
				pcall(function()
					unset()
					setup(Tool)
				end)
			end;
		end;
	end
end)
plr.Backpack.ChildAdded:Connect(function(Tool)
	if Tool:IsA("Tool") and not Tool:FindFirstChild("Settings") then
		Humanoid:EquipTool(Tool)
	end
end)
char.ChildRemoved:connect(function(Tool)
	if Tool == WeaponTool then
		if PlayerState.ToolEquip then
			unset()
		end
	end
end)
Humanoid.Running:Connect(function(speed)
	charspeed = speed
	if speed > 0.1 then
		PlayerState.running = true
	else
		PlayerState.running = false
	end
end)
Humanoid.Swimming:Connect(function(speed)
	if PlayerState.Swimming then
		charspeed = speed
		if speed > 0.1 then
			PlayerState.running = true
		else
			PlayerState.running = false
		end
	end
end)
Humanoid.Died:Connect(function(speed)
	TS:Create(char.Humanoid, TweenInfo.new(1), {CameraOffset = Vector3.new(0,0,0)} ):Play()
	PlayerState.ChangeStance = false
	Stand()
	Stances = 0
	Virar = 0
	CameraX = 0
	CameraY = 0
	Lean()
	unset()
	Evt.NVG:Fire(false)
end)
Humanoid.Seated:Connect(function(IsSeated, CurrentSeat)
	if IsSeated then
		unset()
		Humanoid:UnequipTools()
		PlayerState.CanLean = false
		plr.CameraMaxZoomDistance = gameRules.VehicleMaxZoom
	else
		plr.CameraMaxZoomDistance = game.StarterPlayer.CameraMaxZoomDistance
	end
	if IsSeated  then
		PlayerState.Sentado = true
		Stances = 0
		Virar = 0
		CameraX = 0
		CameraY = 0
		Stand()
		Lean()
	else
		PlayerState.Sentado = false
		PlayerState.CanLean = true
	end
end)
Humanoid.Changed:connect(function(Property)
	if gameRules.AntiBunnyHop then
		if Property == "Jump" and Humanoid.Sit == true and Humanoid.SeatPart ~= nil then
			Humanoid.Sit = false
			SwaySpring:accelerate(Vector3.new(0, -5, 0));
			recoilcf = recoilcf * CFrame.new(0,.1,0);
		elseif Property == "Jump" and Humanoid.Sit == false then
			if PlayerState.JumpDelay then
				Humanoid.Jump = false
				return false
			end
			PlayerState.JumpDelay = true
			delay(0, function()
				wait(gameRules.JumpCoolDown)
				PlayerState.JumpDelay = false
			end)
			SwaySpring:accelerate(Vector3.new(0, -8, 0));
			recoilcf = recoilcf * CFrame.new(0,.25,0);
		end
	end
end)
Humanoid.StateChanged:connect(function(Old,state)
	if state == Enum.HumanoidStateType.Swimming then
		PlayerState.Swimming = true
		Stances = 0
		Virar = 0
		CameraX = 0
		CameraY = 0
		Stand()
		Lean()
	else
		PlayerState.Swimming = false
	end
	if gameRules.EnableFallDamage then
		if state == Enum.HumanoidStateType.Freefall and not PlayerState.falling then
			PlayerState.falling = true
			local curVel = 0
			local peak = 0

			while PlayerState.falling do
				curVel = HumanoidRootPart.Velocity.magnitude
				peak = peak + 1
				Thread:Wait()
			end
			local damage = (curVel - (gameRules.MaxVelocity)) * gameRules.DamageMult
			if damage > 5 and peak > 20 then
				local SKP_02 = SKP_01.."-"..plr.UserId
				cameraspring:accelerate(Vector3.new(-damage/20, 0, math.random(-damage, damage)/5))
				SwaySpring:accelerate(Vector3.new( math.random(-damage, damage)/5, damage/5,0))

				local hurtSound = Engine:WaitForChild("FX").FallDamage:Clone()
				hurtSound.Parent = plr.PlayerGui
				hurtSound.Volume = damage/Humanoid.MaxHealth
				hurtSound:Play()
				Debris:AddItem(hurtSound,hurtSound.TimeLength)

				Evt.Damage:InvokeServer(nil, nil, nil, nil, nil, nil, true, damage, SKP_02)
			else
				local hurtSound = Engine:WaitForChild("FX").Dive:Clone()
				hurtSound.Parent = plr.PlayerGui
				hurtSound.Volume = damage*3 +0.2
				hurtSound:Play()
			end
			recoilcf = recoilcf * CFrame.new(0,-.1,0);
			SwaySpring:accelerate(Vector3.new(0, 5, 0));
		elseif state == Enum.HumanoidStateType.Landed or state == Enum.HumanoidStateType.Dead then
			PlayerState.falling = false
			local hurtSound = Engine:WaitForChild("FX").Dive:Clone()
			hurtSound.Parent = plr.PlayerGui
			hurtSound.Volume = 0.2
			hurtSound:Play()
			SwaySpring:accelerate(Vector3.new(0, 2.5, 0))
		end
	end

end)

script.Parent:GetAttributeChangedSignal("Injured"):Connect(function()
	local valor = script.Parent:GetAttribute("Injured")

	if valor and PlayerState.runKeyDown then
		PlayerState.runKeyDown 	= false
		Stand()
		if not PlayerState.CheckingMag and not PlayerState.reloading and not PlayerState.inPumpAnim and WeaponData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			IdleAnim()
		end
	end

	if Stances == 0 then
		Stand()
	elseif Stances == 1 then
		Crouch()
	end

end)
BloodScreen:Play()
BloodScreenLowHP:Play()
Humanoid.HealthChanged:Connect(function(Health)
	SE_GUI.Efeitos.Health.ImageTransparency = ((Health - (Humanoid.MaxHealth/2))/(Humanoid.MaxHealth/2))
	SE_GUI.Efeitos.LowHealth.ImageTransparency = (Health /(Humanoid.MaxHealth/2))
	UpdateGui()
	
end)
local SpeedSpring = NewSpring(0)
SpeedSpring.s = 16

local lastCrosshairUpdate = 0
local CROSSHAIR_UPDATE_INTERVAL = 0.05

Evt.TeammateDowned.OnClientEvent:Connect(function(downedPlayer)
	local SE_GUI = plr.PlayerGui:FindFirstChild("StatusUI")
	if SE_GUI then
		print(downedPlayer.Name .. " is down!")
	end
end)

Evt.TeammateRevived.OnClientEvent:Connect(function(revivedPlayer)
	print(revivedPlayer.Name .. " was revived!")
end)

Evt.TeammateDied.OnClientEvent:Connect(function(deadPlayer)
	print(deadPlayer.Name .. " died!")
end)

Evt.PlayerRevived.OnClientEvent:Connect(function()
	if KnockedUI then
		KnockedUI.Enabled = false
	end
	if char and char:FindFirstChild("Humanoid") then
		char.Humanoid.WalkSpeed = gameRules.NormalWalkSpeed
		char.Humanoid.JumpPower = 50
	end
	plr.CameraMode = Enum.CameraMode.LockFirstPerson
	plr.CameraMaxZoomDistance = 128
end)

game:GetService("RunService").Heartbeat:Connect(function()
	if char and Game_Client then
		local isKnocked = Game_Client:GetAttribute("Knocked")

		if isKnocked and not KnockedUI then
			SetupKnockedState()
		elseif not isKnocked and KnockedUI then
			if KnockedUI then
				KnockedUI.Enabled = false
			end
		end
	end
end)

local function suppressSoundEffect(SoundGroup, amount)
	SoundGroup.EqualizerSoundEffect.LowGain = (amount)/((Humanoid.Health/Humanoid.MaxHealth)/2 + 0.5)
	SoundGroup.EqualizerSoundEffect.MidGain = (-amount/5)/((Humanoid.Health/Humanoid.MaxHealth)/2 + 0.5)
	SoundGroup.EqualizerSoundEffect.HighGain = (-amount*1.5)/((Humanoid.Health/Humanoid.MaxHealth)/2 + 0.5)
	SoundGroup.Volume = ((1/(amount+1))*0.3 + 0.2)*((Humanoid.Health/Humanoid.MaxHealth)/2 + 0.5)
end


function UpdateLighting()
	local lightingFolder = RS.Lighting

	if lightingFolder:FindFirstChild("Asphalt") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Asphalt, lightingFolder.Asphalt.Value)
	end
	if lightingFolder:FindFirstChild("Basalt") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Basalt, lightingFolder.Basalt.Value)
	end
	if lightingFolder:FindFirstChild("Brick") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Brick, lightingFolder.Brick.Value)
	end
	if lightingFolder:FindFirstChild("Cobblestone") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Cobblestone, lightingFolder.Cobblestone.Value)
	end
	if lightingFolder:FindFirstChild("Concrete") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Concrete, lightingFolder.Concrete.Value)
	end
	if lightingFolder:FindFirstChild("CrackedLava") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.CrackedLava, lightingFolder.CrackedLava.Value)
	end
	if lightingFolder:FindFirstChild("Glacier") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Glacier, lightingFolder.Glacier.Value)
	end
	if lightingFolder:FindFirstChild("Grass") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Grass, lightingFolder.Grass.Value)
	end
	if lightingFolder:FindFirstChild("Ground") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Ground, lightingFolder.Ground.Value)
	end
	if lightingFolder:FindFirstChild("Ice") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Ice, lightingFolder.Ice.Value)
	end
	if lightingFolder:FindFirstChild("LeafyGrass") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.LeafyGrass, lightingFolder.LeafyGrass.Value)
	end
	if lightingFolder:FindFirstChild("Limestone") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Limestone, lightingFolder.Limestone.Value)
	end
	if lightingFolder:FindFirstChild("Mud") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Mud, lightingFolder.Mud.Value)
	end
	if lightingFolder:FindFirstChild("Pavement") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Pavement, lightingFolder.Pavement.Value)
	end
	if lightingFolder:FindFirstChild("Rock") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Rock, lightingFolder.Rock.Value)
	end
	if lightingFolder:FindFirstChild("Salt") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Salt, lightingFolder.Salt.Value)
	end
	if lightingFolder:FindFirstChild("Sand") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Sand, lightingFolder.Sand.Value)
	end
	if lightingFolder:FindFirstChild("Sandstone") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Sandstone, lightingFolder.Sandstone.Value)
	end
	if lightingFolder:FindFirstChild("Slate") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Slate, lightingFolder.Slate.Value)
	end
	if lightingFolder:FindFirstChild("Snow") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.Snow, lightingFolder.Snow.Value)
	end
	if lightingFolder:FindFirstChild("WoodPlanks") then
		game.Workspace.Terrain:SetMaterialColor(Enum.Material.WoodPlanks, lightingFolder.WoodPlanks.Value)
	end
	
	if lightingFolder:FindFirstChild("ClockTime") then
		TS:Create(game.Lighting, TweenInfo.new(0.1), {ClockTime = lightingFolder.ClockTime.Value}):Play()
	end

	if not PlayerState.NVGActive then
		if lightingFolder:FindFirstChild("Ambient") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {Ambient = lightingFolder.Ambient.Value}):Play()
		end
		if lightingFolder:FindFirstChild("Brightness") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {Brightness = lightingFolder.Brightness.Value}):Play()
		end
		if lightingFolder:FindFirstChild("ColorShift_Bottom") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {ColorShift_Bottom = lightingFolder.ColorShift_Bottom.Value}):Play()
		end
		if lightingFolder:FindFirstChild("ColorShift_Top") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {ColorShift_Top = lightingFolder.ColorShift_Top.Value}):Play()
		end
		if lightingFolder:FindFirstChild("EnvironmentDiffuseScale") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {EnvironmentDiffuseScale = lightingFolder.EnvironmentDiffuseScale.Value}):Play()
		end
		if lightingFolder:FindFirstChild("EnvironmentSpecularScale") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {EnvironmentSpecularScale = lightingFolder.EnvironmentSpecularScale.Value}):Play()
		end
		if lightingFolder:FindFirstChild("OutdoorAmbient") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {OutdoorAmbient = lightingFolder.OutdoorAmbient.Value}):Play()
		end
		if lightingFolder:FindFirstChild("ShadowSoftness") then
			TS:Create(game.Lighting, TweenInfo.new(0.1), {ShadowSoftness = lightingFolder.ShadowSoftness.Value}):Play()
		end
		if lightingFolder:FindFirstChild("ExposureCompensation") then
			TS:Create(game.Lighting, TweenInfo.new(0.1, Enum.EasingStyle.Back), {ExposureCompensation = lightingFolder.ExposureCompensation.Value}):Play()
		end
		local atmosphere = lightingFolder:FindFirstChildOfClass("Atmosphere")
		if atmosphere and game.Lighting:FindFirstChildOfClass("Atmosphere") then
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Density = atmosphere.Density}):Play()
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Offset = atmosphere.Offset}):Play()
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Color = atmosphere.Color}):Play()
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Decay = atmosphere.Decay}):Play()
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Glare = atmosphere.Glare}):Play()
			TS:Create(game.Lighting.Atmosphere, TweenInfo.new(0.1), {Haze = atmosphere.Haze}):Play()
		end
		local bloom = lightingFolder:FindFirstChildOfClass("BloomEffect")
		if bloom and game.Lighting:FindFirstChildOfClass("BloomEffect") then
			TS:Create(game.Lighting.Bloom, TweenInfo.new(0.1), {Size = bloom.Size}):Play()
			TS:Create(game.Lighting.Bloom, TweenInfo.new(0.1), {Threshold = bloom.Threshold}):Play()
			TS:Create(game.Lighting.Bloom, TweenInfo.new(0.1), {Intensity = bloom.Intensity}):Play()
		end
		local clouds = lightingFolder:FindFirstChildOfClass("Clouds")
		if clouds and game.Workspace.Terrain:FindFirstChildOfClass("Clouds") then
			TS:Create(game.Workspace.Terrain.Clouds, TweenInfo.new(0.1), {Cover = clouds.Cover}):Play()
			TS:Create(game.Workspace.Terrain.Clouds, TweenInfo.new(0.1), {Density = clouds.Density}):Play()
			TS:Create(game.Workspace.Terrain.Clouds, TweenInfo.new(0.1), {Color = clouds.Color}):Play()
		end
		local blur = lightingFolder:FindFirstChildOfClass("BlurEffect")
		if blur and game.Lighting:FindFirstChildOfClass("BlurEffect") then
			TS:Create(game.Lighting.Blur, TweenInfo.new(0.1), {Size = blur.Size}):Play()
		end
		local colorCorrection = lightingFolder:FindFirstChildOfClass("ColorCorrectionEffect")
		if colorCorrection and game.Lighting:FindFirstChildOfClass("ColorCorrectionEffect") then
			TS:Create(game.Lighting.ColorCorrection, TweenInfo.new(0.1), {Saturation = colorCorrection.Saturation}):Play()
			TS:Create(game.Lighting.ColorCorrection, TweenInfo.new(0.1), {Contrast = colorCorrection.Contrast}):Play()
			TS:Create(game.Lighting.ColorCorrection, TweenInfo.new(0.1), {Brightness = colorCorrection.Brightness}):Play()
			TS:Create(game.Lighting.ColorCorrection, TweenInfo.new(0.1), {TintColor = colorCorrection.TintColor}):Play()
		end
		local depthOfField = lightingFolder:FindFirstChildOfClass("DepthOfFieldEffect")
		if depthOfField and game.Lighting:FindFirstChildOfClass("DepthOfFieldEffect") then
			TS:Create(game.Lighting.DepthOfField, TweenInfo.new(0.1), {FarIntensity = depthOfField.FarIntensity}):Play()
			TS:Create(game.Lighting.DepthOfField, TweenInfo.new(0.1), {FocusDistance = depthOfField.FocusDistance}):Play()
			TS:Create(game.Lighting.DepthOfField, TweenInfo.new(0.1), {InFocusRadius = depthOfField.InFocusRadius}):Play()
			TS:Create(game.Lighting.DepthOfField, TweenInfo.new(0.1), {NearIntensity = depthOfField.NearIntensity}):Play()
		end
		local sunRays = lightingFolder:FindFirstChildOfClass("SunRaysEffect")
		if sunRays and game.Lighting:FindFirstChildOfClass("SunRaysEffect") then
			TS:Create(game.Lighting.SunRays, TweenInfo.new(0.1), {Spread = sunRays.Spread}):Play()
			TS:Create(game.Lighting.SunRays, TweenInfo.new(0.1), {Intensity = sunRays.Intensity}):Play()
		end
	end
end
local SuppressFov = 0

Run.RenderStepped:Connect(function(step)
	HeadMovement()
	renderGunRecoil()
	renderCam()
	
	ParticlePlatform.Position = char.Head.Position + Vector3.new(0,22,0)

	local Stamina = Game_Client:GetAttribute("Stamina") or 1000;
	local staminaDecrease = 0
	if PlayerState.runKeyDown then
		staminaDecrease = 40 * step
	elseif PlayerState.holdBreath then
		staminaDecrease = 120 * step
	end
	local newStamina = staminaDecrease > 0 and math.max(Stamina - staminaDecrease, 0) or math.min(Stamina + 75 * step, 1000)
	Game_Client:SetAttribute("Stamina", newStamina)
	SE_GUI.GunHUD.Stamina.Fill.Size = UDim2.new(newStamina/1000,0,0.95,0)
	local AimStability = Game_Client:GetAttribute("AimStability") or 1000;
	local newStability = (PlayerState.runKeyDown) and math.max(AimStability - 50 * step, 0) or math.min(AimStability + 100 * step, 1000)
	Game_Client:SetAttribute("AimStability", newStability)
	if PlayerState.aimming and WeaponData and (((WeaponData.Sniper and not AttTable.SightAtt) or (AttTable.SightAtt and SightData.Sniper)) and (not AttTable.OtherAtt or not OtherData.Canted)) then
		local holdBreathTime = PlayerState.holdBreath and .05 or 1
		local StaminaX =  math.clamp(1 - Stamina/1000, .25, 1) * step * holdBreathTime
		cameraOffset = cameraOffset:Lerp(CFrame.Angles(
			math.rad( 3.5 * StaminaX * math.sin( os.clock() * 3.5 )),
			math.rad( 3.5 * StaminaX * math.sin( os.clock() * 1 )),
			0), step * 5)
		cam.CFrame = cam.CFrame * cameraOffset
	end
	if tick() - lastSwapTime > 3.5 then
		swapUIActive = false
		for i,v in pairs(SE_GUI.GunHUD.Selection:GetDescendants()) do
			if v:IsA("TextLabel") then
				TS:Create(v,TweenInfo.new(0.5),{TextTransparency = 1}):Play()
				TS:Create(v,TweenInfo.new(0.5),{TextStrokeTransparency = 1}):Play()
			end
		end
	end
	if tick() - lastLightingUpdate > LIGHTING_UPDATE_INTERVAL then
		lastLightingUpdate = tick()
		UpdateLighting()

		SuppressFov = 0

		if PlayerState.reloading then
			SuppressFov -= 5
		end
		if Game_Client:GetAttribute("SuppressTime") > 0 then
			SuppressFov = Game_Client:GetAttribute("SuppressTime")+1
			if Game_Client:GetAttribute("ExplosiveSuppressTime") > 0 then
				local SuppressEffect = Game_Client:GetAttribute("ExplosiveSuppressTime")

				suppressSoundEffect(game.SoundService.GunFire,SuppressEffect)
				suppressSoundEffect(game.SoundService.GunSounds,SuppressEffect)
				suppressSoundEffect(game.SoundService.Music,SuppressEffect)
				suppressSoundEffect(game.SoundService.Explosions,SuppressEffect)
				suppressSoundEffect(game.SoundService.Footsteps,SuppressEffect)
				suppressSoundEffect(game.SoundService.CharacterSounds,SuppressEffect)
			else
				suppressSoundEffect(game.SoundService.GunFire,0)
				suppressSoundEffect(game.SoundService.GunSounds,0)
				suppressSoundEffect(game.SoundService.Music,0)
				suppressSoundEffect(game.SoundService.Explosions,0)
				suppressSoundEffect(game.SoundService.Footsteps,0)
				suppressSoundEffect(game.SoundService.CharacterSounds,0)
			end
		else
			suppressSoundEffect(game.SoundService.GunFire,0)
			suppressSoundEffect(game.SoundService.GunSounds,0)
			suppressSoundEffect(game.SoundService.Music,0)
			suppressSoundEffect(game.SoundService.Explosions,0)
			suppressSoundEffect(game.SoundService.Footsteps,0)
			suppressSoundEffect(game.SoundService.CharacterSounds,0)
		end
	end



	if ViewModel and LArm and RArm and WeaponInHand then

		if BipodTable.IsBipod and ViewModel and WeaponInHand then
			local currentTime = tick()
			if currentTime - BipodTable.LastSurfaceCheck > BipodTable.SurfaceCheckInterval then
				BipodTable.LastSurfaceCheck = currentTime

				local hasContact, pos, normal = CheckBipodSurface()
				if PlayerState.Proned and hasContact and not BipodTable.BipodActive then
					PlayerState.BipodSurfaceContact = true
					PlayerState.BipodPosition = pos
					PlayerState.BipodNormal = normal
					DeployBipod()
				end
				if BipodTable.BipodActive and not hasContact and not PlayerState.Proned then
					RetractBipod()
				end
				if BipodTable.BipodActive then
					if hasContact then
						PlayerState.BipodSurfaceContact = true
						PlayerState.BipodPosition = pos
						PlayerState.BipodNormal = normal
					elseif not PlayerState.Proned then
						RetractBipod()
					end
				end
			end

			if BipodTable.BipodActive and PlayerState.BipodSurfaceContact and PlayerState.BipodPosition then
				local bipodHinge = WeaponInHand:FindFirstChild("BipodHinge")
				if bipodHinge then
					local targetY = PlayerState.BipodPosition.Y
					local currentY = bipodHinge.Position.Y
					local yOffset = targetY - currentY

					local lockStrength = 0.15
					PositionOffset = PositionOffset:Lerp(
						PositionOffset * CFrame.new(0, yOffset * lockStrength, 0),
						step * 10
					)
				end
			end
		end
		
		task.spawn(function()
			while task.wait(0.5) do
				UpdateDownedBillboards()
			end
		end)

		local RootPart = char:FindFirstChild("HumanoidRootPart")
		local relv = RootPart.CFrame:VectorToObjectSpace(RootPart.AssemblyLinearVelocity)
		local Params = RaycastParams.new()
		Params.FilterDescendantsInstances = {char, workspace.CurrentCamera}
		Params.FilterType = Enum.RaycastFilterType.Exclude
		local Results = workspace:Raycast(RootPart.Position, RootPart.CFrame:VectorToWorldSpace(Vector3.new(0, -4, 0)), Params)
		if Results and Results.Instance then
			SpeedSpring.t = (Vector3.new(1, 0, 1) * relv).Magnitude
		else
			SpeedSpring.t = 0
		end
		CharacterSpeed = SpeedSpring.p
		CharacterDistance = CharacterDistance + step * SpeedSpring.p
		local CurrentTick = tick()
		local Speed, Distance = 0.4 * CharacterSpeed, CharacterDistance* 6.28318 / 7

		local StaminaFactor = math.clamp(1.5 - (Stamina/1000), 0.1, 1.5)

		local Multiplier = 1
		local Bob = FromAxisAngle(
			Speed * math.cos(Distance + 2) / 1800 * StaminaFactor, 
			Speed * math.cos(Distance / 2) / 1800 * StaminaFactor, 
			Speed * math.cos(Distance / 2 + 2) / 3600 * StaminaFactor
		)
		Bob = Bob:Lerp(CFrame.new(), 1 - Multiplier)
		cam.CFrame *= Bob


		if lastGrain >= math.random(0.025,0.05) then
			lastGrain = 0
			plr.PlayerGui.NVG.Grain.Image = 'rbxassetid://'..Grains[math.random(1,#Grains)]
		else
			lastGrain+= step
		end

		local mouseDelta = User:GetMouseDelta()
		SwaySpring:accelerate(Vector3.new(mouseDelta.X/80, mouseDelta.Y/80, mouseDelta.X*1000))

		local swayVec = SwaySpring.p
		local TSWAY = swayVec.z
		local XSSWY = swayVec.X
		local YSSWY = swayVec.Y
		local Sway = CFrame.Angles(YSSWY,XSSWY,XSSWY)

		local newParams = RaycastParams.new()
		newParams.FilterDescendantsInstances = Ignore_Model

		if WeaponInHand.Handle:FindFirstChild("Muzzle") and not PlayerState.reloading and not PlayerState.GrenadeThrowing and not PlayerState.meleeing and PlayerState.AnimDebounce then
			local weaponSize = WeaponInHand.Handle.Muzzle.WorldCFrame:ToObjectSpace(cam.CFrame).Z
			local Hitresult = workspace:Raycast( (WeaponInHand.Handle.Muzzle.WorldCFrame * CFrame.new(0, 0, weaponSize) ).Position, WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector * weaponSize * 2, newParams)


			if Hitresult and GunStance == 0 and not PlayerState.aimming then
				local MovementDist = WeaponInHand.Handle.Muzzle.WorldCFrame:ToObjectSpace(CFrame.new(Hitresult.Position, Hitresult.Position + Hitresult.Normal)).Z + weaponSize - maincf.Z
				if MovementDist > 0.5 and MovementDist < 1.4 then
					WeaponNearZ = WeaponNearZ:Lerp( CFrame.new(0,-MovementDist/5, MovementDist/1.3)*CFrame.Angles(MovementDist/6,0,MovementDist/5), step * 10)
				elseif MovementDist > 1.4 then
					WeaponNearZ = WeaponNearZ:Lerp( CFrame.new(0,-1.4/5, 1.4/1.3)*CFrame.Angles(1.4/6,0,1.4/5), step * 10)
				end
			else
				WeaponNearZ = WeaponNearZ:Lerp(CFrame.new(), step * 10)
			end
		else
			WeaponNearZ = CFrame.new()
		end


		local Handling
		if ArchetypeData then
			Handling = ArchetypeData.Handling or 1
		else
			Handling = 1
		end

		if PlayerState.Crouched then
			PositionOffset = PositionOffset:Lerp( CFrame.new(0, -0.1, 0)*CFrame.Angles(0,0,0.3), step * 12/(Handling*10))

		elseif PlayerState.Proned then
			PositionOffset = PositionOffset:Lerp( CFrame.new(0, 0, -0.05)*CFrame.Angles(0,0,0.1), step * 12/(Handling *10))

		else
			PositionOffset = PositionOffset:Lerp( CFrame.new(), step * 12/(Handling*10))
		end


		virarCFrame = virarCFrame:Lerp(CFrame.Angles(0,0,math.rad(-15 * Virar)), step * 5)
		local FovOffset = ((PlayerState.PlayerData.Settings.FOV.Value/75)-1)/4
		AnimPart.CFrame = cam.CFrame * CFrame.new(FovOffset,-FovOffset,-0.5+FovOffset) * maincf * gunbobcf * aimcf * virarCFrame * WeaponNearZ * PositionOffset

		if not AnimData.GunModelFixed then
			WeaponInHand:SetPrimaryPartCFrame(
				ViewModel.PrimaryPart.CFrame
					* guncf
			)
		end
		local StaminaFactor = math.clamp(2 - (Stamina/1000), 1, 2.0)
		if PlayerState.holdBreath then
			StaminaFactor = math.clamp(0.15 - (Stamina/1000)/10, 0.05, 0.15)
		end

		local WALK_BOB_SCALE = 1.
		local RUN_BOB_SCALE = 1.0

		if PlayerState.running and not PlayerState.Diving and not PlayerState.Sliding then
			if PlayerState.runKeyDown then
				Multiplier = 0.5
				local timeScale = charspeed / 25
				local baseTime = tick() * 12 * timeScale
				local halfTime = tick() * 6 * timeScale

				gunbobcf = gunbobcf:Lerp(CFrame.new(
					0.05 / timeScale * math.sin(baseTime) * StaminaFactor * RUN_BOB_SCALE + xRun/1.5,
					0.02 / timeScale * math.cos(baseTime * 2) * StaminaFactor * RUN_BOB_SCALE,
					0 + zRun/2
					) * CFrame.Angles(
						math.rad(1 / timeScale * math.sin(baseTime) * StaminaFactor * RUN_BOB_SCALE), 
						math.rad(1 / timeScale * math.cos(halfTime) * StaminaFactor * RUN_BOB_SCALE + xRun/1.5), 
						math.rad(xRun*30 + ((charspeed/10) * math.cos(baseTime) * StaminaFactor * RUN_BOB_SCALE)*2)
					), 0.15)
			else
				if PlayerState.aimming then
					Multiplier = 0.1
					local timeScale = charspeed/5
					local baseTime = tick() * 8

					gunbobcf = gunbobcf:Lerp(CFrame.new(
						0.03 * timeScale * math.sin(baseTime) * StaminaFactor * WALK_BOB_SCALE + xRun/1.5,
						0.03 * timeScale * math.cos(baseTime * 2) * StaminaFactor * WALK_BOB_SCALE,
						0 + zRun/2
						) * CFrame.Angles(
							math.rad(1 * timeScale * math.sin(baseTime * 2) * StaminaFactor * WALK_BOB_SCALE), 
							math.rad(1 * timeScale * math.cos(baseTime) * StaminaFactor * WALK_BOB_SCALE + xRun/1.5), 
							math.rad(xRun*50 + (timeScale * math.cos(baseTime) * StaminaFactor * WALK_BOB_SCALE))
						), 0.03)
				else
					Multiplier = 0.2
					local timeScale = charspeed / 10
					local baseTime = tick() * 8

					gunbobcf = gunbobcf:Lerp(CFrame.new(
						0.08 * timeScale * math.sin(baseTime) * StaminaFactor * WALK_BOB_SCALE + xRun/1.5,
						0.08 * timeScale * math.cos(baseTime * 2) * StaminaFactor * WALK_BOB_SCALE,
						0 + zRun/2
						) * CFrame.Angles(
							math.rad(3 * timeScale * math.sin(baseTime * 2) * StaminaFactor * WALK_BOB_SCALE), 
							math.rad(3 * timeScale * math.cos(baseTime) * StaminaFactor * WALK_BOB_SCALE + xRun/1.5), 
							math.rad(xRun*70 + (timeScale * math.cos(baseTime) * StaminaFactor * WALK_BOB_SCALE)*3)
						), 0.03)
				end
			end
		else
			gunbobcf = gunbobcf:Lerp(CFrame.new(
				0.025 * math.sin(tick() * 2) * StaminaFactor,
				0.015 * math.cos(tick() * 4) * StaminaFactor,
				0 
				), 0.1)
		end
		local AimTiming = 0
		local RecoilTiming = 0
		if ArchetypeData then
			AimTiming += step / (ArchetypeData.adsTime*ModTable.AimSpeed * 0.1)
			RecoilTiming += step / (ModTable.Handling * ArchetypeData.Handling * 0.1)
		else
			AimTiming += step / (0.02)
			RecoilTiming += step / (0.1)
		end
		if CurAimpart and PlayerState.aimming and PlayerState.AnimDebounce and not PlayerState.CheckingMag then
			if WeaponInHand.AimPart:FindFirstChild("NVAim") == nil then
				if AimPartMode == 1 then
					TS:Create(cam,AimTween,{FieldOfView = ModTable.ZoomValue*(PlayerState.PlayerData.Settings.FOV.Value/75)-SuppressFov/2}):Play()
					maincf = maincf:Lerp(maincf * CFrame.new(0,0,-.5) * recoilcf * Sway:inverse() * CurAimpart.CFrame:toObjectSpace(cam.CFrame), AimTiming)
				else
					TS:Create(cam,AimTween,{FieldOfView = ModTable.Zoom2Value*(PlayerState.PlayerData.Settings.FOV.Value/75)-SuppressFov/2}):Play()
					maincf = maincf:Lerp(maincf * CFrame.new(0,0,-.5) * recoilcf * Sway:inverse() * CurAimpart.CFrame:toObjectSpace(cam.CFrame), AimTiming)
				end
			else
				if PlayerState.NVGActive then
					TS:Create(cam,AimTween,{FieldOfView = PlayerState.PlayerData.Settings.FOV.Value/1.4 - SuppressFov/2}):Play()
					maincf = maincf:Lerp(maincf * CFrame.new(0,0,-.5) * recoilcf * Sway:inverse() * (WeaponInHand.AimPart.CFrame * WeaponInHand.AimPart.NVAim.CFrame):toObjectSpace(cam.CFrame), AimTiming)
				else
					if AimPartMode == 1 then
						TS:Create(cam,AimTween,{FieldOfView = ModTable.ZoomValue*(PlayerState.PlayerData.Settings.FOV.Value/75)-SuppressFov/2}):Play()
						maincf = maincf:Lerp(maincf * CFrame.new(0,0,-.5) * recoilcf * Sway:inverse() * CurAimpart.CFrame:toObjectSpace(cam.CFrame), AimTiming)
					else
						TS:Create(cam,AimTween,{FieldOfView = ModTable.Zoom2Value*(PlayerState.PlayerData.Settings.FOV.Value/75)-SuppressFov/2}):Play()
						maincf = maincf:Lerp(maincf * CFrame.new(0,0,-.5) * recoilcf * Sway:inverse() * CurAimpart.CFrame:toObjectSpace(cam.CFrame), AimTiming)
					end
				end
			end
		else
			if PlayerState.NVGActive then
				TS:Create(cam,AimTween,{FieldOfView = PlayerState.PlayerData.Settings.FOV.Value/1.2-SuppressFov}):Play()
				maincf = maincf:Lerp(AnimData.MainCFrame * recoilcf * Sway:inverse(), AimTiming) 
			else
				TS:Create(cam,AimTween,{FieldOfView = PlayerState.PlayerData.Settings.FOV.Value-SuppressFov}):Play()
				maincf = maincf:Lerp(AnimData.MainCFrame * recoilcf * Sway:inverse(), AimTiming) 
			end  
		end
		for index, Part in pairs(WeaponInHand:GetDescendants()) do
			if Part:IsA("BasePart") and Part.Name == "SightMark" then
				local dist_scale = Part.CFrame:pointToObjectSpace(cam.CFrame.Position)/Part.Size
				local reticle = Part.SurfaceGui.Border.Scope	
				reticle.Position=UDim2.new(SightMarkPos.Sight1X+dist_scale.x,0,SightMarkPos.Sight1Y-dist_scale.y,0)	
			elseif Part:IsA("BasePart") and Part.Name == "SightMark2" then
				local dist_scale = Part.CFrame:pointToObjectSpace(cam.CFrame.Position)/Part.Size
				local reticle = Part.SurfaceGui.Border.Scope	
				reticle.Position=UDim2.new(SightMarkPos.Sight2X+dist_scale.x,0,SightMarkPos.Sight2Y-dist_scale.y,0)	
			end
		end

		recoilcf = recoilcf:Lerp(CFrame.new() * CFrame.Angles( math.rad(RecoilSpring.p.X), math.rad(RecoilSpring.p.Y), math.rad(RecoilSpring.p.z)), RecoilTiming)
		
		local CrosshairString = PlayerState.PlayerData.Settings[WeaponData.WeaponType.."_Crosshair"].Value
		if tick() - lastCrosshairUpdate > CROSSHAIR_UPDATE_INTERVAL then
			if CrosshairString == "Cross" then
				local Normalized = (((BSpread/0.75) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10

				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(0.5, 0, 0.5 - Normalized,0),0.25)
				CrosshairPos.down = CrosshairPos.down:Lerp(UDim2.new(.5, 0, 0.5 + Normalized,0),0.25)
				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5 - Normalized, 0, 0.5, 0),0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5 + Normalized, 0, 0.5, 0),0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector

				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and WeaponData.WeaponType ~= "Grenade Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and WeaponData.WeaponType ~= "Grenade Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end

				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				Crosshair[CrosshairString].Up.Position = CrosshairPos.up
				Crosshair[CrosshairString].Down.Position = CrosshairPos.down
				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
			elseif CrosshairString == "Cross (No Top)" then
					local Normalized = (((BSpread/0.75) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10

					CrosshairPos.down = CrosshairPos.down:Lerp(UDim2.new(.5, 0, 0.5 + Normalized,0),0.25)
					CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5 - Normalized, 0, 0.5, 0),0.25)
					CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5 + Normalized, 0, 0.5, 0),0.25)

					local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
					local cameraDirection = cam.CFrame.LookVector
					local cameraRight = cam.CFrame.RightVector
					local cameraUp = cam.CFrame.UpVector

					local horizontalOffset
					local verticalOffset

					if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and WeaponData.WeaponType ~= "Grenade Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
						horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
						verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
					elseif WeaponData.WeaponType == "Rocket Launcher" and WeaponData.WeaponType ~= "Grenade Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
						horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
						verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
					elseif PlayerState.GrenadeThrowing then
						horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
						verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
					else
						horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
						verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
					end
					
					TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				Crosshair[CrosshairString].Down.Position = CrosshairPos.down
				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
			elseif CrosshairString == "Circle" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/(10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10
				end

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector

				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end
				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				local NewSizeValue = Normalized +0.008

				local NewSize = UDim2.new(NewSizeValue, 0, NewSizeValue, 0)

				TS:Create(Crosshair[CrosshairString].Border, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
			elseif CrosshairString == "Double Semicircle" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/(10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10
				end
				
				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5 - Normalized/1.5, 0, 0.5, 0),0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5 + Normalized/1.5, 0, 0.5, 0),0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector

				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end
				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				local NewSizeValue = Normalized/2 +0.008

				local NewSize = UDim2.new(NewSizeValue, 0, NewSizeValue, 0)

				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
				TS:Create(Crosshair[CrosshairString].Left, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Right, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
			elseif CrosshairString == "Square (Rounded)" or CrosshairString == "Square (Rounded and Shifted)" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/(10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10
				end

				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5 - Normalized/1.5, 0, 0.5, 0),0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5 + Normalized/1.5, 0, 0.5, 0),0.25)
				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(0.5, 0, 0.5 - Normalized/1.5,0),0.25)
				CrosshairPos.down = CrosshairPos.down:Lerp(UDim2.new(.5, 0, 0.5 + Normalized/1.5,0),0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector

				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end
				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				local NewSizeValue = Normalized/1.5 +0.008

				local NewSize = UDim2.new(NewSizeValue, 0, NewSizeValue, 0)

				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
				Crosshair[CrosshairString].Up.Position = CrosshairPos.up
				Crosshair[CrosshairString].Down.Position = CrosshairPos.down
				TS:Create(Crosshair[CrosshairString].Left, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Right, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Up, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Down, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
			elseif CrosshairString == "Square (Rounded with Border)" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/(10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult) ) / 50)/10
				end

				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5 - Normalized/5, 0, 0.5, 0),0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5 + Normalized/5, 0, 0.5, 0),0.25)
				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(0.5, 0, 0.5 - Normalized/5,0),0.25)
				CrosshairPos.down = CrosshairPos.down:Lerp(UDim2.new(.5, 0, 0.5 + Normalized/5,0),0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector

				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end

				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				local NewSizeValue1 = Normalized/1.5 + 0.001
				local NewSizeValue2 = Normalized + 0.015
				local NewSize1 = UDim2.new(NewSizeValue1, 0, NewSizeValue1, 0)
				local NewSize2 = UDim2.new(NewSizeValue2, 0, NewSizeValue2, 0)
				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
				Crosshair[CrosshairString].Up.Position = CrosshairPos.up
				Crosshair[CrosshairString].Down.Position = CrosshairPos.down
				TS:Create(Crosshair[CrosshairString].Left, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize1}):Play()
				TS:Create(Crosshair[CrosshairString].Right, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize1}):Play()
				TS:Create(Crosshair[CrosshairString].Up, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize1}):Play()
				TS:Create(Crosshair[CrosshairString].Down, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize1}):Play()
				TS:Create(Crosshair[CrosshairString].Border, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize2}):Play()
			elseif CrosshairString == "Triangle (Rounded)" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult)) / 50) / (10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult)) / 50) / 10
				end

				local sin60 = math.sin(math.rad(60))
				local cos60 = math.cos(math.rad(60))

				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(0.5, 0, 0.5 - Normalized, 0), 0.25)
				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(0.5 - Normalized * sin60, 0, 0.5 + Normalized * cos60, 0), 0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(0.5 + Normalized * sin60, 0, 0.5 + Normalized * cos60, 0), 0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector
				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end

				TS:Create(Crosshair, TweenInfo.new(0.04, Enum.EasingStyle.Sine), {Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				local NewSizeValue = Normalized/2 + 0.008
				local NewSize = UDim2.new(NewSizeValue, 0, NewSizeValue, 0)

				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
				Crosshair[CrosshairString].Up.Position = CrosshairPos.up

				TS:Create(Crosshair[CrosshairString].Left, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Right, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
				TS:Create(Crosshair[CrosshairString].Up, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = NewSize}):Play()
			elseif CrosshairString == "Triangle" then
				local Normalized
				if PlayerState.aimming then
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult)) / 50) / (10 * ArchetypeData.AimSpreadReduction)
				else
					Normalized = (((BSpread) + (charspeed/2 * ArchetypeData.WalkMult)) / 50) / 10
				end

				local sin60 = math.sin(math.rad(60))
				local cos60 = math.cos(math.rad(60))
				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(0.5, 0, 0.5 - Normalized, 0), 0.25)
				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(0.5 - Normalized * sin60, 0, 0.5 + Normalized * cos60, 0), 0.25)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(0.5 + Normalized * sin60, 0, 0.5 + Normalized * cos60, 0), 0.25)

				local muzzleDirection = WeaponInHand.Handle.Muzzle.WorldCFrame.LookVector
				local cameraDirection = cam.CFrame.LookVector
				local cameraRight = cam.CFrame.RightVector
				local cameraUp = cam.CFrame.UpVector
				local horizontalOffset
				local verticalOffset

				if PlayerState.AnimDebounce and not PlayerState.reloading and WeaponData.WeaponType ~= "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then 
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.4
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.4
				elseif WeaponData.WeaponType == "Rocket Launcher" and not PlayerState.IsUnderLauncher and not PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.02
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.02
				elseif PlayerState.GrenadeThrowing then
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.004
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.004
				else
					horizontalOffset = muzzleDirection:Dot(cameraRight) * 0.1
					verticalOffset = muzzleDirection:Dot(cameraUp) * 0.1
				end
				TS:Create(Crosshair, TweenInfo.new(0.04, Enum.EasingStyle.Sine), {Position = UDim2.new(0.5 + horizontalOffset, 0, 0.5 - verticalOffset, 0)}):Play()

				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
				Crosshair[CrosshairString].Up.Position = CrosshairPos.up
			else
				CrosshairPos.up = CrosshairPos.up:Lerp(UDim2.new(.5,0,.5,0),AimTiming)
				CrosshairPos.down = CrosshairPos.down:Lerp(UDim2.new(.5,0,.5,0),AimTiming)
				CrosshairPos.left = CrosshairPos.left:Lerp(UDim2.new(.5,0,.5,0),AimTiming)
				CrosshairPos.right = CrosshairPos.right:Lerp(UDim2.new(.5,0,.5,0),AimTiming)

				TS:Create(Crosshair,TweenInfo.new(0.04,Enum.EasingStyle.Sine),{Position = UDim2.new(0.5, 0, 0.5, 0)}):Play()

				Crosshair[CrosshairString].Up.Position = CrosshairPos.up
				Crosshair[CrosshairString].Down.Position = CrosshairPos.down
				Crosshair[CrosshairString].Left.Position = CrosshairPos.left
				Crosshair[CrosshairString].Right.Position = CrosshairPos.right
			end
	
			lastCrosshairUpdate = tick()
		end


		if BSpread then
			local currTime = time()
			if currTime - LastSpreadUpdate > (5/WeaponData.ShootRate) * 2 and BSpread > ArchetypeData.MinSpread * ModTable.MinSpread then
				BSpread = math.max((ArchetypeData.MinSpread * ModTable.MinSpread), BSpread - ArchetypeData.AimInaccuracyDecrease * ModTable.AimInaccuracyDecrease)
			end
			if currTime - LastSpreadUpdate > (60/WeaponData.ShootRate) * 1.5 and not PlayerState.shooting and RecoilPower > ArchetypeData.MinRecoilPower * ModTable.MinRecoilPower then
				RecoilPower =  math.max(ArchetypeData.MinRecoilPower * ModTable.MinRecoilPower, RecoilPower - ArchetypeData.RecoilPowerStepAmount * ModTable.RecoilPowerStepAmount)
			end
		end

		if PlayerState.LaserActive and Pointer ~= nil then

			if not gameRules.RealisticLaser then
				Pointer.Beam.Enabled = true
			else
				Pointer.Beam.Enabled = false
			end
			if PlayerState.IRmode then
				Pointer.Transparency = 1
			else
				Pointer.Transparency = 0
			end

			for index, Key in pairs(WeaponInHand:GetDescendants()) do
				if Key:IsA("BasePart") and Key.Name == "LaserPoint" then
					local rayRes = workspace:Raycast(Key.CFrame.Position, Key.CFrame.LookVector * 1000,raycastParams)
					local Hit
					local Pos
					local Normal
					if rayRes then
						Hit = rayRes.Instance
						Pos = rayRes.Position
						Normal = rayRes.Normal
					end
					if Hit then
						Pointer.CFrame =  CFrame.new(Pos, Pos + Normal)
					else
						Pointer.CFrame =  CFrame.new(cam.CFrame.Position + Key.CFrame.LookVector * 2000, Key.CFrame.LookVector)
					end

					if HalfStep and gameRules.ReplicatedLaser then
						Evt.SVLaser:FireServer(Pos,1,Pointer.Color,PlayerState.IRmode,WeaponTool)
					end
					break
				end
			end
		end
		if WeaponData.Type == "Laser" then
			if Pointer ~= nil then

				Pointer.Beam.Enabled = true
				Pointer.Transparency = 0

				for index, Key in pairs(WeaponInHand:GetDescendants()) do
					if Key:IsA("BasePart") and Key.Name == "LaserPoint" then
						local rayRes = workspace:Raycast(Key.CFrame.Position, Key.CFrame.LookVector * 1000,raycastParams)
						local Hit
						local Pos
						local Normal
						if rayRes then
							Hit = rayRes.Instance
							Pos = rayRes.Position
							Normal = rayRes.Normal
						end
						if Hit then
							Pointer.CFrame =  CFrame.new(Pos, Pos + Normal)
						else
							Pointer.CFrame =  CFrame.new(cam.CFrame.Position + Key.CFrame.LookVector * 2000, Key.CFrame.LookVector)
						end

						if HalfStep and gameRules.ReplicatedLaser then
							Evt.SVLaser:FireServer(Pos,1,Pointer.Color,PlayerState.IRmode,WeaponTool)
						end
						break
					end
				end
			end
		end
	end

	if WeaponData then
		if mouse.Target then
			if mouse.Target.Parent:FindFirstChild("Humanoid") then
				if mouse.Target.Parent.Name ~= plr.Name then
					if game.Players:FindFirstChild(mouse.Target.Parent.Name) then
						local PlayerTarget = game.Players:FindFirstChild(mouse.Target.Parent.Name)
						if PlayerTarget.TeamColor == plr.TeamColor then
							UpdateCrossHair("Green")
						elseif PlayerTarget.TeamColor ~= plr.TeamColor then
							UpdateCrossHair("Red")
						end
					else
						if mouse.Target.Parent:FindFirstChild("EnemyData") then
							if mouse.Target.Parent.EnemyData.Team.Value == plr.Team.Name then
								UpdateCrossHair("Green")
							elseif mouse.Target.Parent.EnemyData.Team.Value ~= plr.Team.Name then
								UpdateCrossHair("Red")
							end
						end
					end
				end
			else
				UpdateCrossHair("White")
			end
		else
			UpdateCrossHair("White")
		end
	end


	if Stamina <= 0 and PlayerState.holdBreath then
		PlayerState.holdBreath = false
	end

	local moveVector = Humanoid.MoveDirection
	local hrp = char:FindFirstChild("HumanoidRootPart")

	local forwardInput = 0
	local rightInput = 0

	if hrp and moveVector.Magnitude > 0 then
		local lookVector = hrp.CFrame.LookVector
		local rightVector = hrp.CFrame.RightVector
		forwardInput = moveVector:Dot(lookVector)
		rightInput = moveVector:Dot(rightVector)
	end

	if ((not PlayerState.running or forwardInput<=0)or Stamina<=0) and PlayerState.runKeyDown then
		PlayerState.runKeyDown = false
		Stand()
		if WeaponData and not PlayerState.aimming then
			UpdateCrossHair("DeScope")
		end
		if not PlayerState.CheckingMag and not PlayerState.reloading and WeaponData and WeaponData.Type ~= "Grenade" and (GunStance == 0 or GunStance == 2 or GunStance == 3) then
			GunStance = 0
			Evt.GunStance:FireServer(GunStance,AnimData)
			IdleAnim()
		end
	end
	if math.abs(forwardInput) < 0.1 then
		zRun = 0
	elseif forwardInput < -0.1 then
		if PlayerState.runKeyDown then
			zRun = 0.1
		else
			if PlayerState.aimming then
				zRun = -0.15
			else
				zRun = -0.1
			end
		end
	elseif forwardInput > 0.1 then
		if PlayerState.runKeyDown then
			zRun = 0.3
		else
			if PlayerState.aimming then
				zRun = 0.2
			else
				zRun = 0.25
			end
		end
	end

	if math.abs(rightInput) < 0.1 then
		xRun = 0
	elseif rightInput < -0.1 then
		if PlayerState.runKeyDown then
			xRun = 0.15
		else
			if PlayerState.aimming then
				xRun = 0.05
			else
				xRun = 0.1
			end
		end
	elseif rightInput > 0.1 then
		if PlayerState.runKeyDown then
			xRun = -0.15
		else
			if PlayerState.aimming then
				xRun = -0.05
			else
				xRun = -0.1
			end
		end
	end


	local TeamColor = plr.TeamColor


	if Ammo == 0 and not PlayerState.reloading and StoredAmmo > 0 and WeaponData then

		PlayerState.reloading = true
		Reload()

	end

	if PlayerState.IsUnderLauncher and UnderBarrelAmmo == 0 and not PlayerState.reloading and StoredUnderBarrelAmmo > 0 and WeaponData then

		PlayerState.reloading = true
		Reload()

	end

	if Game_Client:GetAttribute("Surrender") then
		char.Humanoid.WalkSpeed = 0
	elseif script.Parent:GetAttribute("Injured") then
		SetWalkSpeed(gameRules.InjuredCrouchWalkSpeed)
	elseif PlayerState.runKeyDown then
		SetWalkSpeed(gameRules.RunWalkSpeed)
		PlayerState.Crouched = false
		PlayerState.Proned = false
	elseif PlayerState.Crouched then
		SetWalkSpeed(gameRules.CrouchWalkSpeed)
	elseif PlayerState.Proned then
		SetWalkSpeed(gameRules.ProneWalksSpeed)
	elseif PlayerState.Steady then
		SetWalkSpeed(gameRules.SlowPaceWalkSpeed)
	else
		SetWalkSpeed(gameRules.NormalWalkSpeed)
	end
end)
for i,v in pairs(char:GetChildren()) do
	if v:IsA("BasePart") then
		v.Touched:Connect(function(TouchedObject)
			if TouchedObject and TouchedObject.Parent and TouchedObject.Parent.Name and TouchedObject.Parent.Name == "Doors" or TouchedObject.Parent.Parent.Name == "Doors" and PlayerState.runKeyDown then
				local Door
				if TouchedObject.Parent.Name == "Doors" then
					Door = TouchedObject
				elseif TouchedObject.Parent.Parent.Name == "Doors" then
					Door = TouchedObject.Parent
				end
				if Door:FindFirstChild("Knob") then
					Evt.DoorEvent:FireServer(Door, 5, nil)
				end 
			end
		end)
	end
end
Evt.Refil.OnClientEvent:Connect(function(Tool, Infinite, Stored)
	
	local data = require(Tool:WaitForChild("Settings"))
	local NewStored = math.min(3*data.Ammo, Stored.Value * data.Ammo) 
	print(NewStored)
	StoredAmmo = StoredAmmo + NewStored
	data.StoredAmmo = StoredAmmo

	UpdateGui()

	if not Infinite then
		Evt.Refil:FireServer(Stored, NewStored/data.Ammo)
	end

end)

plr.CharacterRemoving:Connect(function()
	for userId, billboard in pairs(downedBillboards) do
		billboard:Destroy()
	end
	downedBillboards = {}
end)

Evt.Quake.OnClientEvent:Connect(function(Pos,Power)
	ShakeCam(Pos,Power)
end)
